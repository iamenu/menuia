<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestión de Negocio</title>
    <link rel="manifest" href="manifest-admin.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SOCKET.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- QR CODE LIBRARY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- MOMENT JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/es.min.js"></script>
    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .fade-enter {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .nav-item.active {
            background-color: #eff6ff;
            color: #2563eb;
            border-right: 3px solid #2563eb;
        }

        .input-field {
            @apply w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition;
        }

        /* Filtros Monitor */
        .filter-btn {
            transition: all 0.2s;
        }

        .filter-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* Gráfico CSS Simple */
        .bar-container {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 100px;
        }

        .bar {
            background-color: #3b82f6;
            border-radius: 4px 4px 0 0;
            flex: 1;
            transition: height 0.5s ease;
            min-height: 4px;
            position: relative;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            white-space: nowrap;
            margin-bottom: 4px;
        }

        .bar:hover .bar-tooltip {
            opacity: 1;
        }

        /* AI Effects */
        .ai-gradient-text {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-loading {
            animation: aiPulse 1.5s infinite;
        }

        @keyframes aiPulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
            }
        }
    </style>
</head>

<body class="text-gray-800 min-h-screen flex flex-col bg-gray-100">
    <!-- ADMIN APP INSTALL BUTTON (Always Visible) -->
    <button id="pwa-install-btn-admin" onclick="installAdminPWA()"
        class="fixed top-4 right-4 z-[9999] bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl font-bold text-sm animate-bounce hover:bg-slate-900 transition border border-slate-600"
        style="position: fixed; top: 20px; right: 20px; z-index: 99999;">
        <i class="fa-solid fa-download"></i> Instalar Panel
    </button>

    <!-- LOGIN / REGISTER SCREEN -->
    <div id="auth-container" class="fixed inset-0 z-50 bg-gray-50 flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-4xl h-auto md:h-[600px] rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row fade-enter">
            <!-- Left Side: Image/Brand -->
            <div
                class="hidden md:flex md:w-1/2 bg-gradient-to-br from-blue-600 to-indigo-700 p-8 flex-col justify-center items-center text-white text-center relative overflow-hidden">
                <div
                    class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/food.png')]">
                </div>
                <div class="relative z-10">
                    <div
                        class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-4xl mb-6 mx-auto shadow-lg">
                        🚀</div>
                    <h1 class="text-3xl font-bold mb-2">Tu Negocio Digital</h1>
                    <p class="text-blue-100">Gestiona tu menú, recibe pedidos y crece sin límites.</p>
                </div>
            </div>

            <!-- Right Side: Forms -->
            <div class="md:w-1/2 p-8 md:p-12 relative bg-white flex flex-col">
                <div class="flex border-b mb-8">
                    <button onclick="switchTab('login')" id="tab-login"
                        class="flex-1 pb-3 text-center font-semibold text-blue-600 border-b-2 border-blue-600 transition">Ingresar</button>
                    <button onclick="switchTab('register')" id="tab-register"
                        class="flex-1 pb-3 text-center font-semibold text-gray-400 hover:text-gray-600 transition">Registrarse</button>
                </div>

                <form id="form-login" class="space-y-5 flex-1 flex flex-col justify-center"
                    onsubmit="event.preventDefault(); handleLogin();">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link de tu Tienda</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-link"></i></span>
                            <input type="text" id="login-slug" placeholder="Ej: miburger"
                                class="w-full pl-9 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contraseña</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-lock"></i></span>
                            <input type="password" id="login-pass"
                                class="w-full pl-9 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                required>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 transition transform hover:-translate-y-0.5">
                        Iniciar Sesión
                    </button>
                </form>

                <form id="form-register" class="space-y-4 hidden overflow-y-auto h-full pr-2"
                    onsubmit="event.preventDefault(); handleRegister();">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="reg-slug" placeholder="Link único (ej: tacospepe)"
                            class="col-span-2 w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                            required pattern="[a-zA-Z0-9-_]+">
                        <input type="text" id="reg-name" placeholder="Nombre Negocio"
                            class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                        <select id="reg-type"
                            class="w-full p-2.5 border border-gray-300 rounded-lg outline-none bg-white">
                            <option value="Comida General">Giro General</option>
                            <option value="Sushi">Sushi</option>
                            <option value="Tacos">Tacos</option>
                            <option value="Pizza">Pizza</option>
                            <option value="Hamburguesas">Burgers</option>
                        </select>
                        <input type="password" id="reg-pass" placeholder="Contraseña"
                            class="col-span-2 w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                    </div>
                    <div class="space-y-3 pt-2">
                        <p class="text-xs font-bold text-gray-400 uppercase">Datos de Contacto</p>
                        <input type="text" id="reg-owner" placeholder="Tu Nombre"
                            class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                        <input type="tel" id="reg-phone" placeholder="Teléfono"
                            class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                        <input type="tel" id="reg-whatsapp" placeholder="WhatsApp (Obligatorio)"
                            class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                        <input type="text" id="reg-address" placeholder="Dirección del Negocio"
                            class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                    </div>
                    <button type="submit"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-500/30 mt-2">
                        Crear Cuenta Gratis
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="dashboard-container" class="hidden flex min-h-screen bg-gray-100">

        <!-- SIDEBAR -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-20 overflow-y-auto">
            <div class="h-16 flex items-center px-6 border-b border-gray-100">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold mr-3">M
                </div>
                <span class="font-bold text-lg tracking-tight">Menú<span class="ai-gradient-text">IA</span></span>
            </div>

            <nav class="flex-1 py-6 px-3 space-y-1">
                <button onclick="switchView('dashboard')"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition active">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> Resumen
                </button>
                <button onclick="switchView('finances')"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-chart-line w-5 text-center"></i> Finanzas
                </button>
                <button onclick="switchView('orders')"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-clipboard-list w-5 text-center"></i> Monitor Pedidos
                </button>
                <button onclick="switchView('promotions')"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-tags w-5 text-center"></i> Promociones
                </button>
                <button onclick="switchView('menu')"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-utensils w-5 text-center"></i> Mi Menú
                </button>
                <button onclick="switchView('qr')"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-qrcode w-5 text-center"></i> Marketing & QR
                </button>
                <button onclick="switchView('settings')"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-gear w-5 text-center"></i> Configuración
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <a href="#" id="sidebar-link-store" target="_blank"
                    class="flex items-center gap-3 px-4 py-3 bg-blue-50 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-100 transition mb-2">
                    <i class="fa-solid fa-external-link-alt"></i> Ver mi Tienda
                </a>

                <button onclick="logout()"
                    class="w-full flex items-center gap-3 px-4 py-2 text-sm font-medium text-red-500 hover:bg-red-50 rounded-lg transition">
                    <i class="fa-solid fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col relative w-full">
            <!-- Mobile Header -->
            <header
                class="bg-white h-16 border-b border-gray-200 flex md:hidden justify-between items-center px-4 z-20">
                <div class="font-bold text-lg">Panel Admin <span class="ai-gradient-text text-xs">AI</span></div>
                <button
                    onclick="const s=document.querySelector('aside'); s.classList.toggle('hidden'); s.classList.toggle('fixed'); s.classList.toggle('inset-0'); s.classList.toggle('z-50');"
                    class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 p-4 md:p-8 relative bg-gray-100">

                <!-- VIEW: DASHBOARD (RESUMEN & FINANZAS) -->
                <div id="view-dashboard" class="view-section fade-enter">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Hola, <span id="dash-owner-name">Dueño</span>
                                👋</h2>
                            <p class="text-gray-500 text-sm">Resumen de actividad y finanzas.</p>
                        </div>

                    </div>

                    <!-- AI INSIGHTS CARD (REAL) -->
                    <div
                        class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 rounded-xl p-6 text-white mb-8 shadow-xl relative overflow-hidden group border border-purple-500/30">
                        <div
                            class="absolute top-0 right-0 p-4 opacity-10 text-9xl transform group-hover:scale-110 transition duration-700">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div class="relative z-10">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-brain text-pink-400"></i> MenúIA Coach (Beta)
                            </h3>
                            <div class="flex items-start gap-4">
                                <div class="flex-1">
                                    <p class="text-indigo-100 text-sm mb-4 leading-relaxed italic" id="ai-insight-text">
                                        "Analizando tus patrones de venta reales... Pulsa el botón para obtener una
                                        estrategia personalizada de IA."
                                    </p>
                                </div>
                            </div>
                            <button onclick="refreshAIInsight()"
                                class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 border border-white/20 backdrop-blur-sm">
                                <i class="fa-solid fa-wand-magic-sparkles text-yellow-300"></i> Consultar a la IA
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl">
                                    <i class="fa-solid fa-eye"></i>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs font-bold uppercase">Visitas Hoy</p>
                                    <h3 class="text-2xl font-bold text-gray-800" id="stat-visits-count">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl">
                                    <i class="fa-brands fa-whatsapp"></i>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs font-bold uppercase">Pedidos Hoy</p>
                                    <h3 class="text-2xl font-bold text-gray-800" id="stat-orders-count">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl">
                                    <i class="fa-solid fa-money-bill-wave"></i>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs font-bold uppercase">Ventas Hoy</p>
                                    <h3 class="text-2xl font-bold text-emerald-600" id="stat-sales-today">$0.00</h3>
                                </div>
                            </div>
                        </div>

                        <!-- Ventas Mes (Restored) -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xl">
                                    <i class="fa-solid fa-calendar-check"></i>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs font-bold uppercase">Ventas Mes</p>
                                    <h3 class="text-2xl font-bold text-indigo-600" id="stat-sales-month">$0.00</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Finance Chart Area (Moved Inside Dashboard) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
                        <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase tracking-wide border-b pb-2">📊
                            Rendimiento Semanal (Ventas)</h3>
                        <div class="bar-container w-full" id="finance-chart">
                            <div class="w-full text-center text-gray-400 text-xs pt-10">Calculando datos financieros...
                            </div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs text-gray-400 font-medium px-1"
                            id="finance-labels">
                            <!-- Labels -->
                        </div>
                    </div>
                </div> <!-- End Dashboard View -->


                <!-- VIEW: FINANZAS (NEW) -->
                <div id="view-finances" class="view-section hidden fade-enter space-y-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Finanzas Semanales</h2>
                            <p class="text-gray-500 text-sm">Resumen de ganancias y saldos (Lun-Dom)</p>
                        </div>
                        <div
                            class="bg-white px-3 py-1.5 rounded-lg border border-gray-200 text-sm font-medium text-gray-600">
                            <i class="fa-regular fa-calendar mr-2"></i> Semana Actual
                        </div>
                    </div>

                    <!-- Finance Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Ganancia Total -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4 mb-4">
                                <div
                                    class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl">
                                    <i class="fa-solid fa-sack-dollar"></i>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs font-bold uppercase">Tu Ganancia Total</p>
                                    <h3 class="text-2xl font-bold text-emerald-600" id="fin-total-profit">$0.00</h3>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400">Total ventas menos comisiones y cargos.</p>
                        </div>

                        <!-- Efectivo Recibido -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4 mb-4">
                                <div
                                    class="w-12 h-12 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xl">
                                    <i class="fa-solid fa-hand-holding-dollar"></i>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs font-bold uppercase">Efectivo Recibido</p>
                                    <h3 class="text-2xl font-bold text-orange-600" id="fin-cash-received">$0.00</h3>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400">Dinero que ya cobraste en efectivo.</p>
                        </div>

                        <!-- Saldo a Favor -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4 mb-4">
                                <div
                                    class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl">
                                    <i class="fa-solid fa-scale-balanced"></i>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs font-bold uppercase">Saldo a Favor</p>
                                    <h3 class="text-2xl font-bold text-blue-600" id="fin-balance">$0.00</h3>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400">Lo que la plataforma te debe depositar.</p>
                        </div>
                    </div>

                    <!-- Detailed Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-gray-700">Desglose de Pedidos</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wide">
                                        <th class="p-4 font-medium">Pedido</th>
                                        <th class="p-4 font-medium">Fecha</th>
                                        <th class="p-4 font-medium">Total Venta</th>
                                        <th class="p-4 font-medium">Método</th>
                                        <th class="p-4 font-medium">Neto (Tu Ganancia)</th>
                                    </tr>
                                </thead>
                                <tbody id="finances-table-body" class="text-sm divide-y divide-gray-100">
                                    <!-- Rows rendered by JS -->
                                    <tr>
                                        <td colspan="5" class="p-8 text-center text-gray-400">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PROMOCIONES (NEW) -->
                <div id="view-promotions" class="view-section hidden fade-enter space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">🔥 Promociones Avanzadas</h2>
                        <button onclick="renderPromoTab()"
                            class="bg-gray-100 p-2 rounded-lg hover:bg-gray-200 transition"><i
                                class="fa-solid fa-rotate"></i></button>
                    </div>

                    <!-- Shipping Config (Moved Here) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-truck text-blue-500"></i> Configuración de Envíos
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2 flex items-center gap-3">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="conf-shipping-free-active" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                    </div>
                                </label>
                                <label for="conf-shipping-free-active" class="text-xs font-bold text-gray-700">Activar
                                    "Envío Gratis"</label>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Monto Mínimo para
                                    Gratis ($)</label>
                                <input type="number" id="conf-shipping-threshold"
                                    class="w-full border border-gray-300 rounded p-2 text-sm"
                                    placeholder="0 = Siempre Gratis">
                                <p class="text-[10px] text-gray-400 mt-1">Si es 0, el envío es gratis siempre.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Costo por KM
                                    ($)</label>
                                <input type="number" id="conf-shipping-cost"
                                    class="w-full border border-gray-300 rounded p-2 text-sm font-bold text-gray-700"
                                    placeholder="11">
                                <p class="text-[10px] text-gray-400 mt-1">Se cobra solo si NO aplica envío gratis.</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Promo Creator -->
                        <div class="lg:col-span-1 space-y-4">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 sticky top-4">
                                <h3 class="font-bold text-lg mb-4 text-slate-800">Crear Nueva Promo</h3>

                                <div class="grid grid-cols-2 gap-2 mb-4">
                                    <button onclick="setPromoType('discount')" id="btn-promo-discount"
                                        class="promo-type-btn p-2 rounded-lg border border-gray-200 text-xs font-bold hover:bg-blue-50 hover:border-blue-200 transition text-center">🏷️
                                        Descuento</button>
                                    <button onclick="setPromoType('2x1')" id="btn-promo-2x1"
                                        class="promo-type-btn p-2 rounded-lg border border-gray-200 text-xs font-bold hover:bg-blue-50 hover:border-blue-200 transition text-center">✌️
                                        2x1</button>
                                    <button onclick="setPromoType('combo')" id="btn-promo-combo"
                                        class="promo-type-btn p-2 rounded-lg border border-gray-200 text-xs font-bold hover:bg-blue-50 hover:border-blue-200 transition text-center">🍱
                                        Combo</button>
                                    <button onclick="setPromoType('flash')" id="btn-promo-flash"
                                        class="promo-type-btn p-2 rounded-lg border border-gray-200 text-xs font-bold hover:bg-blue-50 hover:border-blue-200 transition text-center">⚡
                                        Relámpago</button>
                                    <button onclick="setPromoType('gift')" id="btn-promo-gift"
                                        class="promo-type-btn col-span-2 p-2 rounded-lg border border-gray-200 text-xs font-bold hover:bg-blue-50 hover:border-blue-200 transition text-center">🎁
                                        Compra X Lleva Y</button>
                                </div>

                                <div id="promo-form-container" class="space-y-3">
                                    <p class="text-xs text-gray-400 text-center py-4">Selecciona un tipo de
                                        promoción
                                        arriba para comenzar.</p>
                                </div>

                                <div id="promo-actions" class="hidden mt-4 pt-4 border-t border-gray-100">
                                    <button onclick="savePromo()"
                                        class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">Guardar
                                        Promoción</button>
                                </div>
                            </div>
                        </div>

                        <!-- Active Promos List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg mb-4 text-slate-800">Promociones Activas</h3>
                                <div id="active-promos-list" class="space-y-3">
                                    <!-- Promos list will be rendered here -->
                                    <p class="text-sm text-gray-400 text-center py-8">No tienes promociones
                                        activas.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: ORDERS MONITOR (MODIFICADO) -->
                <div id="view-orders" class="view-section hidden fade-enter">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Gestión de Pedidos</h2>
                    <div
                        class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[calc(100vh-150px)]">
                        <div class="p-4 border-b border-gray-100 flex gap-2 overflow-x-auto bg-gray-50">
                            <button onclick="renderOrdersTable('active')" id="btn-monitor-active"
                                class="filter-btn active px-4 py-2 text-xs font-bold rounded-full border border-blue-200 text-blue-700">
                                <i class="fa-solid fa-pulse mr-1"></i> Monitor Activo
                            </button>
                            <button onclick="renderOrdersTable('history')" id="btn-monitor-history"
                                class="filter-btn px-4 py-2 text-xs font-bold rounded-full bg-white hover:bg-gray-100 text-gray-500 border border-gray-200">
                                <i class="fa-solid fa-clock-rotate-left mr-1"></i> Historial Semanal
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
                            id="orders-list-container">
                            <div class="text-center text-gray-400 mt-10 w-full col-span-full">Cargando
                                pedidos...</div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MENU MANAGER -->
                <div id="view-menu" class="view-section hidden fade-enter">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Gestión de Menú</h2>
                            <p class="text-gray-500 text-sm">Organiza tus productos, categorías y complementos.
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openProductModal()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-bold text-sm shadow-md transition flex items-center gap-2"><i
                                    class="fa-solid fa-plus"></i> Nuevo Producto</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Col: Categories & Groups -->
                        <div class="space-y-6">
                            <!-- Categories Card (Dynamic) -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                                <div class="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">📂 Categorías
                                    </h3>
                                    <button onclick="openCategoryCreator()"
                                        class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold transition flex items-center gap-1">
                                        <i class="fa-solid fa-plus"></i> Nueva
                                    </button>
                                </div>

                                <!-- Creator Form -->
                                <div id="category-creator"
                                    class="hidden bg-gray-50 p-3 rounded-lg mb-3 border border-gray-200 animate-fade-in-up">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-bold text-gray-500 uppercase">Nueva Categoría</span>
                                        <button onclick="closeCategoryCreator()"
                                            class="text-gray-400 hover:text-gray-600"><i
                                                class="fa-solid fa-times"></i></button>
                                    </div>
                                    <input type="text" id="new-cat-name" placeholder="Nombre (ej: Postres)"
                                        class="w-full text-sm border border-gray-300 rounded p-2 mb-2 font-bold text-gray-700 outline-none focus:border-blue-500">
                                    <button onclick="saveCategory()"
                                        class="w-full bg-gray-900 text-white text-xs py-2 rounded font-bold hover:bg-black transition shadow-sm">
                                        Guardar
                                    </button>
                                </div>

                                <div id="categories-list" class="space-y-2 pr-1">
                                    <!-- Dynamic Categories List via JS -->
                                    <p class="text-xs text-center text-gray-400 py-2">Cargando...</p>
                                </div>
                            </div>

                            <!-- Groups Card -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                                <div class="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">🧩
                                        Complementos
                                    </h3>
                                    <button onclick="openNewGroupModal()"
                                        class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold transition flex items-center gap-1"><i
                                            class="fa-solid fa-plus"></i> Nuevo</button>
                                </div>

                                <!-- CREATOR FORM -->
                                <!-- CREATOR FORM REPLACED BY MODAL -->

                                <div id="groups-list" class="space-y-2 pr-1">
                                    <!-- Dynamic Groups List -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: Products Grid -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 h-full">
                                <!-- Tabs for Products -->
                                <!-- Tabs for Products (Dynamic) -->
                                <div id="product-tabs"
                                    class="flex gap-2 overflow-x-auto border-b border-gray-100 pb-1 mb-4 no-scrollbar">
                                    <!-- Dynamic Tabs via JS -->
                                </div>

                                <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <!-- Dynamic Products -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MARKETING (QR) -->
                <div id="view-qr" class="view-section hidden fade-enter">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Marketing y QR</h2>

                    <div
                        class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 flex flex-col md:flex-row gap-8 items-center">
                        <div class="flex-1 space-y-4">
                            <h3 class="font-bold text-lg text-gray-700">Diseño de Material POP</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="renderQR('simple')"
                                    class="p-2 border rounded hover:bg-gray-50 text-xs font-bold text-gray-600"><i
                                        class="fa-solid fa-qrcode"></i> Básico</button>
                                <button onclick="renderQR('card')"
                                    class="p-2 border border-blue-200 bg-blue-50 text-blue-700 rounded text-xs font-bold"><i
                                        class="fa-solid fa-address-card"></i> Tarjeta</button>
                                <button onclick="renderQR('poster')"
                                    class="p-2 border border-gray-800 bg-gray-900 text-white rounded text-xs font-bold"><i
                                        class="fa-solid fa-poster"></i> Poster</button>
                                <button onclick="renderQR('stand')"
                                    class="p-2 border border-orange-200 bg-orange-50 text-orange-700 rounded text-xs font-bold"><i
                                        class="fa-solid fa-utensils"></i> Mesa (Stand)</button>
                                <button onclick="renderQR('story')"
                                    class="p-2 border border-pink-200 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded text-xs font-bold"><i
                                        class="fa-brands fa-instagram"></i> Instagram</button>
                                <button onclick="renderQR('elegant')"
                                    class="p-2 border border-yellow-600 bg-black text-yellow-400 rounded text-xs font-bold"><i
                                        class="fa-solid fa-crown"></i> Elegante</button>
                            </div>

                            <div class="bg-gray-50 p-3 rounded text-xs break-all border">
                                <span class="font-bold">Tu Link:</span> <span id="qr-link-text"
                                    class="text-blue-600">...</span>
                            </div>

                            <button onclick="window.print()"
                                class="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold w-full hover:bg-gray-700 transition"><i
                                    class="fa-solid fa-print mr-2"></i> Imprimir Diseño</button>
                        </div>

                        <div
                            class="flex-1 flex justify-center items-center bg-gray-100 rounded-xl p-6 border-2 border-dashed border-gray-300 w-full min-h-[350px]">
                            <div id="qr-print-area"></div>
                        </div>
                    </div>

                    <!-- AI SOCIAL GENERATOR (REAL) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700 flex items-center gap-2">
                                <i class="fa-solid fa-share-nodes text-pink-500"></i> Generador de Redes
                                Sociales (IA)
                            </h3>
                            <span
                                class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded-full font-bold">Beta</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-4">Crea copys irresistibles para tus redes sociales
                            en
                            segundos usando Inteligencia Artificial real.</p>
                        <div class="flex gap-4 mb-4">
                            <button onclick="generateSocialPost('promo')"
                                class="flex-1 bg-pink-50 text-pink-600 border border-pink-100 py-3 rounded-lg text-xs font-bold hover:bg-pink-100 transition flex justify-center items-center gap-2">
                                <i class="fa-solid fa-fire"></i> Promo Flash
                            </button>
                            <button onclick="generateSocialPost('engaging')"
                                class="flex-1 bg-purple-50 text-purple-600 border border-purple-100 py-3 rounded-lg text-xs font-bold hover:bg-purple-100 transition flex justify-center items-center gap-2">
                                <i class="fa-solid fa-comments"></i> Pregunta Viral
                            </button>
                            <button onclick="generateSocialPost('funny')"
                                class="flex-1 bg-orange-50 text-orange-600 border border-orange-100 py-3 rounded-lg text-xs font-bold hover:bg-orange-100 transition flex justify-center items-center gap-2">
                                <i class="fa-solid fa-face-laugh-beam"></i> Divertido
                            </button>
                        </div>
                        <div class="relative">
                            <textarea id="ai-social-result"
                                class="w-full border border-gray-200 rounded-lg p-3 text-sm text-gray-600 h-28 focus:ring-2 focus:ring-pink-200 outline-none transition bg-gray-50"
                                placeholder="El resultado mágico de la IA aparecerá aquí..."></textarea>
                            <button onclick="copyToClipboard('ai-social-result')"
                                class="absolute bottom-3 right-3 text-gray-400 hover:text-gray-600 text-xs bg-white px-2 py-1 rounded shadow-sm border"><i
                                    class="fa-regular fa-copy"></i> Copiar</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: SETTINGS (COMPLETO) -->
                <div id="view-settings" class="view-section hidden fade-enter">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Configuración de Tienda</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Card 1: Basic Info -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i
                                    class="fa-solid fa-store text-blue-500"></i> Datos Generales</h3>
                            <div class="space-y-4">
                                <div><label class="text-xs font-bold text-gray-500">Nombre del
                                        Negocio</label><input type="text" id="conf-name"
                                        class="w-full border-b border-gray-300 py-1 focus:border-blue-500 outline-none text-sm font-medium">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Giro (IA)</label>
                                    <select id="conf-type"
                                        class="w-full border-b border-gray-300 py-1 bg-transparent text-sm">
                                        <option value="Sushi">Sushi</option>
                                        <option value="Tacos">Tacos</option>
                                        <option value="Pizza">Pizza</option>
                                        <option value="Hamburguesas">Burgers</option>
                                        <option value="Cafeteria">Café</option>
                                        <option value="Comida General">Otro</option>
                                    </select>
                                </div>
                                <div><label class="text-xs font-bold text-gray-500">WhatsApp
                                        Pedidos</label><input type="text" id="conf-whatsapp"
                                        class="w-full border-b border-gray-300 py-1 focus:border-blue-500 outline-none text-sm font-medium">
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: Location & Hours -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i
                                    class="fa-solid fa-map-location-dot text-green-500"></i> Ubicación y Horario
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Dirección</label>
                                    <input type="text" id="conf-address"
                                        class="w-full border-b border-gray-300 py-1 text-sm">
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                    <label class="text-xs font-bold text-blue-700">Ubicación Exacta
                                        (Mapa)</label>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="openMapModal()"
                                            class="w-full bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                            <i class="fa-solid fa-map-location-dot"></i> Seleccionar en Mapa
                                        </button>
                                    </div>
                                    <p class="text-[10px] text-blue-500 mt-1 leading-tight" id="location-coords-text">
                                        <i class="fa-solid fa-info-circle"></i> Define dónde está tu tienda para
                                        calcular envíos.
                                    </p>
                                </div>
                                <input type="hidden" id="conf-lat"><input type="hidden" id="conf-lng">
                                <div class="flex gap-4 items-end">
                                    <div class="flex-1"><label class="text-xs font-bold text-gray-500">Abre
                                            (Hora)</label><input type="number" id="conf-open"
                                            class="w-full border-b border-gray-300 py-1 text-sm"></div>
                                    <div class="flex-1"><label class="text-xs font-bold text-gray-500">Cierra
                                            (Hora)</label><input type="number" id="conf-close"
                                            class="w-full border-b border-gray-300 py-1 text-sm"></div>
                                    <button onclick="optimizeHoursAI()"
                                        class="bg-indigo-50 text-indigo-600 p-2 rounded hover:bg-indigo-100 transition text-xs font-bold"
                                        title="Optimizar con IA"><i
                                            class="fa-solid fa-wand-magic-sparkles"></i></button>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Tiempo de Preparación</label>
                                    <input type="text" id="conf-prep-time" placeholder="Ej: 30-45 min"
                                        class="w-full border-b border-gray-300 py-1 text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Card: Bank Info (NUEVO) -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i
                                    class="fa-solid fa-building-columns text-emerald-600"></i> Datos Bancarios
                            </h3>
                            <div class="space-y-4">
                                <div><label class="text-xs font-bold text-gray-500">Banco</label><input type="text"
                                        id="conf-bank-name" placeholder="Ej: BBVA"
                                        class="w-full border-b border-gray-300 py-1 focus:border-blue-500 outline-none text-sm font-medium">
                                </div>
                                <div><label class="text-xs font-bold text-gray-500">CLABE / Cuenta</label><input
                                        type="text" id="conf-bank-clabe" placeholder="012345678901234567"
                                        class="w-full border-b border-gray-300 py-1 focus:border-blue-500 outline-none text-sm font-medium">
                                </div>
                                <div><label class="text-xs font-bold text-gray-500">Beneficiario</label><input
                                        type="text" id="conf-bank-owner" placeholder="Nombre del Titular"
                                        class="w-full border-b border-gray-300 py-1 focus:border-blue-500 outline-none text-sm font-medium">
                                </div>
                                <p class="text-[10px] text-gray-400 leading-tight">Estos datos aparecerán al
                                    cliente al
                                    elegir "Transferencia".</p>
                            </div>
                        </div>

                        <!-- NUEVA TARJETA: ALTA DEMANDA -->
                        <div
                            class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:col-span-2 border-l-4 border-orange-500">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-fire text-orange-500"></i> Estado del Servicio
                            </h3>
                            <div class="flex items-center justify-between mb-4 pb-4 border-b border-orange-200">
                                <div>
                                    <p class="font-bold text-sm text-gray-800">Estado de Tienda</p>
                                    <p class="text-xs text-gray-500">Apaga para cerrar la tienda y bloquear
                                        pedidos.</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="conf-is-open" class="sr-only peer" checked>
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                    </div>
                                    <span class="ml-3 text-xs font-bold text-gray-700"
                                        id="conf-is-open-label">Abierto</span>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-bold text-sm text-gray-800">Modo Alta Demanda</p>
                                    <p class="text-xs text-gray-500">Activa esto cuando tengas muchos pedidos.
                                        El bot
                                        avisará a los clientes del tiempo de espera.</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="conf-high-demand-active" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600">
                                    </div>
                                </label>
                            </div>
                            <div id="high-demand-input-container"
                                class="mt-4 hidden bg-orange-50 p-3 rounded-lg border border-orange-100">
                                <label class="block text-xs font-bold text-orange-800 uppercase mb-1">Tiempo de
                                    Espera
                                    Estimado</label>
                                <input type="text" id="conf-high-demand-time" placeholder="Ej: 45-60 minutos"
                                    class="w-full bg-white border border-orange-200 rounded px-3 py-2 focus:border-orange-500 outline-none text-sm font-bold text-gray-700">
                                <p class="text-[10px] text-orange-600 mt-1"><i class="fa-solid fa-info-circle"></i> Este
                                    mensaje se mostrará a los clientes antes de pedir.</p>
                            </div>
                        </div>

                        <!-- Card 3: Branding -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:col-span-2">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i
                                    class="fa-solid fa-image text-purple-500"></i> Imagen de Portada</h3>
                            <div class="flex items-center gap-4">
                                <div class="w-32 h-20 bg-gray-100 rounded-lg overflow-hidden border relative group">
                                    <img id="hero-preview" src="" class="w-full h-full object-cover">
                                    <div
                                        class="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center text-white text-xs">
                                        Cambiar</div>
                                </div>
                                <div class="flex-1">
                                    <input type="file" onchange="handleHeroUpload(this)"
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                    <input type="hidden" id="conf-hero">
                                </div>
                            </div>

                            <!-- Logo Upload -->
                            <div class="mt-6 border-t border-gray-100 pt-6">
                                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i
                                        class="fa-solid fa-circle-user text-blue-500"></i> Logo del Negocio</h3>
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-20 h-20 bg-gray-100 rounded-full overflow-hidden border relative group shadow-sm">
                                        <img id="logo-preview" src="" class="w-full h-full object-cover">
                                        <div
                                            class="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center text-white text-[10px] text-center">
                                            Cambiar</div>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" onchange="handleLogoUpload(this)"
                                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition mb-2">
                                        <input type="hidden" id="conf-logo">
                                        <p class="text-[10px] text-gray-400">Recomendado: 500x500px (Cuadrado).
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <!-- End Logo Upload -->

                            <!-- Shipping Config Moved to Promotions -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- SAVE FLOATING BUTTON -->
            <button onclick="saveChanges()"
                class="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-4 rounded-full font-bold shadow-2xl hover:bg-black transition transform hover:scale-105 flex items-center gap-2 z-40">
                <i class="fa-solid fa-floppy-disk"></i> Guardar Cambios
            </button>
        </main>
    </div>

    <!-- MAP MODAL -->
    <div id="map-modal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl w-full max-w-2xl h-[90vh] md:h-[600px] shadow-2xl flex flex-col overflow-hidden animate-fade-in-up relative">
            <div
                class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 flex justify-between items-center text-white shrink-0">
                <div>
                    <h3 class="font-bold text-lg"><i class="fa-solid fa-location-dot mr-2"></i>Ubica tu Negocio</h3>
                    <p class="text-xs text-blue-100">Arrastra el pin rojo a la entrada de tu tienda.</p>
                </div>
                <button onclick="closeMapModal()"
                    class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="relative flex-1 bg-gray-100">
                <div id="map-picker" class="w-full h-full z-0"></div>
                <button onclick="detectAdminLocation()"
                    class="absolute bottom-4 right-4 z-[9999] bg-white text-gray-700 p-3 rounded-full shadow-lg hover:bg-gray-50 hover:text-blue-600 transition border border-gray-200"
                    title="Usar mi ubicación actual">
                    <i class="fa-solid fa-location-crosshairs text-xl"></i>
                </button>
            </div>

            <div
                class="p-4 bg-white border-t border-gray-200 shrink-0 flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="text-xs text-gray-500 flex-1">
                    <p class="font-bold text-gray-800" id="map-selected-address">...</p>
                    <p>Lat: <span id="map-lat">0</span>, Lng: <span id="map-lng">0</span></p>
                </div>
                <button onclick="confirmMapLocation()"
                    class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-500/30 transition transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-check-circle mr-2"></i> Confirmar Ubicación
                </button>
            </div>
        </div>
    </div>

    <!-- Modals (Producto, Suscripción) -->

    <!-- ORDER DETAIL MODAL -->
    <div id="order-detail-modal"
        class="fixed inset-0 z-50 hidden bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col h-full max-h-[85vh] animate-fade-in-up">
            <!-- Modal Header -->
            <div
                class="bg-gradient-to-r from-gray-900 to-gray-800 px-6 py-4 border-b border-gray-700 flex justify-between items-center text-white">
                <div>
                    <h3 class="font-bold text-xl flex items-center gap-2">
                        <i class="fa-solid fa-receipt"></i> <span id="detail-order-id">Pedido #0</span>
                    </h3>
                    <p class="text-xs text-gray-400" id="detail-order-date">...</p>
                </div>
                <button onclick="document.getElementById('order-detail-modal').classList.add('hidden')"
                    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50 space-y-6">

                <!-- Status & Payment -->
                <div class="flex gap-4">
                    <div class="flex-1 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Estado Actual</p>
                        <div id="detail-status-badge"></div>
                    </div>
                    <div class="flex-1 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Pago</p>
                        <p class="font-bold text-gray-800" id="detail-payment">...</p>
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <h4 class="font-bold text-gray-700 text-sm mb-3 border-b pb-2 flex items-center gap-2"><i
                            class="fa-solid fa-user text-blue-500"></i> Cliente</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="text-gray-500 w-20">Nombre:</span> <span
                                class="font-bold text-gray-800" id="detail-cust-name">...</span></div>
                        <div class="flex"><span class="text-gray-500 w-20">Teléfono:</span> <span
                                class="font-bold text-gray-800" id="detail-cust-phone">...</span></div>
                        <div class="flex items-start"><span class="text-gray-500 w-20">Dirección:</span> <span
                                class="font-bold text-gray-800 flex-1" id="detail-cust-address">...</span></div>
                    </div>
                </div>

                <!-- Items List -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <h4 class="font-bold text-gray-700 text-sm mb-3 border-b pb-2 flex items-center gap-2"><i
                            class="fa-solid fa-utensils text-orange-500"></i> Productos</h4>
                    <div id="detail-items-list" class="space-y-3">
                        <!-- Items rendered here -->
                    </div>
                    <div class="border-t border-gray-100 mt-3 pt-2 flex justify-between items-center">
                        <span class="font-bold text-gray-600">Total</span>
                        <span class="font-bold text-xl text-green-600" id="detail-total">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="p-4 bg-white border-t border-gray-200 flex flex-col gap-3">
                <p class="text-xs font-bold text-gray-400 uppercase text-center mb-1">Cambiar Estado del Pedido</p>
                <button id="btn-status-toggle" onclick="toggleOrderStatus()"
                    class="w-full py-4 rounded-xl text-lg font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-rotate"></i> <span>Cargando acción...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Otros Modals (Product, Sub) -->
    <div id="product-modal"
        class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-fade-in-up">
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800">Producto</h3><button onclick="closeProductModal()"
                    class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[85vh] overflow-y-auto"><input type="hidden" id="prod-id">
                <!-- Category Select (Dynamic) -->
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">Categoría</label>
                    <select id="prod-category-select"
                        class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <!-- Populated via JS -->
                    </select>
                </div>
                <!-- GRID LAYOUT -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- COL 1: Basic Info -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Nombre del Producto</label>
                            <input type="text" id="prod-name"
                                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                placeholder="Ej: Pizza Pepperoni">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Descripción</label>
                            <textarea id="prod-desc" rows="3"
                                class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                placeholder="Ingredientes, tamaño..."></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Precio Actual</label>
                                <div class="relative">
                                    <span class="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                                    <input type="number" id="prod-price"
                                        class="w-full border border-gray-300 rounded-lg p-2 pl-6 text-sm font-bold text-gray-800 outline-none"
                                        placeholder="0.00">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">Precio Original
                                    (Opcional)</label>
                                <div class="relative">
                                    <span class="absolute left-2 top-2 text-gray-400 text-sm">$</span>
                                    <input type="number" id="prod-original"
                                        class="w-full border border-gray-300 rounded-lg p-2 pl-6 text-sm text-gray-500 outline-none"
                                        placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Etiquetas (separadas por
                                coma)</label>
                            <input type="text" id="prod-tags"
                                class="w-full border border-gray-300 rounded-lg p-2 text-sm outline-none"
                                placeholder="picante, nuevo, vegano">
                        </div>
                    </div>

                    <!-- COL 2: Image & Modifiers -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Imagen del Producto</label>
                            <div
                                class="flex items-start gap-3 bg-gray-50 p-3 rounded-xl border border-dashed border-gray-300">
                                <img id="prod-img-preview" src=""
                                    class="w-20 h-20 rounded-lg object-cover bg-white border border-gray-200">
                                <div class="flex-1 min-w-0">
                                    <input type="file" onchange="handleImageUpload(this)"
                                        class="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-2">
                                    <input type="text" id="prod-img-url"
                                        class="w-full text-[10px] border border-gray-200 rounded p-1 text-gray-500 truncate"
                                        placeholder="URL de la imagen...">
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-xs font-bold text-blue-800">Grupos de Modificadores</label>
                                <button onclick="openGroupCreatorAdvanced()"
                                    class="text-[10px] bg-white border border-blue-200 text-blue-600 px-2 py-0.5 rounded shadow-sm font-bold hover:bg-blue-50">+
                                    Crear Nuevo</button>
                            </div>
                            <div id="prod-group-container"
                                class="border border-blue-200 rounded-lg p-2 max-h-32 overflow-y-auto bg-white">
                                <!-- JS Injected Checkboxes -->
                                <span class="text-xs text-gray-400 italic">Cargando grupos...</span>
                            </div>
                            <p class="text-[10px] text-blue-400 mt-1 leading-tight">Selecciona los grupos que aplican a
                                este producto (ej: Salsas, Extras).</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end gap-3"><button onclick="closeProductModal()"
                        class="px-4 py-2 rounded text-gray-500 hover:bg-gray-200 text-sm font-bold">Cancelar</button><button
                        onclick="saveProductInternal()"
                        class="px-6 py-2 rounded bg-blue-600 text-white font-bold text-sm hover:bg-blue-700 shadow">Guardar</button>
                </div>
            </div>
        </div>



        <div id="print-area" class="hidden"></div>

        <!-- GROUP CREATOR MODAL -->
        <!-- MOVED MODAL TO BOTTOM -->

        <script>
            const API_URL = "https://menuia.onrender.com";
            const socket = io(API_URL);

            // --- AUDIO NOTIFICATIONS ---
            function playOrderNotification() {
                // 1. Oscillator Beep (Classic Digital Alarm)
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        const ctx = new AudioContext();
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);

                        osc.type = 'square';
                        osc.frequency.setValueAtTime(440, ctx.currentTime);
                        osc.frequency.setValueAtTime(880, ctx.currentTime + 0.1); // High pitch
                        osc.frequency.setValueAtTime(440, ctx.currentTime + 0.2);
                        osc.frequency.setValueAtTime(880, ctx.currentTime + 0.3);

                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);

                        osc.start();
                        osc.stop(ctx.currentTime + 0.5);
                    }
                } catch (e) { console.error("Audio Context Error", e); }

                // 2. TTS
                if ('speechSynthesis' in window) {
                    // Cancel any ongoing speech
                    window.speechSynthesis.cancel();

                    const speech = new SpeechSynthesisUtterance("¡Atención! Tienes un nuevo pedido en iafood.");
                    speech.lang = 'es-MX';
                    speech.rate = 1.0;
                    speech.volume = 1.0;
                    speech.pitch = 1.1; // Slightly higher/urgent
                    window.speechSynthesis.speak(speech);
                }
            }

            function testAudio() {
                playOrderNotification();
                alert("Si escuchaste el sonido, las notificaciones están activas.");
                // Request Permission logic
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            }

            socket.on('new-order', (data) => {
                console.log("🔔 Nuevo Pedido SOCKET:", data);
                playOrderNotification();

                // Refresh Monitor if visible
                if (!document.getElementById('view-orders').classList.contains('hidden')) {
                    fetchAndRenderOrders(currentOrderFilter);
                }

                // Show visual toast?
                alert("¡Nuevo Pedido Recibido!");
                // Using alert might be invasive, but effective for admin. 
                // Better: rely on the audio + list refresh. 
                // Attempting to notify via browser api if possible?
                if (Notification.permission === "granted") {
                    new Notification("Nuevo Pedido", { body: "Revisa el panel de administración." });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            });

            let SESSION = { slug: null, password: null, data: null };
            let currentCategory = 'promos';
            let ordersHistory = [];
            let currentDetailOrder = null;
            let currentOrderFilter = 'active'; // Default view

            function switchView(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'border-r-2', 'border-blue-600'));
                const activeBtn = Array.from(document.querySelectorAll('.nav-item')).find(b => b.getAttribute('onclick').includes(viewId));
                if (activeBtn) { activeBtn.classList.add('active'); activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-50'); }

                // Auto-close mobile menu
                const sidebar = document.querySelector('aside');
                if (window.innerWidth < 768 && !sidebar.classList.contains('hidden')) {
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('fixed', 'inset-0', 'z-50');
                }

                if (viewId === 'menu') { renderGroups(); renderMenuGrid(currentCategory); }
                if (viewId === 'qr') renderQR('simple');
                if (viewId === 'orders') fetchAndRenderOrders(currentOrderFilter);
                if (viewId === 'dashboard') updateFinances();
                if (viewId === 'finances') renderFinances();
                if (viewId === 'promotions') renderPromoTab();

                const saveBtn = document.querySelector('button[onclick="saveChanges()"]');
                if (saveBtn) {
                    if (viewId === 'settings' || viewId === 'menu' || viewId === 'promotions') saveBtn.classList.remove('hidden');
                    else saveBtn.classList.add('hidden');
                }
            }

            function switchTab(tab) {
                const l = document.getElementById('form-login'), r = document.getElementById('form-register');
                if (tab === 'login') { l.classList.remove('hidden'); r.classList.add('hidden'); } else { l.classList.add('hidden'); r.classList.remove('hidden'); }
            }

            window.onload = () => {
                const s = localStorage.getItem('shop_slug'), p = localStorage.getItem('shop_pass');
                if (s && p) { document.getElementById('login-slug').value = s; document.getElementById('login-pass').value = p; }
                document.getElementById('conf-high-demand-active').addEventListener('change', toggleHighDemandInput);
            };

            async function handleLogin() {
                const slug = document.getElementById('login-slug').value.trim().toLowerCase();
                const password = document.getElementById('login-pass').value;
                try {
                    const res = await fetch(`${API_URL}/api/admin/get`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slug, password }) });
                    if (res.ok) {
                        SESSION = { slug, password, data: await res.json() };
                        if (!SESSION.data.menu) SESSION.data.menu = { promos: [], especiales: [], clasicos: [], extras: [], groups: [] };
                        if (!SESSION.data.menu.groups) SESSION.data.menu.groups = [];
                        if (!SESSION.data.stats) SESSION.data.stats = { visits: 0, orders: 0 };

                        localStorage.setItem('shop_slug', slug); localStorage.setItem('shop_pass', password);
                        socket.emit('join-store', slug);

                        // MIGRATION: If legacy shop has no categories array, create default one from existing keys
                        if (!SESSION.data.config.categories || SESSION.data.config.categories.length === 0) {
                            const defaults = [
                                { id: 'promos', name: (SESSION.data.config.categoryTitles?.promos || '🔥 Promociones') },
                                { id: 'especiales', name: (SESSION.data.config.categoryTitles?.especiales || '⭐ Recomendados') },
                                { id: 'clasicos', name: (SESSION.data.config.categoryTitles?.clasicos || '🍽️ Menú Principal') },
                                { id: 'extras', name: (SESSION.data.config.categoryTitles?.extras || '🥤 Bebidas y Otros') }
                            ];
                            // Only add if they actually have content or we want to force common structure
                            // Let's force defaults so tabs appear
                            SESSION.data.config.categories = defaults;
                        }

                        initDashboard();
                    } else alert("Credenciales incorrectas");
                } catch (e) { alert("Error de conexión"); }
            }

            async function handleRegister() { alert("Usa el formulario de registro existente."); }

            function initDashboard() {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('dashboard-container').classList.remove('hidden');
                const c = SESSION.data.config;
                const stats = SESSION.data.stats || { visits: 0, orders: 0 };
                document.getElementById('dash-owner-name').innerText = SESSION.data.credentials.ownerName || 'Dueño';

                // Sub Status Logic Removed
                const badge = document.getElementById('sub-status-badge');
                if (badge) badge.style.display = 'none';

                // Initial Stats
                document.getElementById('stat-visits-count').innerText = stats.visits;
                document.getElementById('stat-orders-count').innerText = stats.orders;

                // Products Count
                const prodCount = (SESSION.data.menu.promos?.length || 0) + (SESSION.data.menu.especiales?.length || 0) +
                    (SESSION.data.menu.clasicos?.length || 0) + (SESSION.data.menu.extras?.length || 0);

                const storeUrl = `https://iamenu.github.io/menuia/menu.html?slug=${SESSION.slug}`;
                document.getElementById('sidebar-link-store').href = storeUrl;
                const qrLinkElement = document.getElementById('qr-link-text');
                if (qrLinkElement) qrLinkElement.innerText = storeUrl;

                document.getElementById('conf-name').value = c.name || '';
                document.getElementById('conf-type').value = c.businessType || 'Comida General';
                document.getElementById('conf-address').value = c.address || '';
                document.getElementById('conf-whatsapp').value = c.whatsapp || '';
                document.getElementById('conf-open').value = c.hours?.open || 9;
                document.getElementById('conf-close').value = c.hours?.close || 22;
                document.getElementById('conf-prep-time').value = c.prepTime || "30-45 min";
                document.getElementById('conf-hero').value = c.heroImage || '';
                document.getElementById('conf-logo').value = c.logo || '';
                document.getElementById('hero-preview').src = c.heroImage || '';
                document.getElementById('logo-preview').src = c.logo || '';

                // Cargar Datos Bancarios
                const bank = c.bankDetails || {};
                document.getElementById('conf-bank-name').value = bank.name || '';
                document.getElementById('conf-bank-clabe').value = bank.clabe || '';
                document.getElementById('conf-bank-owner').value = bank.owner || '';

                const hd = c.highDemand || false;
                document.getElementById('conf-high-demand-active').checked = hd;

                // Shipping Init
                const shipCfg = SESSION.data.config.shipping || {};
                document.getElementById('conf-shipping-free-active').checked = shipCfg.freeShippingActive || false;
                document.getElementById('conf-shipping-threshold').value = shipCfg.freeShippingThreshold || 0;
                document.getElementById('conf-shipping-cost').value = shipCfg.costPerKm || 11;

                // Init Open/Close
                const isOpen = c.isOpen !== false; // Default true if undefined
                const openToggle = document.getElementById('conf-is-open');
                openToggle.checked = isOpen;
                updateOpenLabel(isOpen);
                openToggle.addEventListener('change', (e) => updateOpenLabel(e.target.checked));

                document.getElementById('conf-high-demand-time').value = c.highDemandTime || '';
                toggleHighDemandInput();

                renderCategoryTabs();
                renderCategoriesList();

                // Initial Finance Load
                updateFinances();
                switchView('dashboard');
            }

            function toggleHighDemandInput() {
                const isActive = document.getElementById('conf-high-demand-active').checked;
                const container = document.getElementById('high-demand-input-container');
                if (isActive) container.classList.remove('hidden');
                else container.classList.add('hidden');
            }

            function updateOpenLabel(isOpen) {
                const lbl = document.getElementById('conf-is-open-label');
                if (isOpen) {
                    lbl.innerText = "Abierto";
                    lbl.className = "ml-3 text-xs font-bold text-green-600";
                } else {
                    lbl.innerText = "Cerrado";
                    lbl.className = "ml-3 text-xs font-bold text-red-600";
                }
            }

            socket.on('stats-update', (stats) => {
                if (stats) {
                    document.getElementById('stat-visits-count').innerText = stats.visits;
                    document.getElementById('stat-orders-count').innerText = stats.orders;
                    // Refresh finances on new order
                    updateFinances();
                }
            });

            socket.on('new-order-saved', () => {
                if (!document.getElementById('view-orders').classList.contains('hidden')) {
                    fetchAndRenderOrders(currentOrderFilter);
                }
                // Also refresh finances
                updateFinances();
            });

            // --- FINANCE LOGIC ---
            async function updateFinances() {
                // Fetch latest orders to calculate finance
                try {
                    const res = await fetch(`${API_URL}/api/orders/list`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slug: SESSION.slug, password: SESSION.password })
                    });
                    const data = await res.json();

                    if (data.success) {
                        const orders = data.orders;
                        const today = moment().startOf('day');
                        const startOfMonth = moment().startOf('month');

                        let salesToday = 0;
                        let salesMonth = 0;

                        // Daily Sales Map (Last 7 days)
                        const last7Days = {};
                        for (let i = 6; i >= 0; i--) {
                            const d = moment().subtract(i, 'days').format('ddd'); // Mon, Tue...
                            last7Days[d] = 0;
                        }

                        orders.forEach(o => {
                            // Only count if not cancelled (assuming we don't have cancelled status yet, but strictly logic)
                            // Using 'completed', 'delivering', 'ready', 'preparing', 'pending' are all valid sales unless cancelled
                            // Let's assume all non-cancelled orders count as sales for now

                            const orderDate = moment(o.createdAt);
                            // Clean currency string "$150.00" -> 150.00
                            const amount = parseFloat((o.total || "0").replace(/[^0-9.-]+/g, ""));

                            if (orderDate.isSameOrAfter(today)) {
                                salesToday += amount;
                            }
                            if (orderDate.isSameOrAfter(startOfMonth)) {
                                salesMonth += amount;
                            }

                            // Chart Data
                            const dayKey = orderDate.format('ddd'); // Mon
                            if (moment().diff(orderDate, 'days') <= 6 && last7Days[dayKey] !== undefined) {
                                last7Days[dayKey] += amount;
                            }
                        });

                        document.getElementById('stat-sales-today').innerText = `$${salesToday.toFixed(2)}`;
                        document.getElementById('stat-sales-month').innerText = `$${salesMonth.toFixed(2)}`;

                        // Render Chart
                        renderFinanceChart(last7Days);
                    }
                } catch (e) {
                    console.error("Error updating finances", e);
                }
            }

            function renderFinanceChart(dataObj) {
                const container = document.getElementById('finance-chart');
                const labelsContainer = document.getElementById('finance-labels');
                container.innerHTML = '';
                labelsContainer.innerHTML = '';

                const days = Object.keys(dataObj);
                const values = Object.values(dataObj);
                const maxVal = Math.max(...values, 100); // Avoid div by zero, min scale 100

                days.forEach((day, index) => {
                    const val = values[index];
                    const heightPct = (val / maxVal) * 100;

                    // Bar
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = `${heightPct}%`;
                    bar.innerHTML = `<div class="bar-tooltip">$${val.toFixed(0)}</div>`;
                    container.appendChild(bar);

                    // Label
                    const label = document.createElement('div');
                    label.innerText = day;
                    labelsContainer.appendChild(label);
                });
            }


            // --- ORDERS MONITOR (ACTUALIZADO) ---
            async function fetchAndRenderOrders(filter) {
                currentOrderFilter = filter;

                // Actualizar botones de filtro
                document.getElementById('btn-monitor-active').className = filter === 'active'
                    ? "filter-btn active px-4 py-2 text-xs font-bold rounded-full border border-blue-200 text-blue-700 bg-blue-100"
                    : "filter-btn px-4 py-2 text-xs font-bold rounded-full bg-white hover:bg-gray-100 text-gray-500 border border-gray-200";

                document.getElementById('btn-monitor-history').className = filter === 'history'
                    ? "filter-btn active px-4 py-2 text-xs font-bold rounded-full border border-blue-200 text-blue-700 bg-blue-100"
                    : "filter-btn px-4 py-2 text-xs font-bold rounded-full bg-white hover:bg-gray-100 text-gray-500 border border-gray-200";

                const container = document.getElementById('orders-list-container');
                container.innerHTML = `<div class="text-center text-gray-400 mt-10 col-span-full"><i class="fa-solid fa-spinner fa-spin"></i> Cargando...</div>`;
                try {
                    const res = await fetch(`${API_URL}/api/orders/list`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slug: SESSION.slug, password: SESSION.password }) });
                    const data = await res.json();
                    if (data.success) { ordersHistory = data.orders; renderOrders(filter); }
                } catch (e) { container.innerHTML = `<div class="text-center text-red-400 mt-10 col-span-full">Error cargando pedidos</div>`; }
            }
            function renderOrdersTable(f) { fetchAndRenderOrders(f); }

            function renderOrders(f) {
                const c = document.getElementById('orders-list-container');
                let orders = [];

                // Lógica de Filtros Estricta
                if (f === 'active') {
                    // Monitor: Solo pedidos NO completados
                    orders = ordersHistory.filter(o => o.status !== 'completed');
                } else if (f === 'history') {
                    // Historial: Solo Completados de la semana actual (Lunes a Lunes)
                    const startOfWeek = moment().startOf('isoWeek'); // Lunes 00:00 de esta semana
                    orders = ordersHistory.filter(o => {
                        const isCompleted = o.status === 'completed';
                        const isRecent = moment(o.createdAt).isSameOrAfter(startOfWeek);
                        return isCompleted && isRecent;
                    });
                }

                if (orders.length === 0) {
                    c.innerHTML = `<div class="text-center text-gray-400 mt-10 col-span-full flex flex-col items-center gap-2">
                    <i class="fa-solid fa-clipboard-check text-4xl opacity-20"></i>
                    <p>No hay pedidos en esta sección.</p>
                </div>`;
                    return;
                }

                // RENDERING CARDS MINIMALISTAS
                c.innerHTML = orders.map(o => {
                    let badgeClass = 'bg-gray-100 text-gray-600';
                    let statusIcon = 'fa-circle-question';
                    if (o.status === 'pending') { badgeClass = 'bg-yellow-100 text-yellow-700 border-yellow-200'; statusIcon = 'fa-clock'; }
                    if (o.status === 'preparing') { badgeClass = 'bg-orange-100 text-orange-700 border-orange-200'; statusIcon = 'fa-fire-burner'; }
                    if (o.status === 'ready') { badgeClass = 'bg-blue-100 text-blue-700 border-blue-200'; statusIcon = 'fa-box-open'; }
                    if (o.status === 'delivering') { badgeClass = 'bg-purple-100 text-purple-700 border-purple-200'; statusIcon = 'fa-motorcycle'; }
                    if (o.status === 'completed') { badgeClass = 'bg-green-100 text-green-700 border-green-200'; statusIcon = 'fa-check-circle'; }

                    const safeOrder = JSON.stringify(o).replace(/"/g, '&quot;');

                    return `
                <div onclick="openOrderDetails(${safeOrder})" class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer group relative overflow-hidden animate-fade-in-up">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-blue-50 to-transparent rounded-bl-full -mr-4 -mt-4 opacity-50"></div>
                    
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-xl text-gray-800">Pedido #${o.dailyId || '?'}</h3>
                            <p class="text-xs text-gray-400 font-medium">${moment(o.createdAt).fromNow()}</p>
                        </div>
                        <div class="rounded-full px-2 py-1 text-[10px] font-bold uppercase border ${badgeClass} flex items-center gap-1">
                            <i class="fa-solid ${statusIcon}"></i> ${o.status}
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-2 mb-3 border border-gray-100">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 font-medium">Método Pago</span>
                            <span class="font-bold text-gray-800">${o.paymentMethod || 'No especificado'}</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-2 border-t border-gray-100 pt-2">
                        <span class="text-xs font-bold text-gray-400 uppercase">${o.items ? o.items.length : 0} Artículos</span>
                        <span class="text-indigo-600 font-bold text-sm group-hover:underline">Ver Detalles <i class="fa-solid fa-arrow-right ml-1"></i></span>
                    </div>
                </div>`;
                }).join('');
            }

            // --- ORDER DETAIL MODAL LOGIC ---
            function openOrderDetails(order) {
                currentDetailOrder = order;
                const m = document.getElementById('order-detail-modal');

                document.getElementById('detail-order-id').innerText = `Pedido #${order.dailyId || '?'}`;
                document.getElementById('detail-order-date').innerText = moment(order.createdAt).format('LLLL');

                // Status Badge
                const statusMap = {
                    'pending': '<span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">Pendiente</span>',
                    'preparing': '<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold border border-orange-200">En Cocina</span>',
                    'ready': '<span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">Listo para Entrega</span>',
                    'delivering': '<span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-bold border border-purple-200">En Camino</span>',
                    'completed': '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">Completado/Entregado</span>'
                };
                document.getElementById('detail-status-badge').innerHTML = statusMap[order.status] || order.status;
                document.getElementById('detail-payment').innerText = order.paymentMethod || 'N/A';

                // Customer
                document.getElementById('detail-cust-name').innerText = order.customerName || order.ref || 'Cliente General';
                document.getElementById('detail-cust-phone').innerText = order.customerPhone || 'N/A';

                // Address & Note
                let addrHtml = order.address || 'Recoger en Tienda / N/A';
                if (order.note) {
                    addrHtml += `<div class="mt-2 text-xs bg-yellow-50 text-yellow-800 p-2 rounded border border-yellow-100">
                        <i class="fa-regular fa-comment-dots mr-1"></i> <strong>Nota de Entrega:</strong> ${order.note}
                    </div>`;
                }
                document.getElementById('detail-cust-address').innerHTML = addrHtml;

                // Items
                const itemsList = document.getElementById('detail-items-list');
                if (order.items && order.items.length > 0) {
                    itemsList.innerHTML = order.items.map(i => {
                        let htmlModifiers = '';

                        // New Format (Array)
                        if (i.modifiers && Array.isArray(i.modifiers) && i.modifiers.length > 0) {
                            htmlModifiers = i.modifiers.map(m => `
                                <div class="text-[10px] text-gray-500 mt-0.5 bg-gray-100 px-1.5 py-0.5 rounded inline-block">
                                    <i class="fa-solid fa-plus-circle text-xs mr-1"></i>${m.name} (+MX$${m.price})
                                </div>
                             `).join('');
                        }
                        // Legacy Format
                        else if (i.options && i.options.length > 0) {
                            const opts = i.options.map(o => typeof o === 'string' ? o : o.name).join(', ');
                            htmlModifiers = `<div class="text-[10px] text-gray-500 mt-0.5 bg-gray-100 px-1.5 py-0.5 rounded inline-block">
                                <i class="fa-solid fa-plus-circle text-xs mr-1"></i>${opts}
                            </div>`;
                        }

                        let extrasHtml = '';
                        if (i.cutlery) extrasHtml += `<span class="text-[10px] text-blue-600 font-bold mr-2"><i class="fa-solid fa-utensils"></i> Con Cubiertos</span>`;
                        if (i.note) extrasHtml += `<div class="text-[10px] text-orange-600 italic block mt-1">" ${i.note} "</div>`;

                        return `
                    <div class="flex justify-between items-start border-b border-gray-100 pb-2 last:border-0">
                        <div class="flex-1">
                            <span class="font-bold text-gray-800 text-sm">${i.qty}x ${i.name}</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${htmlModifiers}
                            </div>
                            ${extrasHtml ? `<div class="mt-1">${extrasHtml}</div>` : ''}
                            ${i.desc ? `<div class="text-[11px] text-gray-500 italic mt-0.5">${i.desc}</div>` : ''}
                        </div>
                        <span class="font-bold text-gray-600 text-sm">$${(i.price * i.qty).toFixed(2)}</span>
                    </div>`;
                    }).join('');
                } else {
                    itemsList.innerHTML = '<p class="text-gray-400 text-center text-sm">Sin artículos registrados</p>';
                }

                // Costs Breakdown
                const costs = order.costs || {};
                const subtotal = costs.subtotal ? `<div class="flex justify-between text-xs text-gray-500 mb-1"><span>Subtotal</span><span>$${parseFloat(costs.subtotal).toFixed(2)}</span></div>` : '';
                const shipping = costs.shipping !== undefined ? `<div class="flex justify-between text-xs text-gray-500 mb-1"><span>Envío</span><span>${costs.shipping === 0 ? 'Gratis' : '$' + parseFloat(costs.shipping).toFixed(2)}</span></div>` : '';
                const tip = costs.tip > 0 ? `<div class="flex justify-between text-xs text-gray-500 mb-1"><span>Propina</span><span>$${parseFloat(costs.tip).toFixed(2)}</span></div>` : '';
                const service = costs.service > 0 ? `<div class="flex justify-between text-xs text-gray-500 mb-1"><span>Otros Cargos</span><span>$${parseFloat(costs.service).toFixed(2)}</span></div>` : '';
                const discount = costs.discount > 0 ? `<div class="flex justify-between text-xs text-red-500 mb-1"><span>Descuento</span><span>-$${parseFloat(costs.discount).toFixed(2)}</span></div>` : '';

                if (itemsList.nextElementSibling) {
                    // CALC GANANCIA NETA
                    let rawTotal = 0;
                    if (typeof order.total === 'string') {
                        rawTotal = parseFloat(order.total.replace(/[^0-9.]/g, ''));
                    } else {
                        rawTotal = parseFloat(order.total || 0);
                    }

                    const pMethod = order.paymentMethod || 'Efectivo';
                    // 5% si Efectivo, 8% si Tarjeta
                    const feePercent = pMethod === 'Efectivo' ? 0.05 : 0.08;
                    const feeAmount = rawTotal * feePercent;

                    // Ganancia = Total - Comision - OtrosCargos (Service Fee es para la plataforma)
                    const serviceFee = parseFloat(costs.service || 0);
                    const profit = rawTotal - feeAmount - serviceFee;

                    itemsList.nextElementSibling.innerHTML = `
                         <div class="pt-2 space-y-1">
                            ${subtotal}
                            ${shipping}
                            ${tip}
                            ${service}
                            ${discount}
                            <div class="flex justify-between items-center pt-2 border-t border-dashed border-gray-200 mt-2">
                                <span class="font-bold text-gray-600">Total Final</span>
                                <span class="font-bold text-xl text-green-600">${order.total || '$0.00'}</span>
                            </div>

                            <!-- GANANCIA BOX -->
                             <div class="mt-3 bg-gray-100 p-2 rounded-lg border border-gray-200">
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>Comisión (${(feePercent * 100).toFixed(0)}%)</span>
                                    <span>-$${feeAmount.toFixed(2)}</span>
                                </div>
                                 <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>Cargos Servicio</span>
                                    <span>-$${serviceFee.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center border-t border-gray-300 pt-1 mt-1">
                                    <span class="font-bold text-xs text-gray-700">Tu Ganancia Neta</span>
                                    <span class="font-bold text-sm text-blue-600 border border-blue-200 bg-blue-50 px-2 rounded">$${profit.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('detail-total').innerText = order.total || '$0.00';
                }

                // Init Single Toggle Button
                updateToggleButton(order.status);

                m.classList.remove('hidden');
            }

            function updateToggleButton(status) {
                const btn = document.getElementById('btn-status-toggle');
                if (!btn) return;

                // Reset classes
                btn.className = "w-full py-4 rounded-xl text-lg font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2";
                btn.disabled = false;

                if (status === 'pending') {
                    btn.classList.add('bg-orange-500', 'text-white', 'hover:bg-orange-600');
                    btn.innerHTML = `<i class="fa-solid fa-fire-burner"></i> Empezar A Cocinar`;
                    btn.dataset.next = 'preparing';
                }
                else if (status === 'preparing') {
                    btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                    btn.innerHTML = `<i class="fa-solid fa-box-open"></i> Marcar Listo`;
                    btn.dataset.next = 'ready';
                }
                else if (status === 'ready') {
                    btn.classList.add('bg-purple-600', 'text-white', 'hover:bg-purple-700');
                    btn.innerHTML = `<i class="fa-solid fa-motorcycle"></i> Enviar Pedido`;
                    btn.dataset.next = 'delivering';
                }
                else if (status === 'delivering') {
                    btn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
                    btn.innerHTML = `<i class="fa-solid fa-check-circle"></i> Finalizar Pedido`;
                    btn.dataset.next = 'completed';
                }
                else if (status === 'completed') {
                    btn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                    btn.innerHTML = `<i class="fa-solid fa-lock"></i> Pedido Completado`;
                    btn.disabled = true;
                    btn.dataset.next = '';
                }
            }

            async function toggleOrderStatus() {
                const btn = document.getElementById('btn-status-toggle');
                const nextStatus = btn.dataset.next;
                if (!nextStatus) return;

                await updateOrderStatus(nextStatus);
            }

            async function updateOrderStatus(newStatus) {
                if (!currentDetailOrder) return;

                if (!currentDetailOrder) return;

                const btn = document.getElementById('btn-status-toggle') || event.target; // Fallback
                const originalContent = btn.innerHTML;
                if (btn.id === 'btn-status-toggle') btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Procesando...';
                else btn.innerText = "...";
                btn.disabled = true;

                try {
                    const res = await fetch(`${API_URL}/api/orders/update-status`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            slug: SESSION.slug,
                            password: SESSION.password,
                            orderId: currentDetailOrder._id,
                            status: newStatus
                        })
                    });

                    if (res.ok) {
                        currentDetailOrder.status = newStatus;
                        // Si se completa y estamos en vista activa, se "borrará" visualmente al refrescar
                        if (newStatus === 'completed' && currentOrderFilter === 'active') {
                            document.getElementById('order-detail-modal').classList.add('hidden');
                        } else {
                            openOrderDetails(currentDetailOrder); // Refresh modal UI
                        }
                        fetchAndRenderOrders(currentOrderFilter); // Refresh list behind
                    } else {
                        alert("Error al actualizar");
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    }
                } catch (e) {
                    alert("Error de conexión");
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            }

            // --- CATEGORY & MENU LOGIC ---

            function renderCategoryTabs() {
                const cats = SESSION.data.config.categories || [];
                // Fallback for old data if needed, but backend ensures defaults
                const container = document.getElementById('product-tabs');

                // Ensure currentCategory is valid
                if (cats.length > 0 && !cats.find(c => c.id === currentCategory)) {
                    currentCategory = cats[0].id;
                }

                container.innerHTML = cats.map(c => `
                    <button onclick="renderMenuGrid('${c.id}')" 
                        class="px-4 py-2 text-sm whitespace-nowrap ${currentCategory === c.id ? 'font-bold text-blue-600 border-b-2 border-blue-600' : 'font-medium text-gray-500 hover:text-gray-800'}">
                        ${c.name}
                    </button>
                `).join('');
            }

            function renderCategoriesList() {
                const container = document.getElementById('categories-list');
                const cats = SESSION.data.config.categories || [];

                if (cats.length === 0) {
                    container.innerHTML = '<p class="text-xs text-center text-gray-400 py-2">Sin categorías</p>';
                    return;
                }

                container.innerHTML = cats.map((c, idx) => `
                    <div class="flex justify-between items-center group bg-gray-50 rounded p-2 hover:bg-gray-100 transition">
                         <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                            <span class="text-xs font-bold text-gray-700">${c.name}</span>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="deleteCategory('${c.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            function openCategoryCreator() {
                document.getElementById('category-creator').classList.remove('hidden');
                document.getElementById('new-cat-name').value = '';
                document.getElementById('new-cat-name').focus();
            }

            function closeCategoryCreator() {
                document.getElementById('category-creator').classList.add('hidden');
            }

            function saveCategory() {
                const name = document.getElementById('new-cat-name').value.trim();
                if (!name) return alert("Escribe un nombre");

                // Generate Slug ID
                const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (!id) return alert("Nombre inválido");

                if (!SESSION.data.config.categories) SESSION.data.config.categories = [];

                // Check dupes
                if (SESSION.data.config.categories.find(c => c.id === id)) return alert(`Ya existe una categoría con este identificador interno: "${id}". Intenta con otro nombre.`);

                SESSION.data.config.categories.push({ id, name, isDefault: false });
                if (!SESSION.data.menu[id]) SESSION.data.menu[id] = [];

                closeCategoryCreator();
                renderCategoriesList();
                renderCategoryTabs();
                saveDataToServer(false);
            }

            function deleteCategory(id) {
                const products = SESSION.data.menu[id] || [];
                const hasProducts = products.length > 0;

                let confirmMsg = `¿Borrar categoría?`;
                if (hasProducts) {
                    confirmMsg += `\n\n⚠️ Esta categoría tiene ${products.length} productos.\nSe moverán automáticamente a otra categoría disponible.`;
                }

                if (confirm(confirmMsg)) {
                    if (hasProducts) {
                        // Find a target (first one that is not the one being deleted)
                        let target = SESSION.data.config.categories.find(c => c.id !== id);

                        // If no other category exists, create a backup "General" one
                        if (!target) {
                            if (!SESSION.data.config.categories) SESSION.data.config.categories = [];
                            const newId = 'general';
                            SESSION.data.config.categories.push({ id: newId, name: 'General', isDefault: false });
                            target = SESSION.data.config.categories.find(c => c.id === newId);
                            if (!SESSION.data.menu[newId]) SESSION.data.menu[newId] = [];
                        }

                        // Move items
                        if (!SESSION.data.menu[target.id]) SESSION.data.menu[target.id] = [];
                        SESSION.data.menu[target.id].push(...products);

                        alert(`Los productos se han movido a la categoría: "${target.name}"`);
                    }

                    // Remove from config
                    SESSION.data.config.categories = SESSION.data.config.categories.filter(c => c.id !== id);

                    // Now safe to delete the key as items are moved (or empty)
                    delete SESSION.data.menu[id];

                    // Reset current view if needed
                    if (SESSION.data.config.categories.length > 0) {
                        if (currentCategory === id) {
                            currentCategory = SESSION.data.config.categories[0].id; // Switch to first available
                        }
                    } else {
                        currentCategory = null;
                    }

                    renderCategoriesList();
                    renderCategoryTabs();
                    if (currentCategory) renderMenuGrid(currentCategory);
                    else document.getElementById('menu-grid').innerHTML = '<div class="text-center text-gray-400">Sin categorías</div>';

                    saveDataToServer(false);
                }
            }

            function renderMenuGrid(cat) {
                currentCategory = cat;
                renderCategoryTabs(); // Re-render to update active state

                if (!SESSION.data.menu || !SESSION.data.menu[cat]) {
                    document.getElementById('menu-grid').innerHTML = '<div class="text-center text-gray-400">Sin productos</div>';
                    return;
                }

                const items = SESSION.data.menu[cat] || [];
                document.getElementById('menu-grid').innerHTML = items.map((item, idx) => `<div class="bg-white border border-gray-100 rounded-xl p-3 flex gap-3 hover:shadow-md transition group"><img src="${item.image || 'https://via.placeholder.com/80'}" class="w-20 h-20 rounded-lg object-cover bg-gray-100"><div class="flex-1 min-w-0"><h4 class="font-bold text-gray-800 truncate">${item.name}</h4><div class="flex justify-between items-center mt-2"><span class="font-bold text-green-600">$${item.price}</span><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="editProduct('${cat}', ${idx})" class="text-blue-500 hover:bg-blue-50 p-1.5 rounded"><i class="fa-solid fa-pen"></i></button><button onclick="deleteProduct('${cat}', ${idx})" class="text-red-500 hover:bg-red-50 p-1.5 rounded"><i class="fa-solid fa-trash"></i></button></div></div></div></div>`).join('');
            }

            function openGroupCreatorAdvanced() {
                document.getElementById('group-creator-advanced').classList.remove('hidden');
                document.getElementById('new-group-name').value = '';
                document.getElementById('new-group-type').value = 'single';
                document.getElementById('new-group-required').value = 'false';
                document.getElementById('new-group-options-list').innerHTML = '';
                addOptionRow();
            }
            function closeGroupCreatorAdvanced() { document.getElementById('group-creator-advanced').classList.add('hidden'); }

            function addOptionRow() {
                const d = document.createElement('div'); d.className = "flex gap-2 mb-2 items-center option-row"; d.innerHTML = `<input type="text" placeholder="Ej: Queso" class="flex-1 text-xs border border-gray-300 rounded p-1.5 option-name"><input type="number" placeholder="$0" class="w-16 text-xs border border-gray-300 rounded p-1.5 option-price" min="0"><button onclick="this.parentElement.remove()" class="text-red-400 px-1"><i class="fa-solid fa-times"></i></button>`; document.getElementById('new-group-options-list').appendChild(d);
            }

            function renderGroups() {
                if (!SESSION.data.menu || !SESSION.data.menu.groups) {
                    document.getElementById('groups-list').innerHTML = `<div class="text-gray-400 text-xs text-center py-2 italic">Sin grupos aún.</div>`;
                    return;
                }

                const groups = SESSION.data.menu.groups;
                if (groups.length === 0) { document.getElementById('groups-list').innerHTML = `<div class="text-gray-400 text-xs text-center py-2 italic">Sin grupos aún.</div>`; return; }
                document.getElementById('groups-list').innerHTML = groups.map((g, idx) => `
                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm relative group">
                    <div class="flex justify-between items-start mb-1">
                        <div><span class="font-bold text-sm text-gray-800">${g.name}</span><div class="text-[10px] text-gray-400">${g.options.length} opciones</div></div>
                        <button onclick="deleteGroup(${idx})" class="text-red-400 hover:text-red-600 p-1 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`).join('');
            }

            function openGroupCreatorAdvanced() {
                console.log("Opening Group Creator V2...");
                const modal = document.getElementById('group-creator-advanced');
                if (!modal) { console.error("Modal not found!"); return; }

                // Force display flex
                modal.style.display = 'flex';
                modal.classList.remove('hidden');

                document.getElementById('new-group-name').value = '';
                document.getElementById('new-group-type').value = 'single';
                document.getElementById('new-group-required').value = 'false';
                document.getElementById('new-group-options-list').innerHTML = '';
                addOptionRow();
            }

            function closeGroupCreatorAdvanced() {
                const modal = document.getElementById('group-creator-advanced');
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }

            function addOptionRow() {
                const d = document.createElement('div');
                d.className = "flex gap-2 mb-2 items-center option-row";
                d.innerHTML = `<input type="text" name="option_name[]" placeholder="Ej: Queso" class="flex-1 text-xs border border-gray-300 rounded p-1.5 option-name"><input type="number" name="option_price[]" placeholder="$0" class="w-16 text-xs border border-gray-300 rounded p-1.5 option-price" min="0"><button onclick="this.parentElement.remove()" class="text-red-400 px-1"><i class="fa-solid fa-times"></i></button>`;
                document.getElementById('new-group-options-list').appendChild(d);
            }

            function saveGroup() {
                const name = document.getElementById('new-group-name').value;
                const type = document.getElementById('new-group-type').value;
                const required = document.getElementById('new-group-required').value === 'true';

                const opts = Array.from(document.querySelectorAll('.option-row')).map(r => ({ name: r.querySelector('.option-name').value, price: parseFloat(r.querySelector('.option-price').value) || 0 })).filter(o => o.name);
                if (!name || opts.length === 0) return alert("Faltan datos");

                if (!SESSION.data.menu.groups) SESSION.data.menu.groups = [];

                SESSION.data.menu.groups.push({
                    id: 'g-' + Date.now(),
                    name,
                    type,
                    required,
                    options: opts
                });
                renderGroups(); closeGroupCreatorAdvanced();
                saveDataToServer(false);
            }

            function deleteGroup(idx) {
                if (confirm("¿Borrar?")) {
                    SESSION.data.menu.groups.splice(idx, 1);
                    renderGroups();
                    saveDataToServer(false);
                }
            }

            function openProductModal(idx = -1) {
                editingIdx = idx;
                document.getElementById('product-modal').classList.remove('hidden');

                // Populate Category Select
                const cats = SESSION.data.config.categories || [];
                const catSelect = document.getElementById('prod-category-select');
                catSelect.innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                // If cats are empty (shouldn't happen if defaults exist), add at least the current one if custom
                if (cats.length === 0) {
                    catSelect.innerHTML = `<option value="${currentCategory}">${currentCategory}</option>`;
                }

                catSelect.value = currentCategory;

                const groupContainer = document.getElementById('prod-group-container');
                const groups = (SESSION.data.menu && SESSION.data.menu.groups) ? SESSION.data.menu.groups : [];

                if (groups.length === 0) {
                    groupContainer.innerHTML = '<p class="text-xs text-gray-500 italic">No tienes grupos de modificadores creados.</p>';
                } else {
                    groupContainer.innerHTML = groups.map(g => `
                    <label class="flex items-center gap-2 mb-1 cursor-pointer">
                        <input type="checkbox" value="${g.id}" class="prod-group-check sr-only peer">
                        <div class="w-4 h-4 border border-gray-300 rounded flex items-center justify-center peer-checked:bg-blue-500 peer-checked:border-blue-500 transition">
                            <i class="fa-solid fa-check text-white text-[10px] hidden peer-checked:block"></i>
                        </div>
                        <span class="text-xs text-gray-700 font-medium">${g.name}</span>
                    </label>
                `).join('');
                }

                if (idx === -1) {
                    ['prod-name', 'prod-desc', 'prod-price', 'prod-original', 'prod-img-url', 'prod-tags'].forEach(i => document.getElementById(i).value = '');
                    document.getElementById('prod-img-preview').src = '';
                    // Clear checks
                    document.querySelectorAll('.prod-group-check').forEach(c => c.checked = false);
                } else {
                    const item = SESSION.data.menu[currentCategory][idx];
                    document.getElementById('prod-name').value = item.name;
                    document.getElementById('prod-desc').value = item.description;
                    document.getElementById('prod-price').value = item.price;
                    document.getElementById('prod-original').value = item.originalPrice || '';
                    document.getElementById('prod-img-url').value = item.image || '';
                    document.getElementById('prod-img-preview').src = item.image || '';
                    document.getElementById('prod-tags').value = (item.tags || []).join(',');

                    // Set checks
                    const currentGroups = item.groups || (item.groupId ? [item.groupId] : []);
                    document.querySelectorAll('.prod-group-check').forEach(c => {
                        c.checked = currentGroups.includes(c.value);
                    });
                }
            }
            function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); }
            function handleImageUpload(i) { if (i.files[0]) { const r = new FileReader(); r.onload = e => { document.getElementById('prod-img-preview').src = e.target.result; document.getElementById('prod-img-url').value = e.target.result; }; r.readAsDataURL(i.files[0]); } }

            function saveProductInternal() {
                const name = document.getElementById('prod-name').value;
                const price = parseFloat(document.getElementById('prod-price').value);
                const targetCat = document.getElementById('prod-category-select').value;

                if (!name || isNaN(price)) return alert("Faltan datos (Nombre o Precio inválido)");

                // Collect Selected Groups
                const selectedGroups = Array.from(document.querySelectorAll('.prod-group-check:checked')).map(c => c.value);

                const item = {
                    id: editingIdx === -1 ? Date.now().toString() : SESSION.data.menu[currentCategory][editingIdx].id,
                    name,
                    description: document.getElementById('prod-desc').value,
                    price,
                    originalPrice: parseFloat(document.getElementById('prod-original').value) || null,
                    image: document.getElementById('prod-img-url').value,
                    tags: document.getElementById('prod-tags').value.split(',').filter(t => t),
                    groups: selectedGroups // Using 'groups' array
                };

                // Remove legacy groupId if it exists to avoid confusion
                if (item.groupId) delete item.groupId;

                if (editingIdx === -1) {
                    // NEW PRODUCT
                    if (!SESSION.data.menu[targetCat]) SESSION.data.menu[targetCat] = [];
                    SESSION.data.menu[targetCat].push(item);
                } else {
                    // EDITING PRODUCT
                    if (targetCat === currentCategory) {
                        // Same Category
                        SESSION.data.menu[currentCategory][editingIdx] = item;
                    } else {
                        // Category Changed -> Move Item
                        SESSION.data.menu[currentCategory].splice(editingIdx, 1);
                        if (!SESSION.data.menu[targetCat]) SESSION.data.menu[targetCat] = [];
                        SESSION.data.menu[targetCat].push(item);
                    }
                }

                closeProductModal();
                // Render the target category if moved, or stay in current?
                // UX decision: if moved, maybe user wants to see it there, but jumping views is jarring.
                // Let's render the Current View. If item moved AWAY, it disappears. If item created in OTHER, it won't show unless we switch.
                // If created in DIFFERENT category, maybe switch to it?
                if (targetCat !== currentCategory) {
                    renderMenuGrid(targetCat);
                } else {
                    renderMenuGrid(currentCategory);
                }
                saveDataToServer(false);
            }

            function deleteProduct(cat, idx) {
                if (confirm("¿Eliminar?")) {
                    SESSION.data.menu[cat].splice(idx, 1);
                    renderMenuGrid(cat);
                    saveDataToServer(false);
                }
            }

            function editProduct(cat, idx) { currentCategory = cat; openProductModal(idx); }

            async function saveDataToServer(showNotifications = true) {
                const btn = document.querySelector('button[onclick="saveChanges()"]');
                let originalText = "";

                if (showNotifications && btn) { originalText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...'; btn.disabled = true; }

                const cfg = { ...SESSION.data.config };
                cfg.name = document.getElementById('conf-name').value;
                cfg.businessType = document.getElementById('conf-type').value;
                cfg.whatsapp = document.getElementById('conf-whatsapp').value;
                cfg.address = document.getElementById('conf-address').value;

                // Shipping Config
                if (!cfg.shipping) cfg.shipping = {};
                cfg.shipping.freeShippingActive = document.getElementById('conf-shipping-free-active').checked;
                cfg.shipping.freeShippingThreshold = parseFloat(document.getElementById('conf-shipping-threshold').value) || 0;
                cfg.shipping.costPerKm = parseFloat(document.getElementById('conf-shipping-cost').value) || 11;

                const latInput = document.getElementById('conf-lat').value;
                const lngInput = document.getElementById('conf-lng').value;
                if (latInput && lngInput) { cfg.coords = { lat: parseFloat(latInput), lng: parseFloat(lngInput) }; }
                cfg.hours = { open: parseInt(document.getElementById('conf-open').value), close: parseInt(document.getElementById('conf-close').value) };
                cfg.prepTime = document.getElementById('conf-prep-time').value;
                cfg.heroImage = document.getElementById('conf-hero').value;
                cfg.logo = document.getElementById('conf-logo').value;
                cfg.isOpen = document.getElementById('conf-is-open').checked;
                cfg.highDemand = document.getElementById('conf-high-demand-active').checked;
                cfg.highDemandTime = document.getElementById('conf-high-demand-time').value;
                // cfg.categoryTitles removed (Dynamic Categories Used)

                // Guardar Datos Bancarios
                cfg.bankDetails = {
                    name: document.getElementById('conf-bank-name').value,
                    clabe: document.getElementById('conf-bank-clabe').value,
                    owner: document.getElementById('conf-bank-owner').value
                };

                SESSION.data.config = cfg;

                try {
                    const res = await fetch(`${API_URL}/api/shop/${SESSION.slug}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: SESSION.password, data: { config: cfg, menu: SESSION.data.menu, promotions: SESSION.data.promotions || [] } }) });
                    if (res.ok) {
                        if (showNotifications && btn) { btn.innerHTML = '<i class="fa-solid fa-check"></i> ¡Listo!'; setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000); }
                        // Re-render tabs just in case config changed (though categories are handled separate)
                        renderCategoryTabs();
                    } else {
                        if (showNotifications && btn) { btn.innerHTML = 'Error'; btn.disabled = false; }
                        alert("Error al guardar en servidor.");
                    }
                } catch (e) {
                    if (showNotifications && btn) { btn.innerHTML = 'Error Red'; btn.disabled = false; }
                    console.error(e);
                }
            }

            function saveChanges() { saveDataToServer(true); }

            async function parseMapLink() {
                const input = document.getElementById('map-link-input').value;
                if (!input) return alert("Ingresa un link de Google Maps");

                const btn = event.target.closest('button');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                btn.disabled = true;

                try {
                    // 1. Intentar obtener datos del servidor
                    const res = await fetch(`${API_URL}/api/utils/parse-map`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ input }) });
                    const data = await res.json();

                    if (data.success) {
                        // Actualizar coordenadas (Hidden fields)
                        document.getElementById('conf-lat').value = data.lat;
                        document.getElementById('conf-lng').value = data.lng;

                        let addressFound = data.address; // La API debería devolver la dirección si logra resolverla

                        // 2. Fallback Cliente: Intentar sacar nombre del lugar del URL si la API falló en eso
                        if (!addressFound && input.includes('/place/')) {
                            try {
                                const parts = input.split('/place/')[1].split('/')[0];
                                addressFound = decodeURIComponent(parts).replace(/\+/g, ' ');
                            } catch (e) { console.log("Parsing fallback failed"); }
                        }

                        // 3. ACTUALIZACIÓN DEL CAMPO DIRECCIÓN
                        if (addressFound) {
                            const addrInput = document.getElementById('conf-address');
                            addrInput.value = addressFound; // <--- ASIGNACIÓN DIRECTA

                            // Efecto visual para confirmar cambio
                            addrInput.classList.add('bg-green-100', 'text-green-800', 'font-bold');
                            setTimeout(() => addrInput.classList.remove('bg-green-100', 'text-green-800', 'font-bold'), 2000);

                            // No mostramos alert de "Dirección sugerida", solo lo hacemos
                            alert("¡Ubicación y dirección actualizadas!");
                        } else {
                            alert("Coordenadas actualizadas. (No se pudo detectar el texto de la dirección, por favor verifícala).");
                        }

                    } else {
                        alert("No se pudieron obtener datos del link.");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error de conexión.");
                }

                btn.innerHTML = original;
                btn.disabled = false;
            }

            function handleHeroUpload(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => { document.getElementById('conf-hero').value = e.target.result; document.getElementById('hero-preview').src = e.target.result; };
                    reader.readAsDataURL(input.files[0]);
                }
            }

            function handleLogoUpload(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => { document.getElementById('conf-logo').value = e.target.result; document.getElementById('logo-preview').src = e.target.result; };
                    reader.readAsDataURL(input.files[0]);
                }
            }

            function renderQR(style) {
                const c = document.getElementById('qr-print-area');
                c.innerHTML = "";
                const qrUrl = `https://iamenu.github.io/menuia/menu.html?slug=${SESSION.slug}`;
                const shopName = SESSION.data.config.name || "Mi Tienda";

                let div = document.createElement('div');

                // 1. BASICO
                if (style === 'simple') {
                    div.className = "bg-white p-6 border flex flex-col items-center justify-center shadow-sm";
                    div.innerHTML = `
                    <div id="qrcode"></div>
                    <p class="mt-4 text-sm font-bold text-gray-800">${shopName}</p>
                `;
                }
                // 2. TARJETA
                else if (style === 'card') {
                    div.className = "bg-white p-6 border-4 border-blue-500 rounded-[20px] flex flex-col items-center shadow-lg relative overflow-hidden w-64";
                    div.innerHTML = `
                    <div class="absolute top-0 left-0 w-full h-4 bg-blue-500"></div>
                    <h3 class="text-lg font-bold text-blue-600 mb-4">Menú Digital</h3>
                    <div id="qrcode"></div>
                    <p class="mt-4 text-xs font-bold text-gray-500 uppercase tracking-widest">${shopName}</p>
                    <div class="absolute bottom-0 left-0 w-full h-2 bg-blue-200"></div>
                `;
                }
                // 3. POSTER
                else if (style === 'poster') {
                    div.className = "bg-gray-900 p-8 rounded-lg flex flex-col items-center shadow-2xl w-72 text-center";
                    div.innerHTML = `
                    <div class="mb-6 text-2xl font-bold text-yellow-400 font-serif border-b-2 border-yellow-400 pb-2">${shopName}</div>
                    <div class="bg-white p-3 rounded-lg shadow-black/50 shadow-lg">
                        <div id="qrcode"></div>
                    </div>
                    <p class="mt-6 text-sm text-gray-300">Escanea para ver nuestro menú</p>
                `;
                }
                // 4. STAND MESA
                else if (style === 'stand') {
                    div.className = "bg-white p-8 border-2 border-gray-200 rounded-t-3xl shadow-xl w-64 text-center relative";
                    div.style.borderBottom = "10px solid #f97316";
                    div.innerHTML = `
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600">
                        <i class="fa-solid fa-utensils text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 leading-none mb-1">¡Ordena Aquí!</h3>
                    <p class="text-xs text-gray-400 mb-4">Sin filas, sin espera</p>
                    <div id="qrcode" class="mx-auto"></div>
                    <p class="mt-4 text-[10px] uppercase font-bold text-gray-400 tracking-widest">${shopName}</p>
                `;
                }
                // 5. INSTAGRAM STORY
                else if (style === 'story') {
                    div.className = "bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 p-8 flex flex-col items-center justify-center w-[300px] h-[533px] shadow-2xl relative text-white";
                    div.innerHTML = `
                    <div class="absolute top-10 left-0 w-full text-center">
                        <h2 class="text-3xl font-bold italic tracking-tighter">NUEVO MENÚ</h2>
                        <p class="text-sm font-medium opacity-90">¡Checa lo que tenemos!</p>
                    </div>
                    
                    <div class="bg-white/20 backdrop-blur-md p-6 rounded-3xl border border-white/30 shadow-2xl">
                        <div class="bg-white p-2 rounded-xl">
                            <div id="qrcode"></div>
                        </div>
                    </div>

                    <div class="absolute bottom-12 flex flex-col items-center animate-bounce">
                        <p class="mb-2 text-sm font-bold">Escanea o haz swipe up</p>
                        <i class="fa-solid fa-chevron-up"></i>
                    </div>
                `;
                }
                // 6. ELEGANTE
                else if (style === 'elegant') {
                    div.className = "bg-black p-8 border border-yellow-600/50 flex flex-col items-center shadow-2xl w-72 text-center relative";
                    div.innerHTML = `
                    <div class="absolute inset-0 border-[6px] border-double border-yellow-700/30 m-2 pointer-events-none"></div>
                    <h3 class="text-2xl font-serif text-yellow-500 mb-6 tracking-widest uppercase">${shopName}</h3>
                    <div class="p-1 bg-gradient-to-tr from-yellow-700 to-yellow-200 rounded">
                        <div class="bg-white p-3">
                            <div id="qrcode"></div>
                        </div>
                    </div>
                    <p class="mt-6 text-xs text-yellow-600 font-serif italic">Una experiencia gastronómica</p>
                `;
                }

                c.appendChild(div);

                // Generate QR
                // Using different sizes/colors based on style? For now standard is fine, colors handled by CSS container or QRCode options
                let colorDark = "#000000";
                if (style === 'elegant') colorDark = "#000000"; // QR itself black is best contrast usually

                new QRCode(div.querySelector("#qrcode"), {
                    text: qrUrl,
                    width: 150,
                    height: 150,
                    colorDark: colorDark,
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }


            function logout() { localStorage.removeItem('shop_pass'); location.reload(); }

            // --- FUNCIONES AI (REALES) ---

            // 1. Generador de Descripción
            async function generateAIDesc() {
                const name = document.getElementById('prod-name').value;
                if (!name) return alert("Por favor escribe el nombre del producto primero.");

                const btn = event.target.closest('button');
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Pensando...';
                btn.disabled = true;

                try {
                    const res = await fetch(`${API_URL}/api/ai/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            slug: SESSION.slug,
                            task: 'product_description',
                            context: { productName: name }
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        document.getElementById('prod-desc').value = data.result;
                    } else {
                        alert("Error IA: " + (data.error || "No se pudo generar"));
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error de conexión con el servicio de IA.");
                }

                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }

            // 2. Generador de Insights Dashboard
            async function refreshAIInsight() {
                const textEl = document.getElementById('ai-insight-text');
                textEl.style.opacity = 0.5;
                textEl.innerText = "Consultando a la IA...";

                try {
                    const res = await fetch(`${API_URL}/api/ai/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            slug: SESSION.slug,
                            task: 'business_insight',
                            context: {
                                stats: SESSION.data.stats,
                                businessType: SESSION.data.config.businessType
                            }
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        textEl.innerText = `"${data.result}"`;
                    } else {
                        textEl.innerText = "No pudimos obtener un consejo ahora.";
                    }
                } catch (e) {
                    textEl.innerText = "Error de conexión.";
                }
                textEl.style.opacity = 1;
            }

            // 3. Generador de Redes Sociales
            async function generateSocialPost(type) {
                const shopName = SESSION.data.config.name || "Nuestro Restaurante";
                const textarea = document.getElementById('ai-social-result');
                textarea.value = "Generando copy creativo...";

                let style = "estándar";
                if (type === 'promo') style = "promocional y urgente";
                if (type === 'engaging') style = "conversacional y viral para generar comentarios";
                if (type === 'funny') style = "divertido, con humor y memes";

                try {
                    const res = await fetch(`${API_URL}/api/ai/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            slug: SESSION.slug,
                            task: 'social_post',
                            context: {
                                shopName: shopName,
                                platform: 'Instagram/Facebook',
                                style: style
                            }
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        textarea.value = data.result;
                    } else {
                        textarea.value = "Error generando post.";
                    }
                } catch (e) {
                    textarea.value = "Error de conexión.";
                }
            }

            function copyToClipboard(id) {
                const copyText = document.getElementById(id);
                copyText.select();
                document.execCommand("copy");
                alert("¡Texto copiado! Listo para pegar en Instagram/Facebook.");
            }

            // 4. Optimizar Horario (Real)
            async function optimizeHoursAI() {
                const btn = event.target.closest('button');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                try {
                    const res = await fetch(`${API_URL}/api/ai/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            slug: SESSION.slug,
                            task: 'optimize_hours',
                            context: { businessType: SESSION.data.config.businessType }
                        })
                    });
                    const data = await res.json();

                    if (data.success && data.result) {
                        alert(`🤖 Análisis de IA completado:\n\nSugerimos abrir a las ${data.result.open}:00 y cerrar a las ${data.result.close}:00.`);
                        document.getElementById('conf-open').value = data.result.open;
                        document.getElementById('conf-close').value = data.result.close;
                    } else {
                        alert("No se pudo optimizar el horario.");
                    }
                } catch (e) {
                    alert("Error de conexión IA.");
                }
                btn.innerHTML = original;
            }

            // --- MAP LOGIC ---
            let mapPicker = null;
            let markerPicker = null;
            let tempCoords = null;

            function openMapModal() {
                document.getElementById('map-modal').classList.remove('hidden');

                // Delay map init to ensure container is visible
                setTimeout(() => {
                    if (!mapPicker) {
                        // Default to Mexico City Center or current saved
                        const lat = parseFloat(document.getElementById('conf-lat').value) || 19.4326;
                        const lng = parseFloat(document.getElementById('conf-lng').value) || -99.1332;

                        mapPicker = L.map('map-picker').setView([lat, lng], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(mapPicker);

                        markerPicker = L.marker([lat, lng], { draggable: true }).addTo(mapPicker);

                        markerPicker.on('dragend', function (e) {
                            const pos = e.target.getLatLng();
                            updateMapInfo(pos.lat, pos.lng);
                        });

                        // Initial Info
                        updateMapInfo(lat, lng);
                    } else {
                        // Just reset view if already exists
                        mapPicker.invalidateSize();
                        const lat = parseFloat(document.getElementById('conf-lat').value) || 19.4326;
                        const lng = parseFloat(document.getElementById('conf-lng').value) || -99.1332;
                        markerPicker.setLatLng([lat, lng]);
                        mapPicker.setView([lat, lng], 15);
                        updateMapInfo(lat, lng);
                    }
                }, 300);
            }

            function closeMapModal() {
                document.getElementById('map-modal').classList.add('hidden');
            }

            async function updateMapInfo(lat, lng) {
                tempCoords = { lat, lng };
                document.getElementById('map-lat').innerText = lat.toFixed(5);
                document.getElementById('map-lng').innerText = lng.toFixed(5);
                document.getElementById('map-selected-address').innerText = "Cargando dirección...";

                // Reverse Geocode (Backend Proxy to avoid CORS)
                try {
                    const res = await fetch(`${API_URL}/api/utils/reverse-geocode`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lat, lng })
                    });
                    const data = await res.json();
                    if (data.success && data.address) {
                        tempCoords.address = data.address;
                        document.getElementById('map-selected-address').innerText = data.address.split(',').slice(0, 3).join(',');
                    } else {
                        document.getElementById('map-selected-address').innerText = "Dirección no encontrada";
                    }
                } catch (e) {
                    console.error(e);
                    document.getElementById('map-selected-address').innerText = "Error de conexión";
                }
            }

            function detectAdminLocation() {
                const btn = event.target.closest('button');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i>';

                if (!navigator.geolocation) {
                    alert("Tu navegador no soporta geolocalización.");
                    btn.innerHTML = original;
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;

                        if (mapPicker && markerPicker) {
                            mapPicker.setView([lat, lng], 17);
                            markerPicker.setLatLng([lat, lng]);
                            updateMapInfo(lat, lng);
                        }
                        btn.innerHTML = original;
                    },
                    (err) => {
                        console.error(err);
                        let msg = "No pudimos detectar tu ubicación.";
                        if (err.code === 1) msg = "Permiso denegado. Habilita la ubicación en tu navegador.";
                        alert(msg);
                        btn.innerHTML = original;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }

            function confirmMapLocation() {
                if (!tempCoords) return closeMapModal();

                document.getElementById('conf-lat').value = tempCoords.lat;
                document.getElementById('conf-lng').value = tempCoords.lng;

                // Auto-fill address if we have it
                if (tempCoords.address) {
                    const addrInput = document.getElementById('conf-address');
                    // Only overwrite if requested or empty? Let's overwrite and flash
                    addrInput.value = tempCoords.address;
                    addrInput.classList.add('bg-green-100', 'text-green-800');
                    setTimeout(() => addrInput.classList.remove('bg-green-100', 'text-green-800'), 2000);
                }

                // Update UI feedback
                const feedback = document.getElementById('location-coords-text');
                feedback.innerHTML = `<span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i> Ubicación fijada:</span> ${tempCoords.lat.toFixed(4)}, ${tempCoords.lng.toFixed(4)}`;

                closeMapModal();
            }


            // --- NEW GROUP CREATOR LOGIC (CLEAN) ---
            function openNewGroupModal() {
                console.log("OPENING NEW MODAL");
                const modal = document.getElementById('new-group-modal');
                if (modal) modal.classList.remove('hidden');

                // Clear fields
                document.getElementById('ng-name').value = '';
                document.getElementById('ng-options-list').innerHTML = '';
                onAddNewOption();
                onAddNewOption();
            }

            function onCloseGroupModal() {
                document.getElementById('new-group-modal').classList.add('hidden');
            }

            function onAddNewOption() {
                const div = document.createElement('div');
                div.className = "flex gap-2 items-center mb-2 animate-fade-in";
                div.innerHTML = `
                    <input type="text" placeholder="Opción" class="ng-opt-name w-full border border-gray-300 rounded p-1.5 text-xs outline-none focus:border-indigo-500">
                    <input type="number" placeholder="$0" class="ng-opt-price w-20 border border-gray-300 rounded p-1.5 text-xs outline-none focus:border-indigo-500">
                    <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 transition"><i class="fa-solid fa-times"></i></button>
                `;
                document.getElementById('ng-options-list').appendChild(div);
            }

            function onSaveNewGroup() {
                const name = document.getElementById('ng-name').value;
                if (!name) return alert("Escribe un nombre para el grupo.");

                const type = document.getElementById('ng-type').value;
                const required = document.getElementById('ng-required').value === 'true';

                const options = [];
                document.querySelectorAll('#ng-options-list > div').forEach(div => {
                    const n = div.querySelector('.ng-opt-name').value;
                    const p = div.querySelector('.ng-opt-price').value;
                    if (n.trim()) options.push({ name: n.trim(), price: parseFloat(p) || 0 });
                });

                if (options.length === 0) return alert("Agrega al menos una opción válida.");

                const group = {
                    id: 'g-' + Date.now(),
                    name: name,
                    type: type,
                    required: required,
                    options: options
                };

                if (!SESSION.data.menu.groups) SESSION.data.menu.groups = [];
                SESSION.data.menu.groups.push(group);

                saveDataToServer(false);
                onCloseGroupModal();
                alert("Grupo creado con éxito");
                onRenderGroupList(); // Refresh list
            }

            function onRenderGroupList() {
                // Alias to the old render function if we want to reuse the container, 
                // or implement our own. Let's reuse the container 'groups-list'.
                const container = document.getElementById('groups-list');
                if (!container) return;

                const groups = SESSION.data.menu.groups || [];
                if (groups.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">Sin grupos creados</p>';
                    return;
                }

                container.innerHTML = groups.map((g, idx) => `
                    <div class="bg-gray-50 hover:bg-white p-2.5 rounded-lg border border-gray-200 flex justify-between items-center group mb-2 transition shadow-sm">
                        <div>
                            <p class="text-xs font-bold text-gray-700">${g.name}</p>
                            <p class="text-[10px] text-gray-400">${g.options.length} opciones (${g.type === 'single' ? '1 sel' : 'Multi'})</p>
                        </div>
                        <button onclick="onDeleteGroup(${idx})" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition p-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                 `).join('');
            }

            // Expose globally so saving elsewhere works if needed, or call it from main init
            window.renderGroups = onRenderGroupList;

            function onDeleteGroup(idx) {
                if (confirm("¿Eliminar este grupo?")) {
                    SESSION.data.menu.groups.splice(idx, 1);
                    saveDataToServer(false);
                    onRenderGroupList();
                }
            }


            // --- PROMOTIONS LOGIC ---
            let currentPromoType = null;
            let currentPromoImage = null; // Store base64 image

            function handlePromoImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        currentPromoImage = e.target.result;
                        // Preview?
                        const preview = document.getElementById('promo-img-preview');
                        if (preview) {
                            preview.src = currentPromoImage;
                            preview.classList.remove('hidden');
                        }
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }

            function renderPromoTab() {
                renderActivePromos();
                setPromoType(currentPromoType || 'discount');
            }

            function setPromoType(type) {
                currentPromoType = type;
                currentPromoImage = null; // Reset image

                // UI Updates
                document.querySelectorAll('.promo-type-btn').forEach(btn => {
                    const isSelected = btn.id === `btn-promo-${type}`;
                    if (isSelected) btn.className = "promo-type-btn p-2 rounded-lg border border-blue-600 bg-blue-50 text-blue-700 text-xs font-bold transition text-center ring-2 ring-blue-200";
                    else btn.className = "promo-type-btn p-2 rounded-lg border border-gray-200 text-xs font-bold hover:bg-blue-50 hover:border-blue-200 transition text-center";
                });

                const container = document.getElementById('promo-form-container');
                container.innerHTML = getPromoFormHtml(type);
                document.getElementById('promo-actions').classList.remove('hidden');

                // Populate Item Selectors if any
                const itemSelects = container.querySelectorAll('.item-selector');
                if (itemSelects.length > 0) {
                    const items = [];
                    if (SESSION.data.menu) {
                        // Use dynamic categories if available, else fallback
                        const cats = SESSION.data.config.categories || [];
                        const catIds = cats.length > 0 ? cats.map(c => c.id) : ['clasicos', 'especiales', 'extras'];

                        catIds.forEach(cat => {
                            if (SESSION.data.menu[cat]) {
                                SESSION.data.menu[cat].forEach(i => items.push({ name: i.name, cat: cat }));
                            }
                        });
                    }
                    const opts = '<option value="">-- Seleccionar --</option>' + items.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
                    itemSelects.forEach(s => s.innerHTML = opts);
                }
            }

            function getPromoFormHtml(type) {
                if (type === 'discount') {
                    return `
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Producto</label><select id="promo-item" class="item-selector w-full text-sm border p-2 rounded"></select></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase">Precio Original</label><input type="number" id="promo-original-price" class="w-full text-sm border p-2 rounded" placeholder="$0.00"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase">Precio Oferta</label><input type="number" id="promo-price" class="w-full text-sm border p-2 rounded font-bold text-green-600" placeholder="$0.00"></div>
                    </div>
                `;
                }
                if (type === '2x1') {
                    return `
                    <div class="bg-blue-50 p-2 rounded text-xs text-blue-700 font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-info-circle"></i> Paga 1 y lleva 2</div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Producto (Aplica 2x1)</label><select id="promo-item" class="item-selector w-full text-sm border p-2 rounded"></select></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Precio del Pack (2 unidades)</label><input type="number" id="promo-price" class="w-full text-sm border p-2 rounded" placeholder="Generalmente el precio de 1"></div>
                    <div class="mt-2 text-center">
                         <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Imagen Promocional (Opcional)</label>
                         <input type="file" accept="image/*" onchange="handlePromoImage(this)" class="text-xs">
                         <img id="promo-img-preview" src="" class="hidden w-full h-32 object-cover rounded mt-2 border">
                    </div>
                `;
                }
                if (type === 'combo') {
                    return `
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Nombre del Combo</label><input type="text" id="promo-title" class="w-full text-sm border p-2 rounded font-bold" placeholder="Ej: Paquete Pareja"></div>
                     <div><label class="text-[10px] font-bold text-gray-400 uppercase">Descripción (Qué incluye)</label><textarea id="promo-desc" class="w-full text-sm border p-2 rounded" placeholder="Ej: 2 Hamburguesas + 2 Refrescos"></textarea></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Precio Combo</label><input type="number" id="promo-price" class="w-full text-sm border p-2 rounded font-bold text-green-600" placeholder="$0.00"></div>
                    <div class="mt-2 text-center">
                         <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Imagen Promocional (Opcional)</label>
                         <input type="file" accept="image/*" onchange="handlePromoImage(this)" class="text-xs">
                         <img id="promo-img-preview" src="" class="hidden w-full h-32 object-cover rounded mt-2 border">
                    </div>
                `;
                }
                if (type === 'flash') {
                    return `
                     <div><label class="text-[10px] font-bold text-gray-400 uppercase">Producto</label><select id="promo-item" class="item-selector w-full text-sm border p-2 rounded"></select></div>
                     <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase">Precio Oferta</label><input type="number" id="promo-price" class="w-full text-sm border p-2 rounded font-bold text-green-600" placeholder="$0.00"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase">Duración (Horas)</label><input type="number" id="promo-duration" class="w-full text-sm border p-2 rounded" value="24"></div>
                    </div>
                    <div class="bg-yellow-50 p-2 rounded text-xs text-yellow-700 mt-2 font-bold"><i class="fa-solid fa-bolt"></i> Se mostrará con cuenta regresiva.</div>
                    <div class="mt-2 text-center">
                         <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Imagen Promocional (Opcional)</label>
                         <input type="file" accept="image/*" onchange="handlePromoImage(this)" class="text-xs">
                         <img id="promo-img-preview" src="" class="hidden w-full h-32 object-cover rounded mt-2 border">
                    </div>
                `;
                }
                if (type === 'gift') {
                    return `
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Si compra...</label><select id="promo-item-buy" class="item-selector w-full text-sm border p-2 rounded"></select></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Se lleva GRATIS...</label><input type="text" id="promo-gift-item" class="w-full text-sm border p-2 rounded" placeholder="Ej: Refresco Chico"></div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase">Precio Referencia / Paquete ($)</label><input type="number" id="promo-price" class="w-full text-sm border p-2 rounded font-bold text-green-600" placeholder="$0.00"></div>
                    <div class="mt-2 text-center">
                         <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Imagen Promocional (Opcional)</label>
                         <input type="file" accept="image/*" onchange="handlePromoImage(this)" class="text-xs">
                         <img id="promo-img-preview" src="" class="hidden w-full h-32 object-cover rounded mt-2 border">
                    </div>
                `;
                }
                return '';
            }

            function savePromo() {
                if (!currentPromoType) return;
                // Basic extraction
                const promo = {
                    id: 'p-' + Date.now(),
                    type: currentPromoType,
                    active: true,
                    createdAt: new Date(),
                    image: currentPromoImage // Save the image
                };

                // Field extraction based on type
                if (currentPromoType === 'discount') {
                    promo.item = document.getElementById('promo-item').value;
                    promo.originalPrice = document.getElementById('promo-original-price').value;
                    promo.price = document.getElementById('promo-price').value;
                    if (!promo.item || !promo.price) return alert("Faltan datos");
                    promo.title = `Oferta: ${promo.item}`;
                    promo.desc = `Antes $${promo.originalPrice}`;
                }
                else if (currentPromoType === '2x1') {
                    promo.item = document.getElementById('promo-item').value;
                    promo.price = document.getElementById('promo-price').value;
                    if (!promo.item || !promo.price) return alert("Faltan datos");
                    promo.title = `2x1 en ${promo.item}`;
                    promo.desc = "Llévate 2 por el precio de 1";
                }
                else if (currentPromoType === 'combo') {
                    promo.title = document.getElementById('promo-title').value;
                    promo.desc = document.getElementById('promo-desc').value;
                    promo.price = document.getElementById('promo-price').value;
                    if (!promo.title || !promo.price) return alert("Faltan datos");
                }
                else if (currentPromoType === 'flash') {
                    promo.item = document.getElementById('promo-item').value;
                    promo.price = document.getElementById('promo-price').value;
                    promo.duration = document.getElementById('promo-duration').value;
                    if (!promo.item || !promo.price) return alert("Faltan datos");
                    promo.title = `⚡ Oferta Flash: ${promo.item}`;
                    promo.expiresAt = moment().add(parseInt(promo.duration), 'hours').toISOString();
                }
                else if (currentPromoType === 'gift') {
                    promo.buyItem = document.getElementById('promo-item-buy').value;
                    promo.giftItem = document.getElementById('promo-gift-item').value;
                    promo.price = document.getElementById('promo-price').value;
                    if (!promo.buyItem || !promo.giftItem) return alert("Faltan datos");
                    promo.title = `Compra ${promo.buyItem} y recibe regalo`;
                    promo.desc = `Gratis: ${promo.giftItem}`;
                }

                if (!SESSION.data.promotions) SESSION.data.promotions = [];
                SESSION.data.promotions.push(promo);

                renderActivePromos();
                saveDataToServer(false); // Silent save
                alert("¡Promoción Guardada!");

                // Reset form
                setPromoType(currentPromoType);
            }

            function renderActivePromos() {
                const list = document.getElementById('active-promos-list');
                const promos = SESSION.data.promotions || [];

                if (promos.length === 0) {
                    list.innerHTML = `<p class="text-sm text-gray-400 text-center py-8">No tienes promociones activas.</p>`;
                    return;
                }

                list.innerHTML = promos.map((p, idx) => {
                    let icon = 'fa-tag';
                    let color = 'bg-blue-100 text-blue-600';
                    if (p.type === '2x1') { icon = 'fa-user-group'; color = 'bg-purple-100 text-purple-600'; }
                    if (p.type === 'flash') { icon = 'fa-bolt'; color = 'bg-yellow-100 text-yellow-600'; }
                    if (p.type === 'combo') { icon = 'fa-burger'; color = 'bg-orange-100 text-orange-600'; }
                    if (p.type === 'gift') { icon = 'fa-gift'; color = 'bg-pink-100 text-pink-600'; }

                    return `
                    <div class="bg-white border border-gray-100 rounded-xl p-3 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${color} flex items-center justify-center font-bold text-sm">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">${p.title}</h4>
                                <p class="text-xs text-gray-400">${p.desc || (p.price ? '$' + p.price : '')}</p>
                            </div>
                        </div>
                        <button onclick="deletePromo(${idx})" class="text-red-400 hover:text-red-600 p-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                }).join('');
            }

            function deletePromo(idx) {
                if (confirm("¿Borrar promoción?")) {
                    SESSION.data.promotions.splice(idx, 1);
                    renderActivePromos();
                    saveDataToServer(false);
                }
            }





            // --- FINANCES VIEW LOGIC ---
            function renderFinances() {
                const tbody = document.getElementById('finances-table-body');
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Calculando...</td></tr>';

                // Week Range (Mon-Sun)
                const startOfWeek = moment().startOf('isoWeek');
                const endOfWeek = moment().endOf('isoWeek');

                // Filter orders inside range
                const weekOrders = ordersHistory.filter(o => {
                    const d = moment(o.createdAt);
                    return d.isBetween(startOfWeek, endOfWeek, null, '[]') && o.status !== 'cancelled';
                });

                let totalProfit = 0;
                let cashReceived = 0;
                let balance = 0; // (Net Card Income) - (Cash Liabilities) OR (Total Profit) - (Cash Received)

                let rowsHtml = '';

                if (weekOrders.length === 0) {
                    rowsHtml = '<tr><td colspan="5" class="p-8 text-center text-gray-400">No hay ventas registradas esta semana.</td></tr>';
                } else {
                    rowsHtml = weekOrders.map(o => {
                        // Logic must match openOrderDetails
                        let rawTotal = 0;
                        if (typeof o.total === 'string') {
                            rawTotal = parseFloat(o.total.replace(/[^0-9.]/g, ''));
                        } else {
                            rawTotal = parseFloat(o.total || 0);
                        }

                        const pMethod = o.paymentMethod || 'Efectivo';
                        const feePercent = pMethod === 'Efectivo' ? 0.05 : 0.08;
                        const feeAmount = rawTotal * feePercent;
                        const serviceFee = parseFloat(o.costs?.service || 0);
                        const discount = parseFloat(o.costs?.discount || 0);

                        // Net Profit = Total - Commission - ServiceFee
                        const netProfit = rawTotal - feeAmount - serviceFee;

                        // Accumulators
                        totalProfit += netProfit;

                        if (pMethod === 'Efectivo') {
                            cashReceived += rawTotal;
                        }

                        return `
                             <tr class="hover:bg-gray-50 transition border-b border-gray-100 last:border-0">
                                <td class="p-4 font-bold text-gray-700">#${o.dailyId}</td>
                                <td class="p-4 text-gray-500">${moment(o.createdAt).format('ddd D HH:mm')}</td>
                                <td class="p-4 font-bold text-gray-800">$${rawTotal.toFixed(2)}</td>
                                <td class="p-4">
                                    <span class="text-xs font-bold px-2 py-1 rounded-full ${pMethod === 'Efectivo' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                        ${pMethod}
                                    </span>
                                </td>
                                <td class="p-4 font-bold text-emerald-600">$${netProfit.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('');
                }

                balance = totalProfit - cashReceived;

                // Update DOM
                document.getElementById('fin-total-profit').innerText = `$${totalProfit.toFixed(2)}`;
                document.getElementById('fin-cash-received').innerText = `$${cashReceived.toFixed(2)}`;

                const balEl = document.getElementById('fin-balance');
                balEl.innerText = `$${balance.toFixed(2)}`;
                if (balance >= 0) {
                    balEl.className = "text-2xl font-bold text-blue-600"; // A favor restaurante
                } else {
                    balEl.className = "text-2xl font-bold text-red-500"; // Debe a plataforma
                }

                tbody.innerHTML = rowsHtml;
            }
        </script>
        <!-- GROUP CREATOR MODAL (MOVED) -->
        <!-- NEW GROUP CREATOR MODAL -->
        <div id="new-group-modal"
            class="hidden fixed inset-0 z-[99999] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-xl w-full max-w-md shadow-2xl overflow-hidden animate-fade-in-up">
                <div
                    class="bg-indigo-600 px-6 py-4 border-b border-indigo-500 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg"><i class="fa-solid fa-layer-group mr-2"></i> Nuevo Grupo</h3>
                    <button onclick="onCloseGroupModal()" class="hover:bg-indigo-700 p-1 rounded"><i
                            class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">Nombre del Grupo</label>
                        <input type="text" id="ng-name"
                            class="w-full border border-gray-300 rounded p-2 text-sm outline-none focus:border-indigo-500"
                            placeholder="Ej: Salsas, Extras...">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Tipo</label>
                            <select id="ng-type"
                                class="w-full border border-gray-300 rounded p-2 text-sm outline-none bg-white">
                                <option value="single">Selección Única</option>
                                <option value="multiple">Selección Múltiple</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">Requerido</label>
                            <select id="ng-required"
                                class="w-full border border-gray-300 rounded p-2 text-sm outline-none bg-white">
                                <option value="false">Opcional</option>
                                <option value="true">Obligatorio</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-gray-700">Opciones</label>
                            <button onclick="onAddNewOption()"
                                class="text-xs text-indigo-600 font-bold hover:underline">+ Agregar Opción</button>
                        </div>
                        <div id="ng-options-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                            <!-- Dynamic -->
                        </div>
                    </div>
                    <button onclick="onSaveNewGroup()"
                        class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition shadow-lg">Guardar
                        Grupo</button>
                </div>
            </div>
        </div>

        <script>
            // PWA SERVICE WORKER REGISTRATION (Admin)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(console.error);
            }

            // ADMIN PWA INSTALL LOGIC
            let deferredAdminPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log("📲 Admin App is installable! Event fired.");
                e.preventDefault();
                deferredAdminPrompt = e;
            });

            async function installAdminPWA() {
                if (deferredAdminPrompt) {
                    deferredAdminPrompt.prompt();
                    const { outcome } = await deferredAdminPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredAdminPrompt = null;
                } else {
                    alert("📲 Para instalar el Panel:\n\n1. Toca el menú de opciones (3 puntos).\n2. Selecciona 'Instalar aplicación' o 'Agregar a pantalla principal'.");
                }
            }

            // HIDE BUTTON IF INSTALLED
            function checkAdminInstalledState() {
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                    console.log("✅ Admin App is installed");
                    const btn = document.getElementById('pwa-install-btn-admin');
                    if (btn) btn.style.display = 'none';
                }
            }
            window.addEventListener('load', checkAdminInstalledState);
            window.addEventListener('appinstalled', () => {
                console.log("🎉 Admin App Installed!");
                const btn = document.getElementById('pwa-install-btn-admin');
                if (btn) btn.style.display = 'none';
            });
        </script>
</body>

</html>
```