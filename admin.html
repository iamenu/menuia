<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gesti칩n de Negocio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SOCKET.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- QR CODE LIBRARY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- MOMENT JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/es.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .fade-enter { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .nav-item.active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        .input-field { @apply w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition; }
        
        /* Filtros Monitor */
        .filter-btn { transition: all 0.2s; }
        .filter-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; }
        }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <!-- LOGIN / REGISTER SCREEN -->
    <div id="auth-container" class="fixed inset-0 z-50 bg-gray-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl h-[600px] rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row fade-enter">
            <!-- Left Side: Image/Brand -->
            <div class="md:w-1/2 bg-gradient-to-br from-blue-600 to-indigo-700 p-8 flex flex-col justify-center items-center text-white text-center relative overflow-hidden">
                <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/food.png')]"></div>
                <div class="relative z-10">
                    <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-4xl mb-6 mx-auto shadow-lg">游</div>
                    <h1 class="text-3xl font-bold mb-2">Tu Negocio Digital</h1>
                    <p class="text-blue-100">Gestiona tu men칰, recibe pedidos y crece sin l칤mites.</p>
                </div>
            </div>

            <!-- Right Side: Forms -->
            <div class="md:w-1/2 p-8 md:p-12 relative bg-white flex flex-col">
                <div class="flex border-b mb-8">
                    <button onclick="switchTab('login')" id="tab-login" class="flex-1 pb-3 text-center font-semibold text-blue-600 border-b-2 border-blue-600 transition">Ingresar</button>
                    <button onclick="switchTab('register')" id="tab-register" class="flex-1 pb-3 text-center font-semibold text-gray-400 hover:text-gray-600 transition">Registrarse</button>
                </div>

                <form id="form-login" class="space-y-5 flex-1 flex flex-col justify-center" onsubmit="event.preventDefault(); handleLogin();">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link de tu Tienda</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-link"></i></span>
                            <input type="text" id="login-slug" placeholder="Ej: miburger" class="w-full pl-9 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contrase침a</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-lock"></i></span>
                            <input type="password" id="login-pass" class="w-full pl-9 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 transition transform hover:-translate-y-0.5">
                        Iniciar Sesi칩n
                    </button>
                </form>

                <form id="form-register" class="space-y-4 hidden overflow-y-auto h-full pr-2" onsubmit="event.preventDefault(); handleRegister();">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="reg-slug" placeholder="Link 칰nico (ej: tacospepe)" class="col-span-2 w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" required pattern="[a-zA-Z0-9-_]+">
                        <input type="text" id="reg-name" placeholder="Nombre Negocio" class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                        <select id="reg-type" class="w-full p-2.5 border border-gray-300 rounded-lg outline-none bg-white">
                            <option value="Comida General">Giro General</option>
                            <option value="Sushi">Sushi</option>
                            <option value="Tacos">Tacos</option>
                            <option value="Pizza">Pizza</option>
                            <option value="Hamburguesas">Burgers</option>
                        </select>
                        <input type="password" id="reg-pass" placeholder="Contrase침a" class="col-span-2 w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                    </div>
                    <div class="space-y-3 pt-2">
                        <p class="text-xs font-bold text-gray-400 uppercase">Datos de Contacto</p>
                        <input type="text" id="reg-owner" placeholder="Tu Nombre" class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                        <input type="tel" id="reg-phone" placeholder="Tel칠fono" class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                        <input type="tel" id="reg-whatsapp" placeholder="WhatsApp (Obligatorio)" class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                        <input type="text" id="reg-address" placeholder="Direcci칩n del Negocio" class="w-full p-2.5 border border-gray-300 rounded-lg outline-none" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-500/30 mt-2">
                        Crear Cuenta Gratis
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="dashboard-container" class="hidden flex h-full bg-gray-100">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-20">
            <div class="h-16 flex items-center px-6 border-b border-gray-100">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold mr-3">M</div>
                <span class="font-bold text-lg tracking-tight">Men칰<span class="text-blue-600">IA</span></span>
            </div>
            
            <nav class="flex-1 py-6 px-3 space-y-1">
                <button onclick="switchView('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition active">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> Resumen
                </button>
                <button onclick="switchView('orders')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-clipboard-list w-5 text-center"></i> Monitor Pedidos
                </button>
                <button onclick="switchView('menu')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-utensils w-5 text-center"></i> Mi Men칰
                </button>
                <button onclick="switchView('qr')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-qrcode w-5 text-center"></i> Marketing & QR
                </button>
                <button onclick="switchView('settings')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition">
                    <i class="fa-solid fa-gear w-5 text-center"></i> Configuraci칩n
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <a href="#" id="sidebar-link-store" target="_blank" class="flex items-center gap-3 px-4 py-3 bg-blue-50 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-100 transition mb-2">
                    <i class="fa-solid fa-external-link-alt"></i> Ver mi Tienda
                </a>
                
                <!-- ENLACE PANEL COCINA -->
                <div class="mt-2 bg-orange-50 p-2 rounded-lg border border-orange-100 mb-2">
                    <p class="text-[10px] text-orange-800 font-bold mb-1 flex items-center gap-1">
                        <i class="fa-solid fa-fire-burner"></i> Link Cocina:
                    </p>
                    <input type="text" value="https://iamenu.github.io/menuia/kitchen.html" class="w-full text-[10px] bg-white border border-orange-200 rounded px-2 py-1 text-gray-500 cursor-pointer focus:ring-1 focus:ring-orange-300 outline-none" readonly onclick="this.select()">
                </div>

                <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-2 text-sm font-medium text-red-500 hover:bg-red-50 rounded-lg transition">
                    <i class="fa-solid fa-sign-out-alt"></i> Cerrar Sesi칩n
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Mobile Header -->
            <header class="bg-white h-16 border-b border-gray-200 flex md:hidden justify-between items-center px-4 z-20">
                <div class="font-bold text-lg">Panel Admin</div>
                <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-gray-100">
                
                <!-- VIEW: DASHBOARD (RESUMEN) -->
                <div id="view-dashboard" class="view-section fade-enter">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Hola, <span id="dash-owner-name">Due침o</span> 游녦</h2>
                            <p class="text-gray-500 text-sm">Aqu칤 tienes un resumen de tu negocio hoy.</p>
                        </div>
                        <div id="sub-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-600">Cargando...</div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl"><i class="fa-solid fa-eye"></i></div>
                                <div><p class="text-gray-400 text-xs font-bold uppercase">Visitas Hoy</p><h3 class="text-2xl font-bold text-gray-800" id="stat-visits-count">0</h3></div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl"><i class="fa-brands fa-whatsapp"></i></div>
                                <div><p class="text-gray-400 text-xs font-bold uppercase">Pedidos Hoy</p><h3 class="text-2xl font-bold text-gray-800" id="stat-orders-count">0</h3></div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xl"><i class="fa-solid fa-box-open"></i></div>
                                <div><p class="text-gray-400 text-xs font-bold uppercase">Productos</p><h3 class="text-2xl font-bold text-gray-800" id="stat-products-count">0</h3></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CTA Subscription -->
                    <div id="sub-pay-container" class="hidden bg-gradient-to-r from-gray-900 to-gray-800 rounded-2xl p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4 shadow-xl">
                        <div>
                            <h3 class="font-bold text-lg mb-1">游 Desbloquea todo el potencial</h3>
                            <p class="text-gray-300 text-sm">Tu prueba gratuita est치 activa. P치sate a PRO por solo $100/mes.</p>
                        </div>
                        <button onclick="openSubModal()" class="bg-white text-gray-900 px-6 py-2.5 rounded-full font-bold text-sm hover:bg-gray-100 transition shadow-lg flex items-center gap-2">
                            <i class="fa-solid fa-crown text-yellow-500"></i> Activar PRO
                        </button>
                    </div>
                </div>

                <!-- VIEW: ORDERS MONITOR (MODIFICADO) -->
                <div id="view-orders" class="view-section hidden fade-enter">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Gesti칩n de Pedidos</h2>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[calc(100vh-150px)]">
                        <div class="p-4 border-b border-gray-100 flex gap-2 overflow-x-auto bg-gray-50">
                            <button onclick="renderOrdersTable('active')" id="btn-monitor-active" class="filter-btn active px-4 py-2 text-xs font-bold rounded-full border border-blue-200 text-blue-700">
                                <i class="fa-solid fa-pulse mr-1"></i> Monitor Activo
                            </button>
                            <button onclick="renderOrdersTable('history')" id="btn-monitor-history" class="filter-btn px-4 py-2 text-xs font-bold rounded-full bg-white hover:bg-gray-100 text-gray-500 border border-gray-200">
                                <i class="fa-solid fa-clock-rotate-left mr-1"></i> Historial Semanal
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="orders-list-container">
                            <div class="text-center text-gray-400 mt-10 w-full col-span-full">Cargando pedidos...</div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MENU MANAGER -->
                <div id="view-menu" class="view-section hidden fade-enter">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Gesti칩n de Men칰</h2>
                            <p class="text-gray-500 text-sm">Organiza tus productos, categor칤as y complementos.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openProductModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-bold text-sm shadow-md transition flex items-center gap-2"><i class="fa-solid fa-plus"></i> Nuevo Producto</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Col: Categories & Groups -->
                        <div class="space-y-6">
                            <!-- Categories Card -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                                <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase tracking-wide border-b pb-2">游늭 Categor칤as (Editar Nombres)</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><input type="text" id="cat-title-promos" class="w-full text-sm border-none bg-transparent focus:ring-2 focus:ring-blue-100 rounded px-2 font-medium text-gray-700 hover:bg-gray-50" placeholder="Nombre Cat 1"></div>
                                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-500"></div><input type="text" id="cat-title-especiales" class="w-full text-sm border-none bg-transparent focus:ring-2 focus:ring-blue-100 rounded px-2 font-medium text-gray-700 hover:bg-gray-50" placeholder="Nombre Cat 2"></div>
                                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-500"></div><input type="text" id="cat-title-clasicos" class="w-full text-sm border-none bg-transparent focus:ring-2 focus:ring-blue-100 rounded px-2 font-medium text-gray-700 hover:bg-gray-50" placeholder="Nombre Cat 3"></div>
                                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-500"></div><input type="text" id="cat-title-extras" class="w-full text-sm border-none bg-transparent focus:ring-2 focus:ring-blue-100 rounded px-2 font-medium text-gray-700 hover:bg-gray-50" placeholder="Nombre Cat 4"></div>
                                    <p class="text-[10px] text-gray-400 mt-2">* Edita los nombres y guarda cambios para actualizar.</p>
                                </div>
                            </div>

                            <!-- Groups Card -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                                <div class="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">游빌 Complementos</h3>
                                    <button onclick="openGroupCreator()" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold transition flex items-center gap-1"><i class="fa-solid fa-plus"></i> Nuevo</button>
                                </div>
                                
                                <!-- CREATOR FORM -->
                                <div id="group-creator" class="hidden bg-gray-50 p-3 rounded-lg mb-3 border border-gray-200 animate-fade-in-up">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-bold text-gray-500 uppercase">Crear Grupo</span>
                                        <button onclick="closeGroupCreator()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
                                    </div>
                                    
                                    <input type="text" id="new-group-name" placeholder="Nombre (ej: Elige tus Salsas)" class="w-full text-sm border border-gray-300 rounded p-2 mb-2 font-bold text-gray-700 outline-none focus:border-blue-500">
                                    
                                    <!-- Dynamic Options List -->
                                    <div class="mb-2">
                                        <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Opciones (Nombre - Precio Extra)</label>
                                        <div id="new-group-options-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                                            <!-- Rows added via JS -->
                                        </div>
                                    </div>

                                    <button onclick="addOptionRow()" class="w-full bg-white border border-dashed border-blue-300 text-blue-500 text-xs py-1.5 rounded mb-3 hover:bg-blue-50 transition font-bold flex items-center justify-center gap-1">
                                        <i class="fa-solid fa-plus-circle"></i> Agregar Opci칩n
                                    </button>

                                    <button onclick="saveGroup()" class="w-full bg-gray-900 text-white text-xs py-2 rounded font-bold hover:bg-black transition shadow-sm">
                                        Guardar Grupo
                                    </button>
                                </div>

                                <div id="groups-list" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                                    <!-- Dynamic Groups List -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: Products Grid -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 h-full">
                                <!-- Tabs for Products -->
                                <div class="flex gap-2 overflow-x-auto border-b border-gray-100 pb-1 mb-4 no-scrollbar">
                                    <button onclick="renderMenuGrid('promos')" id="btn-cat-promos" class="px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600 whitespace-nowrap">Promos</button>
                                    <button onclick="renderMenuGrid('especiales')" id="btn-cat-especiales" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-800 whitespace-nowrap">Especiales</button>
                                    <button onclick="renderMenuGrid('clasicos')" id="btn-cat-clasicos" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-800 whitespace-nowrap">Cl치sicos</button>
                                    <button onclick="renderMenuGrid('extras')" id="btn-cat-extras" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-800 whitespace-nowrap">Extras</button>
                                </div>

                                <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <!-- Dynamic Products -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: MARKETING (QR) -->
                <div id="view-qr" class="view-section hidden fade-enter">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Marketing y QR</h2>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 flex flex-col md:flex-row gap-8 items-center">
                        <div class="flex-1 space-y-4">
                            <h3 class="font-bold text-lg text-gray-700">Dise침o de Material POP</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="renderQR('simple')" class="p-2 border rounded hover:bg-gray-50 text-xs font-bold">Minimalista</button>
                                <button onclick="renderQR('card')" class="p-2 border border-blue-200 bg-blue-50 text-blue-700 rounded text-xs font-bold">Tarjeta</button>
                                <button onclick="renderQR('poster')" class="p-2 border border-gray-800 bg-gray-900 text-white rounded text-xs font-bold">Poster</button>
                            </div>

                            <div class="bg-gray-50 p-3 rounded text-xs break-all border">
                                <span class="font-bold">Tu Link:</span> <span id="qr-link-text" class="text-blue-600">...</span>
                            </div>

                            <button onclick="window.print()" class="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold w-full hover:bg-gray-700 transition"><i class="fa-solid fa-print mr-2"></i> Imprimir Dise침o</button>
                        </div>

                        <div class="flex-1 flex justify-center items-center bg-gray-100 rounded-xl p-6 border-2 border-dashed border-gray-300 w-full min-h-[350px]">
                            <div id="qr-print-area"></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: SETTINGS (COMPLETO) -->
                <div id="view-settings" class="view-section hidden fade-enter">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Configuraci칩n de Tienda</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Card 1: Basic Info -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-store text-blue-500"></i> Datos Generales</h3>
                            <div class="space-y-4">
                                <div><label class="text-xs font-bold text-gray-500">Nombre del Negocio</label><input type="text" id="conf-name" class="w-full border-b border-gray-300 py-1 focus:border-blue-500 outline-none text-sm font-medium"></div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Giro (IA)</label>
                                    <select id="conf-type" class="w-full border-b border-gray-300 py-1 bg-transparent text-sm">
                                        <option value="Sushi">Sushi</option><option value="Tacos">Tacos</option><option value="Pizza">Pizza</option><option value="Hamburguesas">Burgers</option><option value="Cafeteria">Caf칠</option><option value="Comida General">Otro</option>
                                    </select>
                                </div>
                                <div><label class="text-xs font-bold text-gray-500">WhatsApp Pedidos</label><input type="text" id="conf-whatsapp" class="w-full border-b border-gray-300 py-1 focus:border-blue-500 outline-none text-sm font-medium"></div>
                            </div>
                        </div>

                        <!-- Card 2: Location & Hours -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-map-location-dot text-green-500"></i> Ubicaci칩n y Horario</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Direcci칩n</label>
                                    <input type="text" id="conf-address" class="w-full border-b border-gray-300 py-1 text-sm">
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                                    <label class="text-xs font-bold text-green-700">Link Google Maps (Autodetectar)</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="text" id="map-link-input" placeholder="https://maps.app.goo.gl/..." class="w-full text-xs p-1 border rounded">
                                        <button onclick="parseMapLink()" class="bg-green-600 text-white px-3 rounded text-xs font-bold">Buscar</button>
                                    </div>
                                </div>
                                <input type="hidden" id="conf-lat"><input type="hidden" id="conf-lng">
                                <div class="flex gap-4">
                                    <div class="flex-1"><label class="text-xs font-bold text-gray-500">Abre (Hora)</label><input type="number" id="conf-open" class="w-full border-b border-gray-300 py-1 text-sm"></div>
                                    <div class="flex-1"><label class="text-xs font-bold text-gray-500">Cierra (Hora)</label><input type="number" id="conf-close" class="w-full border-b border-gray-300 py-1 text-sm"></div>
                                </div>
                            </div>
                        </div>

                        <!-- NUEVA TARJETA: ALTA DEMANDA -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:col-span-2 border-l-4 border-orange-500">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-fire text-orange-500"></i> Estado del Servicio
                            </h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-bold text-sm text-gray-800">Modo Alta Demanda</p>
                                    <p class="text-xs text-gray-500">Activa esto cuando tengas muchos pedidos. El bot avisar치 a los clientes del tiempo de espera.</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="conf-high-demand-active" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                                </label>
                            </div>
                            <div id="high-demand-input-container" class="mt-4 hidden bg-orange-50 p-3 rounded-lg border border-orange-100">
                                <label class="block text-xs font-bold text-orange-800 uppercase mb-1">Tiempo de Espera Estimado</label>
                                <input type="text" id="conf-high-demand-time" placeholder="Ej: 45-60 minutos" class="w-full bg-white border border-orange-200 rounded px-3 py-2 focus:border-orange-500 outline-none text-sm font-bold text-gray-700">
                                <p class="text-[10px] text-orange-600 mt-1"><i class="fa-solid fa-info-circle"></i> Este mensaje se mostrar치 a los clientes antes de pedir.</p>
                            </div>
                        </div>

                        <!-- Card 3: Branding -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:col-span-2">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-image text-purple-500"></i> Imagen de Portada</h3>
                            <div class="flex items-center gap-4">
                                <div class="w-32 h-20 bg-gray-100 rounded-lg overflow-hidden border relative group">
                                    <img id="hero-preview" src="" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center text-white text-xs">Cambiar</div>
                                </div>
                                <div class="flex-1">
                                    <input type="file" onchange="handleHeroUpload(this)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                    <input type="hidden" id="conf-hero">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SAVE FLOATING BUTTON -->
            <button onclick="saveChanges()" class="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-4 rounded-full font-bold shadow-2xl hover:bg-black transition transform hover:scale-105 flex items-center gap-2 z-40">
                <i class="fa-solid fa-floppy-disk"></i> Guardar Cambios
            </button>
        </main>
    </div>

    <!-- Modals (Producto, Opciones POS, Suscripci칩n) -->
    
    <!-- ORDER DETAIL MODAL (NUEVO) -->
    <div id="order-detail-modal" class="fixed inset-0 z-50 hidden bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col h-full max-h-[85vh] animate-fade-in-up">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-gray-900 to-gray-800 px-6 py-4 border-b border-gray-700 flex justify-between items-center text-white">
                <div>
                    <h3 class="font-bold text-xl flex items-center gap-2">
                        <i class="fa-solid fa-receipt"></i> <span id="detail-order-id">Pedido #0</span>
                    </h3>
                    <p class="text-xs text-gray-400" id="detail-order-date">...</p>
                </div>
                <button onclick="document.getElementById('order-detail-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50 space-y-6">
                
                <!-- Status & Payment -->
                <div class="flex gap-4">
                    <div class="flex-1 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Estado Actual</p>
                        <div id="detail-status-badge"></div>
                    </div>
                    <div class="flex-1 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">Pago</p>
                        <p class="font-bold text-gray-800" id="detail-payment">...</p>
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <h4 class="font-bold text-gray-700 text-sm mb-3 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-user text-blue-500"></i> Cliente</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex"><span class="text-gray-500 w-20">Nombre:</span> <span class="font-bold text-gray-800" id="detail-cust-name">...</span></div>
                        <div class="flex"><span class="text-gray-500 w-20">Tel칠fono:</span> <span class="font-bold text-gray-800" id="detail-cust-phone">...</span></div>
                        <div class="flex items-start"><span class="text-gray-500 w-20">Direcci칩n:</span> <span class="font-bold text-gray-800 flex-1" id="detail-cust-address">...</span></div>
                    </div>
                </div>

                <!-- Items List -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <h4 class="font-bold text-gray-700 text-sm mb-3 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-utensils text-orange-500"></i> Productos</h4>
                    <div id="detail-items-list" class="space-y-3">
                        <!-- Items rendered here -->
                    </div>
                    <div class="border-t border-gray-100 mt-3 pt-2 flex justify-between items-center">
                        <span class="font-bold text-gray-600">Total</span>
                        <span class="font-bold text-xl text-green-600" id="detail-total">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="p-4 bg-white border-t border-gray-200 flex flex-col gap-3">
                <p class="text-xs font-bold text-gray-400 uppercase text-center mb-1">Cambiar Estado del Pedido</p>
                <div class="grid grid-cols-5 gap-2"> <!-- CHANGED TO 5 COLS -->
                    <button onclick="updateOrderStatus('pending')" class="status-btn px-2 py-2 rounded-lg border text-[10px] font-bold text-center hover:bg-gray-50 border-gray-300 text-gray-500">Pendiente</button>
                    <button onclick="updateOrderStatus('preparing')" class="status-btn px-2 py-2 rounded-lg border text-[10px] font-bold text-center hover:bg-orange-50 border-orange-200 text-orange-600">Cocina</button>
                    <button onclick="updateOrderStatus('ready')" class="status-btn px-2 py-2 rounded-lg border text-[10px] font-bold text-center hover:bg-blue-50 border-blue-200 text-blue-600">Listo</button>
                    <button onclick="updateOrderStatus('delivering')" class="status-btn px-2 py-2 rounded-lg border text-[10px] font-bold text-center hover:bg-purple-50 border-purple-200 text-purple-600">En Camino</button>
                    <button onclick="updateOrderStatus('completed')" class="status-btn px-2 py-2 rounded-lg border text-[10px] font-bold text-center hover:bg-green-50 border-green-200 text-green-600">Entregado</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Otros Modals (Product, POS Options, Sub) -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-fade-in-up">
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg text-gray-800">Producto</h3><button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto"><input type="hidden" id="prod-id"><input type="hidden" id="prod-category"><div><label class="text-xs font-bold text-gray-500 uppercase">Nombre</label><input type="text" id="prod-name" class="w-full border border-gray-300 rounded p-2 text-sm"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Descripci칩n</label><textarea id="prod-desc" class="w-full border border-gray-300 rounded p-2 text-sm h-20"></textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Precio ($)</label><input type="number" id="prod-price" class="w-full border border-gray-300 rounded p-2 text-sm font-bold text-green-700"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Antes (Opc)</label><input type="number" id="prod-original" class="w-full border border-gray-300 rounded p-2 text-sm"></div></div><div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100"><label class="text-xs font-bold text-yellow-700 uppercase">Complementos</label><select id="prod-group-select" class="w-full border border-yellow-200 rounded p-2 text-sm bg-white mt-1"><option value="">-- Sin Complementos --</option></select></div><div class="flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100"><img id="prod-img-preview" src="" class="w-16 h-16 rounded object-cover bg-gray-200"><div class="flex-1"><input type="file" onchange="handleImageUpload(this)" class="w-full text-xs text-gray-500"><input type="hidden" id="prod-img-url"></div></div><div><label class="text-xs font-bold text-gray-500 uppercase">Etiquetas</label><input type="text" id="prod-tags" class="w-full border border-gray-300 rounded p-2 text-sm"></div></div>
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-3"><button onclick="closeProductModal()" class="px-4 py-2 rounded text-gray-500 hover:bg-gray-200 text-sm font-bold">Cancelar</button><button onclick="saveProductInternal()" class="px-6 py-2 rounded bg-blue-600 text-white font-bold text-sm hover:bg-blue-700 shadow">Guardar</button></div>
        </div>
    </div>

    <div id="sub-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden animate-fade-in-up"><div class="bg-gradient-to-r from-gray-900 to-gray-800 p-6 text-white text-center"><h3 class="text-2xl font-bold mb-2">游 Plan PRO</h3><p class="text-gray-300 text-sm">Transferencia Bancaria</p></div><div class="p-6 space-y-4"><p class="text-sm text-gray-600 text-center">Realiza una transferencia de <span class="font-bold text-gray-800">$100 MXN</span>:</p><div class="bg-gray-100 p-4 rounded-xl border border-gray-200 text-sm space-y-2"><div class="flex justify-between"><span class="text-gray-500">Banco:</span><span class="font-bold text-gray-800">BBVA / STP</span></div><div class="flex justify-between"><span class="text-gray-500">CLABE:</span><span class="font-bold text-gray-800 select-all">123456789012345678</span></div><div class="flex justify-between"><span class="text-gray-500">Beneficiario:</span><span class="font-bold text-gray-800">Men칰IA S.A.</span></div><div class="flex justify-between border-t border-gray-300 pt-2 mt-2 bg-yellow-50 p-2 rounded border border-yellow-200"><span class="text-gray-700 font-bold">Concepto:</span><span class="font-bold text-blue-600 select-all text-right" id="sub-concept-ref">PRO-TIENDA</span></div></div><button onclick="document.getElementById('sub-modal').classList.add('hidden')" class="w-full text-gray-400 text-sm hover:text-gray-600 py-2">Cerrar</button></div></div>
    </div>

    <div id="print-area" class="hidden"></div>

    <script>
        const API_URL = "https://menuia.onrender.com";
        const socket = io(API_URL);
        
        let SESSION = { slug: null, password: null, data: null };
        let currentCategory = 'promos';
        let ordersHistory = []; 
        let currentDetailOrder = null; 
        let currentOrderFilter = 'active'; // Default view

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'border-r-2', 'border-blue-600'));
            const activeBtn = Array.from(document.querySelectorAll('.nav-item')).find(b => b.getAttribute('onclick').includes(viewId));
            if(activeBtn) { activeBtn.classList.add('active'); activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-50'); }

            if(viewId === 'menu') { renderGroups(); renderMenuGrid(currentCategory); }
            if(viewId === 'qr') renderQR('simple');
            if(viewId === 'orders') fetchAndRenderOrders(currentOrderFilter); 
            
            const saveBtn = document.querySelector('button[onclick="saveChanges()"]');
            if(saveBtn) {
                if(viewId === 'settings' || viewId === 'menu') saveBtn.classList.remove('hidden');
                else saveBtn.classList.add('hidden');
            }
        }

        function switchTab(tab) {
            const l = document.getElementById('form-login'), r = document.getElementById('form-register');
            if(tab==='login') { l.classList.remove('hidden'); r.classList.add('hidden'); } else { l.classList.add('hidden'); r.classList.remove('hidden'); }
        }

        window.onload = () => {
            const s = localStorage.getItem('shop_slug'), p = localStorage.getItem('shop_pass');
            if(s && p) { document.getElementById('login-slug').value = s; document.getElementById('login-pass').value = p; }
            document.getElementById('conf-high-demand-active').addEventListener('change', toggleHighDemandInput);
        };

        async function handleLogin() {
            const slug = document.getElementById('login-slug').value.trim().toLowerCase();
            const password = document.getElementById('login-pass').value;
            try {
                const res = await fetch(`${API_URL}/api/admin/get`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ slug, password }) });
                if(res.ok) {
                    SESSION = { slug, password, data: await res.json() };
                    if(!SESSION.data.menu) SESSION.data.menu = { promos: [], especiales: [], clasicos: [], extras: [], groups: [] };
                    if(!SESSION.data.menu.groups) SESSION.data.menu.groups = []; 
                    if(!SESSION.data.stats) SESSION.data.stats = { visits: 0, orders: 0 }; 
                    
                    localStorage.setItem('shop_slug', slug); localStorage.setItem('shop_pass', password);
                    socket.emit('join-store', slug);
                    initDashboard();
                } else alert("Credenciales incorrectas");
            } catch(e) { alert("Error de conexi칩n"); }
        }

        async function handleRegister() { alert("Usa el formulario de registro existente."); }

        function initDashboard() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            const c = SESSION.data.config;
            const stats = SESSION.data.stats || { visits: 0, orders: 0 };
            document.getElementById('dash-owner-name').innerText = SESSION.data.credentials.ownerName || 'Due침o';
            
            const prodCount = (SESSION.data.menu.promos?.length||0) + (SESSION.data.menu.especiales?.length||0) + 
                              (SESSION.data.menu.clasicos?.length||0) + (SESSION.data.menu.extras?.length||0);
            
            document.getElementById('stat-products-count').innerText = prodCount;
            document.getElementById('stat-visits-count').innerText = stats.visits;
            document.getElementById('stat-orders-count').innerText = stats.orders;
            
            const storeUrl = `https://iamenu.github.io/menuia/menu.html?slug=${SESSION.slug}`;
            document.getElementById('sidebar-link-store').href = storeUrl;
            const qrLinkElement = document.getElementById('qr-link-text');
            if (qrLinkElement) qrLinkElement.innerText = storeUrl;
            
            document.getElementById('conf-name').value = c.name || '';
            document.getElementById('conf-type').value = c.businessType || 'Comida General';
            document.getElementById('conf-address').value = c.address || '';
            document.getElementById('conf-whatsapp').value = c.whatsapp || '';
            document.getElementById('conf-hero').value = c.heroImage || '';
            document.getElementById('hero-preview').src = c.heroImage || '';
            document.getElementById('conf-open').value = c.hours?.open;
            document.getElementById('conf-close').value = c.hours?.close;
            
            const hd = c.highDemand || false;
            document.getElementById('conf-high-demand-active').checked = hd;
            document.getElementById('conf-high-demand-time').value = c.highDemandTime || '';
            toggleHighDemandInput();

            ['promos', 'especiales', 'clasicos', 'extras'].forEach(key => {
                const title = (c.categoryTitles && c.categoryTitles[key]) ? c.categoryTitles[key] : key.charAt(0).toUpperCase() + key.slice(1);
                document.getElementById(`cat-title-${key}`).value = title;
                const menuBtn = document.getElementById(`btn-cat-${key}`);
                if(menuBtn) menuBtn.innerText = title;
            });

            switchView('dashboard');
        }
        
        function toggleHighDemandInput() {
            const isActive = document.getElementById('conf-high-demand-active').checked;
            const container = document.getElementById('high-demand-input-container');
            if(isActive) container.classList.remove('hidden');
            else container.classList.add('hidden');
        }

        socket.on('stats-update', (stats) => {
            if(stats) {
                document.getElementById('stat-visits-count').innerText = stats.visits;
                document.getElementById('stat-orders-count').innerText = stats.orders;
            }
        });

        socket.on('new-order-saved', () => {
            if(!document.getElementById('view-orders').classList.contains('hidden')) {
                fetchAndRenderOrders(currentOrderFilter);
            }
        });

        function generateTicketHTML(cart, total, ref) {
            const date = new Date().toLocaleString();
            const itemsHTML = cart.map(i => {
                const opts = (i.selectedOpts || []).map(o => `+ ${o.name}`).join(', ');
                const nameDisplay = opts ? `${i.name} (${opts})` : i.name;
                return `<div style="display:flex; justify-content:space-between; font-size: 12px; margin-bottom: 4px;"><span>${i.qty}x ${nameDisplay}</span><span>$${(i.price*i.qty).toFixed(2)}</span></div>`;
            }).join('');
            return `<div style="width: 300px; font-family: monospace; text-align: center; border: 1px dashed #000; padding: 10px;"><h2 style="margin: 0; font-size: 16px; font-weight: bold;">${SESSION.data.config.name}</h2><p style="margin: 2px 0; font-size: 10px;">${date}</p><p style="margin: 2px 0; font-size: 12px; border-bottom: 1px solid #000; padding-bottom: 5px;">${posOrderType.toUpperCase()}: ${ref}</p><div style="text-align: left; margin: 10px 0;">${itemsHTML}</div><div style="border-top: 1px solid #000; padding-top: 5px; display:flex; justify-content:space-between; font-weight: bold; font-size: 16px;"><span>TOTAL:</span><span>${total}</span></div><p style="font-size: 10px; margin-top: 10px;">춰Gracias por su compra!</p></div>`;
        }

        function printLastTicket() { 
            if(ordersHistory.length === 0) return alert("No hay pedidos recientes");
            const last = ordersHistory[0];
            const html = generateTicketHTML(last.items, last.total, last.ref);
            document.getElementById('print-area').innerHTML = html; 
            window.print(); 
        }

        // --- ORDERS MONITOR (ACTUALIZADO) ---
        async function fetchAndRenderOrders(filter) {
            currentOrderFilter = filter;
            
            // Actualizar botones de filtro
            document.getElementById('btn-monitor-active').className = filter === 'active' 
                ? "filter-btn active px-4 py-2 text-xs font-bold rounded-full border border-blue-200 text-blue-700 bg-blue-100" 
                : "filter-btn px-4 py-2 text-xs font-bold rounded-full bg-white hover:bg-gray-100 text-gray-500 border border-gray-200";
            
            document.getElementById('btn-monitor-history').className = filter === 'history' 
                ? "filter-btn active px-4 py-2 text-xs font-bold rounded-full border border-blue-200 text-blue-700 bg-blue-100" 
                : "filter-btn px-4 py-2 text-xs font-bold rounded-full bg-white hover:bg-gray-100 text-gray-500 border border-gray-200";

            const container = document.getElementById('orders-list-container');
            container.innerHTML = `<div class="text-center text-gray-400 mt-10 col-span-full"><i class="fa-solid fa-spinner fa-spin"></i> Cargando...</div>`;
            try {
                const res = await fetch(`${API_URL}/api/orders/list`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ slug: SESSION.slug, password: SESSION.password }) });
                const data = await res.json();
                if(data.success) { ordersHistory = data.orders; renderOrders(filter); }
            } catch(e) { container.innerHTML = `<div class="text-center text-red-400 mt-10 col-span-full">Error cargando pedidos</div>`; }
        }
        function renderOrdersTable(f) { fetchAndRenderOrders(f); }
        
        function renderOrders(f) {
            const c = document.getElementById('orders-list-container');
            let orders = [];

            // L칩gica de Filtros Estricta
            if(f === 'active') {
                // Monitor: Solo pedidos NO completados
                orders = ordersHistory.filter(o => o.status !== 'completed');
            } else if(f === 'history') {
                // Historial: Solo Completados de la semana actual (Lunes a Lunes)
                const startOfWeek = moment().startOf('isoWeek'); // Lunes 00:00 de esta semana
                orders = ordersHistory.filter(o => {
                    const isCompleted = o.status === 'completed';
                    const isRecent = moment(o.createdAt).isSameOrAfter(startOfWeek);
                    return isCompleted && isRecent;
                });
            }
            
            if(orders.length===0) { 
                c.innerHTML = `<div class="text-center text-gray-400 mt-10 col-span-full flex flex-col items-center gap-2">
                    <i class="fa-solid fa-clipboard-check text-4xl opacity-20"></i>
                    <p>No hay pedidos en esta secci칩n.</p>
                </div>`; 
                return; 
            }
            
            // RENDERING CARDS MINIMALISTAS
            c.innerHTML = orders.map(o => {
                let badgeClass = 'bg-gray-100 text-gray-600';
                let statusIcon = 'fa-circle-question';
                if(o.status === 'pending') { badgeClass = 'bg-yellow-100 text-yellow-700 border-yellow-200'; statusIcon = 'fa-clock'; }
                if(o.status === 'preparing') { badgeClass = 'bg-orange-100 text-orange-700 border-orange-200'; statusIcon = 'fa-fire-burner'; }
                if(o.status === 'ready') { badgeClass = 'bg-blue-100 text-blue-700 border-blue-200'; statusIcon = 'fa-box-open'; }
                if(o.status === 'delivering') { badgeClass = 'bg-purple-100 text-purple-700 border-purple-200'; statusIcon = 'fa-motorcycle'; } 
                if(o.status === 'completed') { badgeClass = 'bg-green-100 text-green-700 border-green-200'; statusIcon = 'fa-check-circle'; }

                const safeOrder = JSON.stringify(o).replace(/"/g, '&quot;');

                return `
                <div onclick="openOrderDetails(${safeOrder})" class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer group relative overflow-hidden animate-fade-in-up">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-blue-50 to-transparent rounded-bl-full -mr-4 -mt-4 opacity-50"></div>
                    
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-xl text-gray-800">Pedido #${o.dailyId || '?'}</h3>
                            <p class="text-xs text-gray-400 font-medium">${moment(o.createdAt).fromNow()}</p>
                        </div>
                        <div class="rounded-full px-2 py-1 text-[10px] font-bold uppercase border ${badgeClass} flex items-center gap-1">
                            <i class="fa-solid ${statusIcon}"></i> ${o.status}
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-2 mb-3 border border-gray-100">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500 font-medium">M칠todo Pago</span>
                            <span class="font-bold text-gray-800">${o.paymentMethod || 'No especificado'}</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-2 border-t border-gray-100 pt-2">
                        <span class="text-xs font-bold text-gray-400 uppercase">${o.items ? o.items.length : 0} Art칤culos</span>
                        <span class="text-indigo-600 font-bold text-sm group-hover:underline">Ver Detalles <i class="fa-solid fa-arrow-right ml-1"></i></span>
                    </div>
                </div>`;
            }).join('');
        }

        // --- ORDER DETAIL MODAL LOGIC ---
        function openOrderDetails(order) {
            currentDetailOrder = order;
            const m = document.getElementById('order-detail-modal');
            
            document.getElementById('detail-order-id').innerText = `Pedido #${order.dailyId || '?'}`;
            document.getElementById('detail-order-date').innerText = moment(order.createdAt).format('LLLL');
            
            // Status Badge
            const statusMap = {
                'pending': '<span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">Pendiente</span>',
                'preparing': '<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold border border-orange-200">En Cocina</span>',
                'ready': '<span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">Listo para Entrega</span>',
                'delivering': '<span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-bold border border-purple-200">En Camino</span>', 
                'completed': '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">Completado/Entregado</span>'
            };
            document.getElementById('detail-status-badge').innerHTML = statusMap[order.status] || order.status;
            document.getElementById('detail-payment').innerText = order.paymentMethod || 'N/A';
            
            // Customer
            document.getElementById('detail-cust-name').innerText = order.ref || 'Cliente General';
            document.getElementById('detail-cust-phone').innerText = order.customerPhone || 'N/A';
            document.getElementById('detail-cust-address').innerText = order.address || 'Recoger en Tienda / N/A';
            
            // Items
            const itemsList = document.getElementById('detail-items-list');
            if (order.items && order.items.length > 0) {
                itemsList.innerHTML = order.items.map(i => {
                    const opts = (i.options || []).map(o => typeof o === 'string' ? o : o.name).join(', ');
                    const optsHtml = opts ? `<div class="text-[10px] text-gray-500 mt-0.5 bg-gray-100 px-1.5 py-0.5 rounded inline-block"><i class="fa-solid fa-plus-circle text-xs mr-1"></i>${opts}</div>` : '';
                    return `
                    <div class="flex justify-between items-start border-b border-gray-100 pb-2 last:border-0">
                        <div class="flex-1">
                            <span class="font-bold text-gray-800 text-sm">${i.qty}x ${i.name}</span>
                            ${optsHtml}
                        </div>
                        <span class="font-bold text-gray-600 text-sm">$${(i.price * i.qty).toFixed(2)}</span>
                    </div>`;
                }).join('');
            } else {
                itemsList.innerHTML = '<p class="text-gray-400 text-center text-sm">Sin art칤culos registrados</p>';
            }
            
            document.getElementById('detail-total').innerText = order.total || '$0.00';
            
            // Active button highlight
            document.querySelectorAll('.status-btn').forEach(b => {
                if (b.getAttribute('onclick').includes(`'${order.status}'`)) {
                    b.classList.add('ring-2', 'ring-offset-1', 'ring-gray-400');
                } else {
                    b.classList.remove('ring-2', 'ring-offset-1', 'ring-gray-400');
                }
            });

            m.classList.remove('hidden');
        }

        async function updateOrderStatus(newStatus) {
            if (!currentDetailOrder) return;
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "...";
            
            try {
                const res = await fetch(`${API_URL}/api/orders/update-status`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        slug: SESSION.slug,
                        password: SESSION.password,
                        orderId: currentDetailOrder._id,
                        status: newStatus
                    })
                });
                
                if (res.ok) {
                    currentDetailOrder.status = newStatus;
                    // Si se completa y estamos en vista activa, se "borrar치" visualmente al refrescar
                    if (newStatus === 'completed' && currentOrderFilter === 'active') {
                        document.getElementById('order-detail-modal').classList.add('hidden');
                    } else {
                        openOrderDetails(currentDetailOrder); // Refresh modal UI
                    }
                    fetchAndRenderOrders(currentOrderFilter); // Refresh list behind
                } else {
                    alert("Error al actualizar");
                }
            } catch (e) {
                alert("Error de conexi칩n");
            }
            btn.innerText = originalText;
        }

        // --- MENU LOGIC ---
        function renderMenuGrid(cat) { currentCategory=cat; 
            document.querySelectorAll('[id^="btn-cat-"]').forEach(b => { if(b.id === `btn-cat-${cat}`) b.className = "px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600 whitespace-nowrap"; else b.className = "px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-800 whitespace-nowrap"; });
            
            if (!SESSION.data.menu || !SESSION.data.menu[cat]) {
                document.getElementById('menu-grid').innerHTML = '<div class="text-center text-gray-400">Sin productos</div>';
                return;
            }

            const items = SESSION.data.menu[cat] || [];
            document.getElementById('menu-grid').innerHTML = items.map((item, idx) => `<div class="bg-white border border-gray-100 rounded-xl p-3 flex gap-3 hover:shadow-md transition group"><img src="${item.image || 'https://via.placeholder.com/80'}" class="w-20 h-20 rounded-lg object-cover bg-gray-100"><div class="flex-1 min-w-0"><h4 class="font-bold text-gray-800 truncate">${item.name}</h4><div class="flex justify-between items-center mt-2"><span class="font-bold text-green-600">$${item.price}</span><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="editProduct('${cat}', ${idx})" class="text-blue-500 hover:bg-blue-50 p-1.5 rounded"><i class="fa-solid fa-pen"></i></button><button onclick="deleteProduct('${cat}', ${idx})" class="text-red-500 hover:bg-red-50 p-1.5 rounded"><i class="fa-solid fa-trash"></i></button></div></div></div></div>`).join('');
        }
        
        function openGroupCreator() { document.getElementById('group-creator').classList.remove('hidden'); document.getElementById('new-group-name').value = ''; document.getElementById('new-group-options-list').innerHTML = ''; addOptionRow(); }
        function closeGroupCreator() { document.getElementById('group-creator').classList.add('hidden'); }
        
        function addOptionRow() { 
            const d = document.createElement('div'); d.className = "flex gap-2 mb-2 items-center option-row"; d.innerHTML = `<input type="text" placeholder="Ej: Queso" class="flex-1 text-xs border border-gray-300 rounded p-1.5 option-name"><input type="number" placeholder="$0" class="w-16 text-xs border border-gray-300 rounded p-1.5 option-price" min="0"><button onclick="this.parentElement.remove()" class="text-red-400 px-1"><i class="fa-solid fa-times"></i></button>`; document.getElementById('new-group-options-list').appendChild(d); 
        }
        
        function renderGroups() {
            if (!SESSION.data.menu || !SESSION.data.menu.groups) {
                document.getElementById('groups-list').innerHTML = `<div class="text-gray-400 text-xs text-center py-2 italic">Sin grupos a칰n.</div>`;
                return;
            }

            const groups = SESSION.data.menu.groups;
            if(groups.length === 0) { document.getElementById('groups-list').innerHTML = `<div class="text-gray-400 text-xs text-center py-2 italic">Sin grupos a칰n.</div>`; return; }
            document.getElementById('groups-list').innerHTML = groups.map((g, idx) => `
                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm relative group">
                    <div class="flex justify-between items-start mb-1">
                        <div><span class="font-bold text-sm text-gray-800">${g.name}</span><div class="text-[10px] text-gray-400">${g.options.length} opciones</div></div>
                        <button onclick="deleteGroup(${idx})" class="text-red-400 hover:text-red-600 p-1 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`).join('');
        }

        function saveGroup() { 
            const name = document.getElementById('new-group-name').value; 
            const opts = Array.from(document.querySelectorAll('.option-row')).map(r => ({ name: r.querySelector('.option-name').value, price: parseFloat(r.querySelector('.option-price').value)||0 })).filter(o => o.name); 
            if(!name || opts.length===0) return alert("Faltan datos"); 
            
            if(!SESSION.data.menu.groups) SESSION.data.menu.groups = [];
            
            SESSION.data.menu.groups.push({ id: 'g-'+Date.now(), name, options: opts }); 
            renderGroups(); closeGroupCreator(); 
            saveDataToServer(false);
        }
        
        function deleteGroup(idx) { 
            if(confirm("쮹orrar?")) { 
                SESSION.data.menu.groups.splice(idx, 1); 
                renderGroups(); 
                saveDataToServer(false);
            } 
        }
        
        function openProductModal(idx=-1) { 
            editingIdx = idx; document.getElementById('product-modal').classList.remove('hidden');
            const sel = document.getElementById('prod-group-select');
            const groups = (SESSION.data.menu && SESSION.data.menu.groups) ? SESSION.data.menu.groups : [];
            sel.innerHTML = '<option value="">-- Sin Complementos --</option>' + groups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
            if(idx === -1) { ['prod-name','prod-desc','prod-price','prod-original','prod-img-url','prod-tags'].forEach(i=>document.getElementById(i).value=''); document.getElementById('prod-img-preview').src=''; sel.value=""; } 
            else { const item = SESSION.data.menu[currentCategory][idx]; document.getElementById('prod-name').value=item.name; document.getElementById('prod-desc').value=item.description; document.getElementById('prod-price').value=item.price; document.getElementById('prod-original').value=item.originalPrice||''; document.getElementById('prod-img-url').value=item.image||''; document.getElementById('prod-img-preview').src=item.image||''; document.getElementById('prod-tags').value=(item.tags||[]).join(','); sel.value=item.groupId||""; }
        }
        function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); }
        function handleImageUpload(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{document.getElementById('prod-img-preview').src=e.target.result;document.getElementById('prod-img-url').value=e.target.result;}; r.readAsDataURL(i.files[0]); } }
        
        function saveProductInternal() { 
            const name = document.getElementById('prod-name').value;
            const price = parseFloat(document.getElementById('prod-price').value);
            if(!name || !price) return alert("Faltan datos"); 
            const item = { 
                id: editingIdx===-1 ? Date.now().toString() : SESSION.data.menu[currentCategory][editingIdx].id, 
                name, description: document.getElementById('prod-desc').value, price, originalPrice: parseFloat(document.getElementById('prod-original').value)||null, image: document.getElementById('prod-img-url').value, tags: document.getElementById('prod-tags').value.split(',').filter(t=>t), groupId: document.getElementById('prod-group-select').value || null 
            }; 
            if(editingIdx===-1) SESSION.data.menu[currentCategory].push(item); else SESSION.data.menu[currentCategory][editingIdx]=item; 
            closeProductModal(); renderMenuGrid(currentCategory); saveDataToServer(false);
        }

        function deleteProduct(cat, idx) { 
            if(confirm("쮼liminar?")) { 
                SESSION.data.menu[cat].splice(idx, 1); 
                renderMenuGrid(cat); 
                saveDataToServer(false);
            } 
        }
        
        function editProduct(cat, idx) { currentCategory = cat; openProductModal(idx); }

        async function saveDataToServer(showNotifications = true) {
             const btn = document.querySelector('button[onclick="saveChanges()"]');
             let originalText = "";
             
             if(showNotifications && btn) { originalText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...'; btn.disabled = true; }

             const cfg = { ...SESSION.data.config };
             cfg.name = document.getElementById('conf-name').value;
             cfg.businessType = document.getElementById('conf-type').value;
             cfg.whatsapp = document.getElementById('conf-whatsapp').value;
             cfg.address = document.getElementById('conf-address').value;
             const latInput = document.getElementById('conf-lat').value;
             const lngInput = document.getElementById('conf-lng').value;
             if (latInput && lngInput) { cfg.coords = { lat: parseFloat(latInput), lng: parseFloat(lngInput) }; }
             cfg.hours = { open: parseInt(document.getElementById('conf-open').value), close: parseInt(document.getElementById('conf-close').value) };
             cfg.heroImage = document.getElementById('conf-hero').value;
             cfg.highDemand = document.getElementById('conf-high-demand-active').checked;
             cfg.highDemandTime = document.getElementById('conf-high-demand-time').value;
             cfg.categoryTitles = { promos: document.getElementById('cat-title-promos').value, especiales: document.getElementById('cat-title-especiales').value, clasicos: document.getElementById('cat-title-clasicos').value, extras: document.getElementById('cat-title-extras').value };
             
             SESSION.data.config = cfg;

             try {
                const res = await fetch(`${API_URL}/api/shop/${SESSION.slug}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ password: SESSION.password, data: { config: cfg, menu: SESSION.data.menu } }) });
                if (res.ok) { 
                    if(showNotifications && btn) { btn.innerHTML = '<i class="fa-solid fa-check"></i> 춰Listo!'; setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000); }
                    ['promos', 'especiales', 'clasicos', 'extras'].forEach(key => { const btn = document.getElementById(`btn-cat-${key}`); if (btn) btn.innerText = cfg.categoryTitles[key] || key.toUpperCase(); });
                } else { 
                    if(showNotifications && btn) { btn.innerHTML = 'Error'; btn.disabled = false; }
                    alert("Error al guardar en servidor.");
                }
            } catch(e) { 
                if(showNotifications && btn) { btn.innerHTML = 'Error Red'; btn.disabled = false; }
                console.error(e);
            }
        }

        function saveChanges() { saveDataToServer(true); }
        
        async function parseMapLink() {
            const input = document.getElementById('map-link-input').value;
            if(!input) return alert("Ingresa un link de Google Maps");
            const btn = event.target.closest('button'); const original = btn.innerHTML; btn.innerHTML = '...'; btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/api/utils/parse-map`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ input }) });
                const data = await res.json();
                if(data.success) { document.getElementById('conf-lat').value = data.lat; document.getElementById('conf-lng').value = data.lng; alert("Ubicaci칩n actualizada 九"); } else { alert("Error obteniendo coordenadas."); }
            } catch(e) { alert("Error de conexi칩n"); }
            btn.innerHTML = original; btn.disabled = false;
        }

        function handleHeroUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { document.getElementById('conf-hero').value = e.target.result; document.getElementById('hero-preview').src = e.target.result; };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderQR(style) {
            const c = document.getElementById('qr-print-area'); c.innerHTML="";
            const div = document.createElement('div'); div.className="bg-white p-4 border flex flex-col items-center shadow-lg";
            if (style === 'card') { div.style.border = "4px solid #3b82f6"; div.style.borderRadius = "20px"; }
            else if (style === 'poster') { div.style.backgroundColor = "#111827"; div.style.color = "white"; div.style.borderRadius = "10px"; }
            div.innerHTML = `${style==='poster' ? `<div class="mb-4 text-xl font-bold text-yellow-400">${SESSION.data.config.name}</div>` : ''}<div id="qrcode" class="${style==='poster'?'bg-white p-2 rounded':''}"></div><p class="mt-2 text-xs font-bold ${style==='poster'?'text-gray-400':'text-gray-600'}">${SESSION.data.config.name}</p>`;
            c.appendChild(div);
            new QRCode(div.querySelector("#qrcode"), { text: `https://iamenu.github.io/menuia/menu.html?slug=${SESSION.slug}`, width:150, height:150, colorDark: "#000000", colorLight: "#ffffff" });
        }
        
        function openSubModal() { document.getElementById('sub-concept-ref').innerText = `PRO-${SESSION.slug.toUpperCase()}`; document.getElementById('sub-modal').classList.remove('hidden'); }
        function logout() { localStorage.removeItem('shop_pass'); location.reload(); }
    </script>
</body>
</html>
