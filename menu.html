<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #111827; color: #f3f4f6; background-image: radial-gradient(circle at 50% 50%, #1f2937 0%, #111827 100%); background-attachment: fixed; }
        @keyframes neural-pulse { 0% { background-color: #111827; } 50% { background-color: #131b2e; } 100% { background-color: #111827; } }
        body.ai-active { animation: neural-pulse 4s infinite ease-in-out; }
        html { scroll-behavior: smooth; }
        .sushi-card { background-color: #1f2937; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #374151; }
        .sushi-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4); border-color: #ef4444; z-index: 10; }
        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s; opacity: 0; visibility: hidden; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal.active .modal-content { transform: scale(1); }
        .badge-offer { background: linear-gradient(45deg, #f59e0b, #d97706); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; position: absolute; top: 10px; left: 10px; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .badge-ai { background: linear-gradient(45deg, #3b82f6, #8b5cf6); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; position: absolute; top: 10px; right: 10px; z-index: 10; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4); display: flex; align-items: center; gap: 4px; animation: pulse-border 2s infinite; backdrop-filter: blur(4px); }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); transform: scale(1); } 50% { transform: scale(1.05); } 100% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); transform: scale(1); } }
        #app-loader { position: fixed; inset: 0; background: #111827; z-index: 9999; display: flex; flex-col: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        
        /* Chat Styles */
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.4; animation: popIn 0.3s ease-out; }
        .chat-bubble.bot { background-color: #374151; color: white; border-bottom-left-radius: 2px; align-self: flex-start; border-left: 3px solid #3b82f6; }
        .chat-bubble.user { background-color: #dc2626; color: white; border-bottom-right-radius: 2px; align-self: flex-end; text-align: right; }
        .chat-options { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; margin-bottom: 15px; animation: fadeIn 0.5s ease-out; }
        .chat-option-btn { background-color: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #ef4444; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .chat-option-btn:hover { background-color: #ef4444; color: white; transform: translateY(-2px); }
        .typing-indicator { display: inline-flex; gap: 4px; padding: 8px 12px; background-color: #374151; border-radius: 15px; border-bottom-left-radius: 2px; margin-bottom: 10px; animation: popIn 0.3s ease-out; }
        .typing-dot { width: 6px; height: 6px; background-color: #9ca3af; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .ai-filter-btn { transition: all 0.3s ease; }
        .ai-filter-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="text-gray-100 ai-active" onclick="resetIdleTimer()" onscroll="resetIdleTimer()">

    <div id="app-loader">
        <i class="fa-solid fa-robot text-6xl text-blue-500 animate-bounce mb-4"></i>
        <p class="text-xl font-bold animate-pulse" id="loader-text">Analizando men√∫...</p>
        <button onclick="window.location.reload()" id="retry-btn" class="mt-4 px-4 py-2 bg-gray-700 rounded text-sm hidden hover:bg-gray-600 transition">Reintentar</button>
    </div>

    <!-- Header / Navbar -->
    <nav class="bg-black/95 backdrop-blur-md shadow-lg fixed w-full z-50 top-0 border-b border-gray-800">
        <div id="status-banner" class="text-white text-center py-1 text-xs font-bold tracking-wider uppercase transition-colors duration-300"></div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center gap-2">
                    <div class="bg-gradient-to-br from-red-600 to-red-800 w-9 h-9 rounded-full flex items-center justify-center shadow-red-500/50 shadow-lg">
                        <i class="fa-solid fa-utensils text-white text-sm"></i>
                    </div>
                    <span class="font-bold text-xl tracking-wide text-white" id="brand-name">TIENDA</span>
                </div>
                <div class="flex items-center gap-3">
                    <!-- BOT√ìN LOGIN DE USUARIO (CONECTADO A DB) -->
                    <button onclick="toggleUserModal()" class="text-gray-300 hover:text-white transition flex items-center gap-2 bg-gray-800/50 px-3 py-1.5 rounded-full border border-gray-700">
                        <i class="fa-solid fa-user-circle text-lg"></i>
                        <span id="nav-user-name" class="text-xs font-bold hidden sm:inline">Ingresar</span>
                    </button>

                    <button onclick="toggleAI()" class="group relative bg-gray-800 hover:bg-gray-700 text-blue-400 border border-blue-900/50 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 transition overflow-hidden">
                        <div class="absolute inset-0 bg-blue-500/10 group-hover:bg-blue-500/20 transition"></div>
                        <i class="fa-solid fa-robot animate-bounce"></i> <span class="hidden sm:inline">IA Chef</span>
                    </button>
                    <div class="relative cursor-pointer hover:scale-110 transition duration-300" onclick="toggleCart()">
                        <div class="flex items-center gap-2">
                            <span class="hidden md:block text-sm font-semibold text-gray-300">Pedido</span>
                            <div class="relative">
                                <i class="fa-solid fa-cart-shopping text-2xl text-white hover:text-red-500 transition"></i>
                                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold rounded-full h-4 w-4 flex items-center justify-center border border-black shadow">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="relative bg-gray-900 h-72 mt-20 flex items-center justify-center overflow-hidden">
        <img id="hero-img" src="" class="absolute w-full h-full object-cover opacity-30 transform hover:scale-105 transition duration-[20s]">
        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-gray-900/50 to-gray-900"></div>
        <div class="relative z-10 text-center px-4 max-w-3xl">
            <div class="inline-flex items-center gap-2 mb-2 px-3 py-1 rounded-full bg-blue-500/20 border border-blue-500/30 backdrop-blur-sm">
                <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                <span class="text-blue-200 text-xs font-bold tracking-wide uppercase" id="hours-display">Abierto</span>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold text-white mb-2 drop-shadow-2xl tracking-tight" id="hero-title">BIENVENIDO</h1>
            <p class="text-gray-300 text-lg font-light mb-6">Tu comida favorita, potenciada por IA.</p>
            <div id="hero-badge" class="inline-block bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg shadow-green-900/50 cursor-default"></div>
        </div>
    </div>

    <!-- Filtros Inteligentes -->
    <div class="sticky top-20 z-40 bg-gray-900/95 backdrop-blur-md border-b border-gray-800 py-3 mb-6 transition-all" id="ai-filters-bar">
        <div class="max-w-7xl mx-auto px-4 overflow-x-auto">
            <div class="flex items-center gap-3 min-w-max">
                <span class="text-blue-400 text-xs font-bold uppercase tracking-wider"><i class="fa-solid fa-microchip mr-1"></i> Filtros IA:</span>
                <button onclick="applyAIFilter('all')" class="ai-filter-btn active px-4 py-1.5 rounded-full text-xs font-medium border border-gray-700 bg-gray-800 text-gray-300 hover:text-white">Todo</button>
                <button onclick="applyAIFilter('top')" class="ai-filter-btn px-4 py-1.5 rounded-full text-xs font-medium border border-gray-700 bg-gray-800 text-gray-300 hover:text-white hover:border-purple-500"><i class="fa-solid fa-crown text-purple-500 mr-1"></i> Top Ventas</button>
                <button onclick="applyAIFilter('promo')" class="ai-filter-btn px-4 py-1.5 rounded-full text-xs font-medium border border-gray-700 bg-gray-800 text-gray-300 hover:text-white hover:border-yellow-500"><i class="fa-solid fa-tag text-yellow-500 mr-1"></i> Ofertas</button>
            </div>
        </div>
    </div>

    <!-- Menu Section -->
    <div class="max-w-7xl mx-auto px-4 pb-24 min-h-[60vh]">
        <div id="menu-sections"></div>
        <div id="no-results" class="hidden text-center py-20">
            <i class="fa-solid fa-robot text-6xl text-gray-700 mb-4 animate-bounce"></i>
            <p class="text-gray-400 text-xl">Sin resultados.</p>
            <button onclick="applyAIFilter('all')" class="mt-4 text-blue-400 hover:text-blue-300 underline">Ver todo</button>
        </div>
    </div>

    <!-- MODAL DE OPCIONES / TOPPINGS -->
    <div id="options-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm px-4">
        <div class="bg-gray-800 w-full max-w-sm rounded-xl border border-gray-700 shadow-2xl overflow-hidden transform transition-all">
            <div class="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-lg text-white">Elige tus opciones</h3>
                <button onclick="toggleOptionsModal(false)" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 max-h-[60vh] overflow-y-auto">
                <p class="text-sm text-gray-400 mb-3" id="options-instruction">Selecciona tus complementos:</p>
                <div id="options-list" class="space-y-2">
                    <!-- Checkboxes din√°micos -->
                </div>
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700">
                <button id="modal-confirm-btn" onclick="confirmOptions()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition">Confirmar y Agregar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LOGIN USUARIO (CON PASSWORD Y API) -->
    <div id="user-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm px-4">
        <div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
            <!-- Header con pesta√±as -->
            <div class="bg-gray-50 border-b border-gray-200 flex">
                <button onclick="switchAuthTab('login')" id="tab-login" class="flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition">Iniciar Sesi√≥n</button>
                <button onclick="switchAuthTab('register')" id="tab-register" class="flex-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 transition">Crear Cuenta</button>
            </div>
            
            <div class="p-6 relative">
                <button onclick="toggleUserModal()" class="absolute top-2 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-lg"></i></button>

                <!-- FORMULARIO LOGIN -->
                <form id="form-login" onsubmit="event.preventDefault(); handleUserLogin();" class="space-y-4">
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">¬°Hola de nuevo! üëã</h3>
                        <p class="text-xs text-gray-500">Ingresa tus datos para continuar.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Celular</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-phone"></i></span>
                            <input type="tel" id="login-phone" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Ej: 5512345678" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contrase√±a</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-lock"></i></span>
                            <input type="password" id="login-pass" class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="********" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-black hover:bg-gray-800 text-white font-bold py-3 rounded-xl shadow-lg transition">
                        Entrar
                    </button>
                </form>

                <!-- FORMULARIO REGISTRO -->
                <form id="form-register" onsubmit="event.preventDefault(); handleUserRegister();" class="space-y-4 hidden">
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Crea tu cuenta</h3>
                        <p class="text-xs text-gray-500">Pide m√°s r√°pido guardando tus datos.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre Completo</label>
                        <input type="text" id="reg-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Celular</label>
                        <input type="tel" id="reg-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Direcci√≥n (Para env√≠os)</label>
                        <textarea id="reg-address" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" rows="2" required></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contrase√±a</label>
                        <input type="password" id="reg-pass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition">
                        Registrarme
                    </button>
                </form>

                <div id="user-info-panel" class="hidden text-center py-4">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl font-bold" id="user-initial">U</div>
                    <h3 class="font-bold text-lg" id="display-user-name">Usuario</h3>
                    <p class="text-sm text-gray-500 mb-4" id="display-user-phone">...</p>
                    <button onclick="logoutUser()" class="text-red-500 font-bold text-xs hover:underline bg-red-50 px-4 py-2 rounded-full">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Carrito Modal -->
    <div id="cart-modal" class="modal fixed inset-0 z-50 flex justify-end bg-black/90 backdrop-blur-sm">
        <div class="modal-content bg-gray-900 w-full max-w-md h-full shadow-2xl flex flex-col border-l border-gray-800">
            <div class="bg-gray-800 p-4 text-white flex justify-between items-center shadow-md border-b border-gray-700">
                <h3 class="font-bold text-lg text-red-500 flex items-center gap-2"><i class="fa-solid fa-receipt"></i> Tu Pedido</h3>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div id="cart-items-container" class="flex-1 p-4 overflow-y-auto bg-gray-900"></div>
            <div class="p-5 bg-gray-800 border-t border-gray-700 shadow-[0_-5px_15px_rgba(0,0,0,0.3)]">
                <div class="flex justify-between items-center mb-1 text-base text-gray-400"><span>Subtotal:</span><span id="cart-subtotal" class="text-white">$0.00</span></div>
                <div class="flex justify-between items-center mb-1 text-base text-gray-400"><span>Env√≠o:</span><span id="cart-shipping" class="text-white font-bold">--</span></div>
                <div class="flex justify-between items-center mb-4 text-xl font-bold text-white border-t border-gray-700 pt-2"><span>Total:</span><span id="cart-total" class="text-red-500">$0.00</span></div>
                
                <div id="checkout-form" class="hidden space-y-3 mb-4">
                    <input type="text" id="cust-name" placeholder="Nombre" class="w-full bg-gray-700 p-2 rounded text-white">
                    <input type="tel" id="cust-phone" placeholder="Tel√©fono" class="w-full bg-gray-700 p-2 rounded text-white">
                    <div class="bg-gray-700 p-2 rounded">
                        <button onclick="getLocation()" class="text-xs bg-blue-600 px-2 py-1 rounded w-full mb-2">üìç Usar GPS</button>
                        <div id="location-result" class="text-xs mb-1"></div>
                        <textarea id="cust-address" placeholder="Direcci√≥n" class="w-full bg-gray-800 p-2 text-sm rounded text-white"></textarea>
                    </div>
                    
                    <!-- SECCI√ìN DE PAGO -->
                    <div class="mt-3 mb-2">
                        <p class="text-sm font-bold text-gray-300 mb-2">M√©todo de Pago:</p>
                        <div class="flex gap-2 mb-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="pay" value="transferencia" class="peer sr-only" checked onchange="togglePay()">
                                <div class="bg-gray-700 peer-checked:bg-blue-600 peer-checked:border-blue-400 border border-transparent rounded p-2 text-center text-xs transition">
                                    <i class="fa-solid fa-building-columns mb-1 block"></i> Transferencia
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="pay" value="efectivo" class="peer sr-only" onchange="togglePay()">
                                <div class="bg-gray-700 peer-checked:bg-green-600 peer-checked:border-green-400 border border-transparent rounded p-2 text-center text-xs transition">
                                    <i class="fa-solid fa-money-bill-wave mb-1 block"></i> Efectivo
                                </div>
                            </label>
                        </div>
                        
                        <div id="pay-trans" class="text-xs text-blue-200 bg-blue-900/20 border border-blue-500/30 p-2 rounded">
                            <p>Banco: <span id="disp-bank-name" class="font-bold select-all"></span></p>
                            <p>CLABE: <span id="disp-bank-clabe" class="font-bold select-all"></span></p>
                        </div>
                        <div id="pay-cash" class="hidden text-xs text-green-200 bg-green-900/20 border border-green-500/30 p-2 rounded">
                            <p>Pagas al recibir. Ten cambio listo.</p>
                        </div>
                    </div>
                </div>
                <button onclick="handleCheckout()" id="checkout-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg">Enviar Pedido (WhatsApp)</button>
            </div>
        </div>
    </div>

    <!-- IA Modal -->
    <div id="ai-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-gray-900 w-full max-w-sm rounded-2xl shadow-2xl border border-gray-700 overflow-hidden flex flex-col h-[500px] animate-fade-in relative">
            <div class="bg-gray-900 p-4 border-b border-gray-800 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-robot text-white"></i></div>
                    <div><h3 class="font-bold text-white text-sm">IA Chef ü§ñ</h3><p class="text-[10px] text-blue-300">En l√≠nea</p></div>
                </div>
                <button onclick="toggleAI()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="chat-container" class="flex-1 p-4 overflow-y-auto flex flex-col gap-2"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 border border-gray-700 text-white px-6 py-3 rounded-full opacity-0 pointer-events-none transition-all duration-300 z-[60] flex items-center gap-3 translate-y-10">
        <i class="fa-solid fa-check text-green-500"></i> <span id="toast-msg">Agregado</span>
    </div>

    <script>
        const API_URL = "https://menuia.onrender.com";
        // Safe Socket Init
        let socket;
        try { socket = io(API_URL); } catch(e) { console.warn("Socket no disponible"); }
        
        let SHOP_CONFIG = {}, MENU_DATA = {}, cart = [], userLocation = null, distanceKm = 0;
        let allItems = []; 
        let idleTimer, idleWarningShown = false;
        
        // Detecci√≥n robusta de SLUG
        const urlParams = new URLSearchParams(window.location.search);
        let pathSlug = window.location.pathname.split('/').pop();
        if(pathSlug.endsWith('.html')) pathSlug = pathSlug.replace('.html', '');
        
        const SHOP_SLUG = urlParams.get('slug') || pathSlug || 'sosushi';
        
        let pendingItem = null;
        let USER_DATA = JSON.parse(localStorage.getItem('menuia_user_data')) || null;

        if(socket) {
            socket.on('connect', () => socket.emit('join-store', SHOP_SLUG));
            socket.on('shop-updated', async () => { await loadStoreData(); showToast("Actualizando men√∫..."); });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Safety timeout
            setTimeout(() => {
                const l = document.getElementById('app-loader');
                const t = document.getElementById('loader-text');
                if(l && l.style.opacity !== '0') {
                    if(t) t.innerText = "Tarda un poco...";
                    document.getElementById('retry-btn').classList.remove('hidden');
                }
            }, 8000);
            
            loadStoreData();
            resetIdleTimer();
            initUser();
        });
        
        // --- USER AUTH LOGIC ---
        function switchAuthTab(tab) {
            const lForm = document.getElementById('form-login');
            const rForm = document.getElementById('form-register');
            const lBtn = document.getElementById('tab-login');
            const rBtn = document.getElementById('tab-register');
            
            if(tab === 'login') {
                lForm.classList.remove('hidden'); rForm.classList.add('hidden');
                lBtn.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition";
                rBtn.className = "flex-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 transition";
            } else {
                lForm.classList.add('hidden'); rForm.classList.remove('hidden');
                rBtn.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition";
                lBtn.className = "flex-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 transition";
            }
        }

        async function handleUserLogin() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-pass').value;
            
            const btn = document.querySelector('#form-login button');
            const originalText = btn.innerText;
            btn.innerText = "Verificando..."; btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/api/customer/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ phone, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    USER_DATA = data.customer;
                    // Guardar password para autologin
                    USER_DATA.password = password; 
                    localStorage.setItem('menuia_user_data', JSON.stringify(USER_DATA));
                    updateUserUI();
                    toggleUserModal();
                    showToast(`¬°Bienvenido de nuevo, ${USER_DATA.name.split(' ')[0]}!`);
                } else {
                    alert(data.error || "Credenciales incorrectas");
                }
            } catch (e) {
                alert("Error de conexi√≥n");
            }
            btn.innerText = originalText; btn.disabled = false;
        }

        async function handleUserRegister() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const address = document.getElementById('reg-address').value;
            const password = document.getElementById('reg-pass').value;

            const btn = document.querySelector('#form-register button');
            const originalText = btn.innerText;
            btn.innerText = "Creando cuenta..."; btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/api/customer/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, phone, address, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    USER_DATA = { name, phone, address, password };
                    localStorage.setItem('menuia_user_data', JSON.stringify(USER_DATA));
                    updateUserUI();
                    toggleUserModal();
                    showToast("¬°Cuenta creada con √©xito!");
                } else {
                    alert(data.error || "Error al registrar");
                }
            } catch (e) {
                alert("Error de conexi√≥n");
            }
            btn.innerText = originalText; btn.disabled = false;
        }

        function logoutUser() {
            localStorage.removeItem('menuia_user_data');
            USER_DATA = null;
            updateUserUI();
            showToast("Has cerrado sesi√≥n");
        }

        function updateUserUI() {
            const loginForm = document.getElementById('form-login');
            const regForm = document.getElementById('form-register');
            const infoPanel = document.getElementById('user-info-panel');
            const tabs = document.querySelector('.bg-gray-50.border-b'); 

            if (USER_DATA) {
                document.getElementById('nav-user-name').innerText = `Hola, ${USER_DATA.name.split(' ')[0]}`;
                document.getElementById('display-user-name').innerText = USER_DATA.name;
                document.getElementById('display-user-phone').innerText = USER_DATA.phone;
                document.getElementById('user-initial').innerText = USER_DATA.name.charAt(0).toUpperCase();
                
                loginForm.classList.add('hidden');
                regForm.classList.add('hidden');
                if(tabs) tabs.classList.add('hidden');
                infoPanel.classList.remove('hidden');
            } else {
                document.getElementById('nav-user-name').innerText = "Ingresar";
                if(tabs) tabs.classList.remove('hidden');
                infoPanel.classList.add('hidden');
                switchAuthTab('login'); 
            }
        }

        function toggleUserModal() {
            const m = document.getElementById('user-modal');
            m.classList.toggle('active');
        }

        // --- SHOP LOGIC ---
        async function loadStoreData() {
            try {
                if(socket) socket.emit('register-visit', SHOP_SLUG);

                const res = await fetch(`${API_URL}/api/shop/${SHOP_SLUG}`);
                if(!res.ok) throw new Error("Tienda no encontrada");
                
                const data = await res.json();
                SHOP_CONFIG = data.config || {}; 
                MENU_DATA = data.menu || {};
                
                // Safe Array Spread
                const promos = MENU_DATA.promos || [];
                const especiales = MENU_DATA.especiales || [];
                const clasicos = MENU_DATA.clasicos || [];
                const extras = MENU_DATA.extras || [];
                
                allItems = [...promos, ...especiales, ...clasicos, ...extras];
                allItems.forEach(item => {
                    if(!item.sales) item.sales = Math.floor(Math.random() * 100); 
                });

                applyConfig(); 
                renderMenu('all');
                
                const loader = document.getElementById('app-loader');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            } catch (e) { 
                console.error(e);
                const loaderText = document.getElementById('loader-text');
                if(loaderText) loaderText.innerText = "Tienda no disponible o enlace incorrecto."; 
            }
        }

        function applyConfig() {
            if(!SHOP_CONFIG.name) return; 
            
            document.title = SHOP_CONFIG.name;
            document.getElementById('brand-name').innerText = SHOP_CONFIG.name.toUpperCase();
            document.getElementById('hero-title').innerText = SHOP_CONFIG.name.toUpperCase();
            document.getElementById('hero-img').src = SHOP_CONFIG.heroImage || 'https://via.placeholder.com/800';
            
            const closeTime = SHOP_CONFIG.hours?.close || 22;
            const openTime = SHOP_CONFIG.hours?.open || 9;
            document.getElementById('hours-display').innerText = `Abierto hasta ${closeTime}:00 hrs`;
            
            if(SHOP_CONFIG.bank) {
                document.getElementById('disp-bank-name').innerText = SHOP_CONFIG.bank.name || 'N/A';
                document.getElementById('disp-bank-clabe').innerText = SHOP_CONFIG.bank.clabe || 'N/A';
            }
            
            const h = new Date().getHours();
            const isOpen = h >= openTime && h < closeTime;
            const banner = document.getElementById('status-banner');
            const badge = document.getElementById('hero-badge');
            
            if(isOpen) {
                if (SHOP_CONFIG.highDemand) {
                    banner.innerText = `‚ö†Ô∏è ALTA DEMANDA - TIEMPO DE ESPERA: ${SHOP_CONFIG.highDemandTime || 'CONSULTAR'} ‚ö†Ô∏è`; 
                    banner.className = "bg-orange-600 text-white text-center py-1 text-xs font-bold tracking-wider uppercase transition-colors duration-300";
                    badge.innerText = `‚è≥ Demora: ${SHOP_CONFIG.highDemandTime || 'Alta'}`;
                    badge.className = "bg-orange-600 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg shadow-orange-900/50 cursor-default";
                } else {
                    banner.innerText = "¬°ENVIOS DISPONIBLES AHORA!"; 
                    banner.className = "bg-green-600 text-white text-center py-1 text-xs font-bold tracking-wider uppercase transition-colors duration-300";
                    const freeKm = SHOP_CONFIG.shipping?.freeKm || 0;
                    badge.innerText = `Env√≠o Gratis < ${freeKm}km`;
                    badge.className = "inline-block bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg shadow-green-900/50 cursor-default";
                }
            } else {
                banner.innerText = "CERRADO"; 
                banner.className = "bg-red-600 text-white text-center py-1 text-xs font-bold tracking-wider uppercase transition-colors duration-300";
                badge.innerText = "Restaurante Cerrado"; 
                badge.className = "bg-red-600 text-white px-4 py-1 rounded-full text-sm font-bold shadow-lg cursor-default";
            }
        }

        // --- RENDER MENU ---
        function renderMenu(filter) {
            const container = document.getElementById('menu-sections');
            container.innerHTML = '';
            let hasResults = false;

            if(filter === 'top') {
                const topItems = [...allItems].sort((a,b) => b.sales - a.sales).slice(0, 6); 
                if(topItems.length > 0) {
                    hasResults = true;
                    renderSection(container, "üèÜ Top Ventas del Mes", topItems);
                }
            } else {
                const titles = SHOP_CONFIG.categoryTitles || {};
                const cats = ['promos', 'especiales', 'clasicos', 'extras'];
                
                cats.forEach(key => {
                    let items = MENU_DATA[key] || [];
                    if(filter === 'promo') items = items.filter(i => (i.tags||[]).includes('promo') || key === 'promos');
                    
                    if(items.length > 0) {
                        hasResults = true;
                        renderSection(container, titles[key] || key.toUpperCase(), items);
                    }
                });
            }
            
            document.getElementById('no-results').classList.toggle('hidden', hasResults);
        }

        function renderSection(container, title, items) {
            const section = document.createElement('div');
            section.className = "mb-12 animate-fade-in";
            section.innerHTML = `
                <div class="flex items-center gap-3 mb-6">
                    <h2 class="text-2xl font-bold text-white">${title}</h2>
                    <div class="h-px flex-1 bg-gray-800"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${items.map(i => createCard(i)).join('')}
                </div>`;
            container.appendChild(section);
        }

        function createCard(item) {
            const isTop = item.sales > 80;
            const isPromo = (item.tags || []).includes('promo') || (item.originalPrice && item.originalPrice > item.price);
            
            let badgesHTML = '';
            if (isTop) badgesHTML += `<div class="badge-ai top-2 right-2"><i class="fa-solid fa-fire"></i> Top</div>`;
            if (isPromo) badgesHTML += `<div class="badge-offer top-2 left-2">Oferta</div>`;

            let priceHTML = '';
            if (item.originalPrice && item.originalPrice > item.price) {
                priceHTML = `
                    <div class="flex flex-col items-end">
                        <span class="text-xs text-gray-400 line-through bg-black/60 px-1 rounded mb-0.5">$${item.originalPrice}</span>
                        <span class="bg-red-600 text-white px-2 py-0.5 rounded-lg font-bold shadow-lg text-lg">$${item.price}</span>
                    </div>`;
            } else {
                priceHTML = `<span class="bg-red-600 text-white px-3 py-0.5 rounded-lg font-bold shadow-lg text-lg">$${item.price}</span>`;
            }

            const h = new Date().getHours();
            const openTime = SHOP_CONFIG.hours?.open || 9;
            const closeTime = SHOP_CONFIG.hours?.close || 22;
            const isOpen = h >= openTime && h < closeTime;
            
            const safeItem = JSON.stringify(item).replace(/'/g, "&#39;");

            const btnHTML = isOpen 
                ? `<button onclick='addToCart(${safeItem})' class="w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg font-bold mt-auto transition transform active:scale-95 flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> Agregar</button>`
                : `<button disabled class="w-full bg-gray-600 text-gray-400 py-2 rounded-lg font-bold mt-auto cursor-not-allowed flex items-center justify-center gap-2"><i class="fa-solid fa-lock"></i> Cerrado</button>`;

            return `
            <div class="bg-gray-800 rounded-xl overflow-hidden sushi-card flex flex-col h-full relative group shadow-lg border border-gray-700">
                ${badgesHTML}
                <div class="h-48 relative overflow-hidden bg-gray-900">
                    <img src="${item.image||'https://via.placeholder.com/300?text=Sin+Imagen'}" class="w-full h-full object-cover transition duration-500 transform group-hover:scale-110" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/300?text=Sin+Imagen'">
                    <div class="absolute bottom-2 right-2">
                        ${priceHTML}
                    </div>
                </div>
                <div class="p-4 flex-1 flex flex-col">
                    <h3 class="font-bold text-lg text-white mb-1 leading-tight">${item.name}</h3>
                    <p class="text-gray-400 text-xs mb-4 flex-1 line-clamp-2">${item.description || 'Delicioso platillo preparado al momento.'}</p>
                    ${btnHTML}
                </div>
            </div>`;
        }

        function applyAIFilter(type) {
            document.querySelectorAll('.ai-filter-btn').forEach(b => b.classList.remove('active'));
            if(event) event.target.closest('button').classList.add('active');
            renderMenu(type);
        }

        // --- CHATBOT ---
        let aiScores = {};
        function toggleAI() {
            const m = document.getElementById('ai-modal');
            m.classList.toggle('active');
            if(m.classList.contains('active')) startAIChat();
        }
        function startAIChat() {
            const c = document.getElementById('chat-container');
            c.innerHTML = '';
            allItems.forEach(i => aiScores[i.name] = 0);
            
            const type = (SHOP_CONFIG.businessType || "General").toLowerCase();
            let greeting = "¬°Hola! Soy tu asistente virtual.";
            
            if (SHOP_CONFIG.highDemand) {
                greeting = `‚ö†Ô∏è ¬°Hola! Aviso importante: Actualmente tenemos mucha demanda. El tiempo de espera estimado es de ${SHOP_CONFIG.highDemandTime || '45min'}. ¬øTe gustar√≠a ordenar algo?`;
            }

            let q1 = "¬øQu√© tanto hambre tienes?";
            let opts1 = [{txt: "Mucha ü¶Å", act: "rate(['grande','combo'], 5); step2()"}, {txt: "Poca ü•ó", act: "rate(['ligero','individual'], 5); step2()"}];

            if(type.includes('sushi')) {
                if (!SHOP_CONFIG.highDemand) greeting = "¬°Konnichiwa! üç£ Soy tu Sensei de Sushi."; 
                q1 = "¬øAntojo de algo fresco o empanizado?";
                opts1 = [{txt: "Empanizado / Crunch üç§", act: "rate(['empanizado','crunchy'], 5); step2()"}, {txt: "Fresco / Natural ü•ë", act: "rate(['natural','fresco'], 5); step2()"}];
            } else if(type.includes('pizza')) {
                if (!SHOP_CONFIG.highDemand) greeting = "¬°Mamma Mia! üçï Soy tu Pizzaiolo IA.";
                q1 = "¬øCu√°ntos van a comer hoy?";
                opts1 = [{txt: "Solo yo (Individual) üë§", act: "rate(['individual','chica'], 5); step2()"}, {txt: "Familia entera üë®‚Äçüë©‚Äçüëß‚Äçüë¶", act: "rate(['familiar','grande','combo'], 5); step2()"}];
            } else if(type.includes('tacos')) {
                if (!SHOP_CONFIG.highDemand) greeting = "¬°Qu√© onda! üåÆ Soy tu Taquero Robot.";
                q1 = "¬øTraes hambre de pastor o asada?";
                opts1 = [{txt: "Pastor üçç", act: "rate(['pastor','adobada'], 5); step2()"}, {txt: "Bistec / Asada ü•©", act: "rate(['asada','bistec'], 5); step2()"}];
            }

            addMsg(greeting, true);
            setTimeout(() => { addMsg(q1, true); addOpts(opts1); }, 600);
        }
        function step2() {
            const type = (SHOP_CONFIG.businessType || "").toLowerCase();
            let q = "¬øAlg√∫n sabor en especial?";
            let opts = [{txt: "Picante üî•", act: "rate(['picante','spicy'], 5); showResult()"}, {txt: "Cl√°sico üëç", act: "rate(['clasico','tradicional'], 5); showResult()"}];
            if(type.includes('sushi')) { q = "¬øTe gusta el queso crema?"; opts = [{txt: "¬°S√≠, mucho! üßÄ", act: "rate(['queso','philadelphia'], 5); showResult()"}, {txt: "No, gracias", act: "showResult()"}]; }
            addMsg(q, true); addOpts(opts);
        }
        function showResult() {
            let winner = allItems[0], max = -1;
            allItems.forEach(i => { const score = (aiScores[i.name]||0) + Math.random(); if(score > max) { max = score; winner = i; } });
            const safeWinner = JSON.stringify(winner).replace(/'/g, "&#39;");
            addMsg("¬°Encontr√© esto para ti! üëá", true);
            const c = document.getElementById('chat-container');
            const card = document.createElement('div');
            card.className = "bg-gray-800 p-3 rounded border border-blue-500 shadow animate-fade-in";
            card.innerHTML = `<img src="${winner.image}" class="w-full h-24 object-cover rounded mb-2"><h4 class="font-bold text-white">${winner.name}</h4><div class="flex justify-between mt-2"><span class="text-red-400">$${winner.price}</span><button onclick='addToCart(${safeWinner}); toggleAI()' class="bg-green-600 text-white px-2 rounded text-xs">Pedir</button></div>`;
            c.appendChild(card); c.scrollTop = c.scrollHeight;
            addOpts([{txt: "üîÑ Buscar otro", act: "startAIChat()"}]);
        }
        function addMsg(txt, bot) { const c = document.getElementById('chat-container'); c.innerHTML += `<div class="chat-bubble ${bot?'bot':'user'}">${txt}</div>`; c.scrollTop = c.scrollHeight; }
        function addOpts(opts) { const c = document.getElementById('chat-container'); const d = document.createElement('div'); d.className="chat-options"; opts.forEach(o => { const b = document.createElement('button'); b.className="chat-option-btn"; b.innerText=o.txt; b.onclick = () => { d.remove(); addMsg(o.txt, false); eval(o.act); }; d.appendChild(b); }); c.appendChild(d); c.scrollTop = c.scrollHeight; }
        function rate(tags, pts) { allItems.forEach(i => { const txt = (i.name + ' ' + i.description + ' ' + (i.tags||[]).join(' ')).toLowerCase(); tags.forEach(t => { if(txt.includes(t)) aiScores[i.name] += pts; }); }); }

        // --- CARRITO & CHECKOUT ---
        function toggleCart() { 
            if (USER_DATA) {
                document.getElementById('cust-name').value = USER_DATA.name;
                document.getElementById('cust-phone').value = USER_DATA.phone;
                document.getElementById('cust-address').value = USER_DATA.address || '';
            }
            document.getElementById('cart-modal').classList.toggle('active'); 
        }
        function toggleOptionsModal(show) { const m = document.getElementById('options-modal'); if(show) m.classList.add('active'); else m.classList.remove('active'); }
        function addToCart(item) {
            let options = item.options || [];
            if (item.groupId && MENU_DATA.groups) { const group = MENU_DATA.groups.find(g => g.id === item.groupId); if (group) options = group.options; }

            if(options && options.length > 0) {
                pendingItem = item;
                pendingItem.price = parseFloat(pendingItem.price); 
                pendingItem._resolvedOptions = options;
                const container = document.getElementById('options-list');
                container.innerHTML = options.map((opt, idx) => {
                    const name = typeof opt === 'object' ? opt.name : opt;
                    const price = typeof opt === 'object' ? (parseFloat(opt.price) || 0) : 0; 
                    const priceTxt = price > 0 ? `(+$${price})` : '';
                    return `<label class="flex items-center p-3 bg-gray-900 border border-gray-700 rounded-lg cursor-pointer hover:bg-gray-800 transition justify-between group"><div class="flex items-center"><input type="checkbox" value="${idx}" data-price="${price}" data-name="${name}" onchange="updateModalTotal()" class="option-check form-checkbox h-5 w-5 text-blue-600 rounded mr-3"><span class="text-white font-medium">${name}</span></div>${price > 0 ? `<span class="text-green-400 font-bold text-sm bg-green-900/30 px-2 py-1 rounded">${priceTxt}</span>` : ''}</label>`;
                }).join('');
                updateModalTotal(); toggleOptionsModal(true);
            } else {
                const itemToAdd = { ...item, price: parseFloat(item.price) };
                addItemToCartInternal(itemToAdd, []);
            }
        }
        function updateModalTotal() {
            const checks = document.querySelectorAll('.option-check:checked');
            let extra = 0;
            checks.forEach(c => extra += parseFloat(c.dataset.price || 0));
            const total = parseFloat(pendingItem.price) + extra;
            document.getElementById('modal-confirm-btn').innerText = `Agregar por $${total.toFixed(2)}`;
        }
        function confirmOptions() {
            const checks = document.querySelectorAll('.option-check:checked');
            const selectedNames = [];
            let extraCost = 0;
            checks.forEach(c => {
                const name = c.dataset.name;
                const price = parseFloat(c.dataset.price || 0);
                extraCost += price;
                selectedNames.push(price > 0 ? `${name} (+$${price})` : name);
            });
            const itemToAdd = { ...pendingItem, price: parseFloat(pendingItem.price) + extraCost };
            addItemToCartInternal(itemToAdd, selectedNames);
            toggleOptionsModal(false);
        }
        function addItemToCartInternal(item, options) {
            const optionsKey = options.sort().join('|');
            const ex = cart.find(i => i.name === item.name && (i.selectedOptions || []).sort().join('|') === optionsKey);
            if(ex) ex.qty++; else cart.push({...item, qty:1, selectedOptions: options});
            updateCart(); showToast("Agregado"); confetti({particleCount:30, origin:{y:0.8}});
        }
        function updateCart() {
            document.getElementById('cart-count').innerText = cart.reduce((a,b)=>a+b.qty,0);
            const c = document.getElementById('cart-items-container');
            if(cart.length === 0) {
                c.innerHTML = `<div class="text-center text-gray-500 mt-10">Carrito Vac√≠o</div>`;
                document.getElementById('checkout-form').classList.add('hidden');
                document.getElementById('checkout-btn').disabled = true;
                document.getElementById('checkout-btn').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('cart-total').innerText = "$0.00";
                return;
            }
            document.getElementById('checkout-btn').disabled = false;
            document.getElementById('checkout-btn').classList.remove('opacity-50', 'cursor-not-allowed');
            c.innerHTML = cart.map((i, idx) => {
                const optsHtml = i.selectedOptions && i.selectedOptions.length > 0 ? `<div class="text-[10px] text-blue-400 mt-1 font-medium bg-blue-900/30 px-2 py-0.5 rounded inline-block">+ ${i.selectedOptions.join(', ')}</div>` : '';
                return `<div class="flex items-center gap-3 p-3 bg-gray-800 mb-2 rounded border border-gray-700 relative group"><img src="${i.image||'https://via.placeholder.com/100'}" class="w-12 h-12 rounded object-cover bg-gray-700" loading="lazy"><div class="flex-1"><h4 class="text-sm font-bold text-white leading-tight">${i.name}</h4>${optsHtml}<p class="text-xs text-gray-400 mt-0.5">$${parseFloat(i.price).toFixed(2)} c/u</p></div><div class="flex flex-col items-end"><span class="text-red-400 font-bold mb-1">$${(i.price * i.qty).toFixed(2)}</span><div class="flex items-center bg-gray-900 rounded-lg"><button onclick="changeQty(${idx}, -1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white transition">-</button><span class="text-xs font-bold w-4 text-center">${i.qty}</span><button onclick="changeQty(${idx}, 1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white transition">+</button></div></div></div>`;
            }).join('');
            
            let total = cart.reduce((a,b)=>a + (parseFloat(b.price) * b.qty), 0);
            let shipping = 0;
            if(userLocation && distanceKm <= (SHOP_CONFIG.shipping?.maxRadius || 10)) {
                shipping = (total >= (SHOP_CONFIG.shipping?.freeThreshold || 999999) || distanceKm <= (SHOP_CONFIG.shipping?.freeKm || 0)) ? 0 : Math.ceil(distanceKm * (SHOP_CONFIG.shipping?.costPerKm || 0));
            }
            document.getElementById('cart-subtotal').innerText = `$${total.toFixed(2)}`;
            document.getElementById('cart-shipping').innerText = userLocation ? `$${shipping}` : "--";
            document.getElementById('cart-total').innerText = `$${(total + shipping).toFixed(2)}`;
            
            if(cart.length>0) document.getElementById('checkout-form').classList.remove('hidden');
        }
        function changeQty(index, delta) { const item = cart[index]; if(item) { item.qty += delta; if(item.qty <= 0) cart.splice(index, 1); updateCart(); } }
        function togglePay() {
            const m = document.querySelector('input[name="pay"]:checked').value;
            document.getElementById('pay-cash').classList.toggle('hidden', m!=='efectivo');
            document.getElementById('pay-trans').classList.toggle('hidden', m!=='transferencia');
        }
        function getLocation() {
            const b = event.target; b.innerText="...";
            navigator.geolocation.getCurrentPosition(p=>{
                userLocation={lat:p.coords.latitude, lng:p.coords.longitude};
                const R=6371, dL=(p.coords.latitude-(SHOP_CONFIG.coords?.lat||0))*Math.PI/180, dLo=(p.coords.longitude-(SHOP_CONFIG.coords?.lng||0))*Math.PI/180;
                const a = Math.sin(dL/2)*Math.sin(dL/2) + Math.cos((SHOP_CONFIG.coords?.lat||0)*Math.PI/180)*Math.cos(p.coords.latitude*Math.PI/180) * Math.sin(dLo/2)*Math.sin(dLo/2);
                distanceKm = R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
                document.getElementById('location-result').innerText = `A ${distanceKm.toFixed(1)}km`;
                b.innerText="GPS OK"; updateCart();
            }, ()=>alert("Error GPS"));
        }
        function handleCheckout() {
            const n = document.getElementById('cust-name').value, p = document.getElementById('cust-phone').value, a = document.getElementById('cust-address').value;
            if(!n || !p || !a) return alert("Faltan datos");
            
            let paymentMethod = "Transferencia";
            const payRadio = document.querySelector('input[name="pay"]:checked');
            if(payRadio) { paymentMethod = payRadio.value === 'efectivo' ? 'Efectivo' : 'Transferencia'; }

            let m = `*PEDIDO ${SHOP_CONFIG.name}*\nCliente: ${n}\nTel: ${p}\nDir: ${a}\nPago: ${paymentMethod}\n\n`;
            cart.forEach(i=> {
                const optsTxt = i.selectedOptions && i.selectedOptions.length > 0 ? ` (${i.selectedOptions.join(', ')})` : '';
                m+=`${i.qty}x ${i.name}${optsTxt} $${(i.price*i.qty).toFixed(2)}\n`
            });
            m+=`\nTotal: ${document.getElementById('cart-total').innerText}`;
            window.open(`https://wa.me/521${SHOP_CONFIG.whatsapp}?text=${encodeURIComponent(m)}`, '_blank');
            if(socket) socket.emit('register-order', SHOP_SLUG);
        }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.style.opacity=1; t.style.transform='translate(-50%,0)'; setTimeout(()=>{t.style.opacity=0; t.style.transform='translate(-50%,20px)'},2000); }
        function resetIdleTimer() { clearTimeout(idleTimer); if(!idleWarningShown) idleTimer=setTimeout(()=>{showToast("ü§ñ ¬øIndeciso? ¬°Preg√∫ntale al Chef!"); idleWarningShown=true}, 15000); }
    </script>
</body>
</html>
