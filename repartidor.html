<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Repartidor | Men√∫IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest-repartidor.json">
    <meta name="theme-color" content="#ea580c">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            /* App like feel */
        }

        /* Slide to Accept Animation */
        .slide-track {
            background: linear-gradient(to right, #10b981 50%, #e5e7eb 50%);
            background-size: 200% 100%;
            background-position: 100% 0;
            transition: background-position 0.1s;
        }

        .slide-track.active {
            background-position: 0 0;
        }

        /* Map Full Height */
        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
        }

        /* Bottom Sheet Effect */
        .bottom-sheet {
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem 1.5rem 0 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 h-[100dvh] w-screen relative overflow-hidden">

    <!-- AUTH SCREEN -->
    <div id="auth-screen"
        class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 bg-cover bg-center"
        style="background-image: url('https://images.unsplash.com/photo-1617347454431-f49d7ff5c3b1?q=80&w=2000&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

        <!-- Install Button (Auth) -->
        <button id="pwa-install-btn"
            class="hidden absolute top-6 right-6 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-full text-xs font-bold backdrop-blur-md transition flex items-center gap-2 z-20"
            onclick="installPWA()">
            <i class="fa-solid fa-download"></i> Instalar App
        </button>

        <div class="relative z-10 w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl">
            <div
                class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center text-white text-3xl mb-6 shadow-lg mx-auto">
                <i class="fa-solid fa-motorcycle"></i>
            </div>

            <h1 class="text-2xl font-bold text-center mb-2">Convi√©rtete en Repartidor</h1>
            <p class="text-gray-400 text-center text-sm mb-8">Gana dinero entregando pedidos en tu zona.</p>

            <!-- TABS -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchAuth('login')" id="tab-login"
                    class="flex-1 pb-3 text-sm font-bold border-b-2 border-orange-500 text-orange-600 transition">Entrar</button>
                <button onclick="switchAuth('register')" id="tab-register"
                    class="flex-1 pb-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition">Registro</button>
            </div>

            <!-- LOGIN FORM -->
            <form id="form-login" onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <input type="tel" id="login-phone" placeholder="Celular (10 d√≠gitos)"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="login-pass" placeholder="Contrase√±a"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <button type="submit"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/30 transition">Iniciar
                    Sesi√≥n</button>
            </form>

            <!-- REGISTER FORM -->
            <form id="form-register" onsubmit="event.preventDefault(); handleRegister();" class="space-y-4 hidden">
                <input type="text" id="reg-name" placeholder="Nombre Completo"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <input type="tel" id="reg-phone" placeholder="Celular"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="reg-pass" placeholder="Contrase√±a"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <select id="reg-vehicle"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="Moto">Motocicleta üèçÔ∏è</option>
                    <option value="Bici">Bicicleta üö≤</option>
                    <option value="Auto">Autom√≥vil üöó</option>
                </select>
                <button type="submit"
                    class="w-full bg-black hover:bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg transition">Registrarme</button>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard-screen" class="hidden absolute inset-0 flex flex-col h-full w-full">
        <!-- HEADER OVERLAY -->
        <div class="absolute top-0 left-0 right-0 z-[20] p-4 flex justify-between items-center pointer-events-none">

            <!-- EX-INSTALL BUTTON WAS HERE -->

            <!-- Profile/Stats -->
            <div
                class="bg-white/90 backdrop-blur-md rounded-2xl p-2 pr-4 flex items-center gap-3 shadow-lg pointer-events-auto">
                <div class="w-10 h-10 bg-gray-200 rounded-xl flex items-center justify-center text-gray-500">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div>
                    <h4 class="font-bold text-xs" id="dash-name">Repartidor</h4>
                    <p class="text-[10px] text-green-600 font-bold">Ganado: $<span id="dash-earnings">0.00</span></p>
                </div>
            </div>

            <div class="flex items-center gap-2 pointer-events-auto">
                <!-- Install Button (Dash) MOVED HERE -->
                <button id="pwa-install-dash-btn" onclick="installPWA()"
                    class="hidden bg-orange-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg animate-pulse">
                    <i class="fa-solid fa-download"></i>
                </button>

                <!-- Status Pill -->
                <div
                    class="bg-black/80 backdrop-blur-md text-white rounded-full px-3 py-2 flex items-center gap-2 shadow-lg">
                    <div id="status-dot" class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-xs font-bold" id="status-text">Desconectado</span>
                </div>
            </div>
        </div>
        <div id="status-dot" class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        <span class="text-xs font-bold" id="status-text">Desconectado</span>
    </div>
    </div>

    <!-- MAP CONTAINER -->
    <div id="map" class="flex-1 bg-gray-200"></div>

    <!-- BOTTOM CONTROLS (Offline/Online) -->
    <div id="bottom-controls" class="absolute bottom-10 left-6 right-6 z-[20] transition-all duration-300">
        <button id="go-online-btn" onclick="toggleOnline()"
            class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg py-4 rounded-full shadow-xl shadow-orange-500/40 transition transform active:scale-95 flex items-center justify-center gap-2">
            <i class="fa-solid fa-power-off"></i> CONECTARSE
        </button>
    </div>
    </div>

    <!-- AUDIO NOTIFICATION -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop
        preload="auto"></audio>

    <!-- NEW ORDER REQUEST MODAL (Draggable style) -->
    <div id="request-modal"
        class="hidden absolute inset-0 z-[60] flex flex-col justify-end bg-black/40 backdrop-blur-[2px]">
        <div class="bg-white m-4 rounded-3xl p-5 shadow-2xl animate-bounce-up">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <div>
                    <span
                        class="bg-green-100 text-green-700 font-bold text-xs px-2 py-1 rounded inline-block mb-1">Nueva
                        Solicitud</span>
                    <h2 class="text-2xl font-extrabold">$35.00</h2>
                    <p class="text-xs text-gray-400">Ganancia estimada (incluye propina)</p>
                </div>
                <div class="w-12 h-12 rounded-full border-4 border-orange-500 flex items-center justify-center font-bold text-orange-600"
                    id="request-timer">30</div>
            </div>

            <!-- Route Info -->
            <div class="relative pl-6 space-y-6 mb-6">
                <!-- Line -->
                <div class="absolute left-2 top-2 bottom-4 w-0.5 bg-gray-200"></div>

                <!-- Store -->
                <div class="relative">
                    <div class="absolute -left-6 w-4 h-4 rounded-full bg-black border-2 border-white"></div>
                    <h3 class="font-bold text-sm" id="req-store-name">Restaurante</h3>
                    <p class="text-xs text-gray-500 truncate" id="req-store-address">Calle 10...</p>
                    <span class="text-[10px] bg-gray-100 px-1 rounded text-gray-500" id="req-distance">2.5 km</span>
                </div>

                <!-- Customer -->
                <div class="relative">
                    <div class="absolute -left-6 w-4 h-4 rounded-full bg-orange-500 border-2 border-white"></div>
                    <h3 class="font-bold text-sm">Cliente</h3>
                    <p class="text-xs text-gray-500 truncate" id="req-cust-address">Calle 25...</p>
                </div>
            </div>

            <!-- Swipe Button (Mock) -->
            <button onclick="acceptOrder()"
                class="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center"><i
                        class="fa-solid fa-check"></i></div>
                Aceptar Pedido
            </button>
            <button onclick="ignoreOrder()" class="w-full mt-3 py-2 text-xs font-bold text-gray-400">Ignorar</button>
        </div>
    </div>

    <!-- ACTIVE ORDER PANEL -->
    <div id="active-panel"
        class="hidden absolute bottom-0 left-0 right-0 z-[30] bg-white rounded-t-[2rem] shadow-[0_-5px_30px_rgba(0,0,0,0.15)] flex flex-col transition-all duration-300 max-h-[85vh]">
        <!-- Drag Handle -->
        <div class="w-full flex justify-center py-3 cursor-pointer" onclick="togglePanelHeight()">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <div class="px-6 pb-6 overflow-y-auto">
            <!-- Header Status -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="font-bold text-xl text-slate-800" id="active-status-title">Yendo a Tienda</h2>
                    <p class="text-xs text-gray-500">Orden #<span id="active-order-ref">...</span></p>
                </div>
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm cursor-pointer"
                    onclick="callContact()">
                    <i class="fa-solid fa-phone"></i>
                </div>
            </div>

            <!-- Action Button Dynamic -->
            <div class="mb-6">
                <!-- Navigation -->
                <a id="nav-btn" href="#" target="_blank"
                    class="block w-full bg-blue-600 text-white text-center font-bold py-3 rounded-xl mb-3 shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-location-arrow mr-2"></i> Navegar
                </a>

                <!-- Step Action -->
                <button id="step-action-btn"
                    class="w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/30 text-lg active:scale-95 transition">
                    Llegu√© a Tienda
                </button>
            </div>

            <!-- Details List -->
            <div class="border-t border-gray-100 pt-4">
                <h3 class="font-bold text-sm mb-3">Detalles</h3>
                <div id="active-items-list" class="space-y-3 text-sm text-gray-600">
                    <!-- Items -->
                </div>

                <div class="mt-4 bg-yellow-50 p-3 rounded-lg flex gap-3 items-start">
                    <i class="fa-regular fa-note-sticky text-yellow-600 mt-1"></i>
                    <div>
                        <p class="font-bold text-xs text-yellow-800">Nota del Cliente:</p>
                        <p class="text-xs text-yellow-700 italic" id="active-note">Sin notas.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://menuia.onrender.com";
        // const API_URL = "http://localhost:3000";

        const socket = io(API_URL);
        let CURRENT_DRIVER = JSON.parse(localStorage.getItem('menuia_driver')) || null;
        let IS_ONLINE = false;
        let CURRENT_ORDER = null;
        let MAP_INSTANCE = null;
        let DRIVER_MARKER = null;
        let PENDING_ORDER = null;

        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            if (CURRENT_DRIVER) {
                initMap();
                showDashboard();
            }
        });

        // --- AUTH ---
        function switchAuth(type) {
            document.getElementById('form-login').classList.toggle('hidden', type !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', type !== 'register');

            document.getElementById('tab-login').className = type === 'login' ? 'flex-1 pb-3 text-sm font-bold border-b-2 border-orange-500 text-orange-600 transition' : 'flex-1 pb-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition';
            document.getElementById('tab-register').className = type === 'register' ? 'flex-1 pb-3 text-sm font-bold border-b-2 border-orange-500 text-orange-600 transition' : 'flex-1 pb-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition';
        }

        function initAuth() {
            if (CURRENT_DRIVER) {
                document.getElementById('auth-screen').classList.add('hidden');
                updateProfileUI();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        async function handleLogin() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-pass').value;

            try {
                const res = await fetch(`${API_URL}/api/driver/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, password })
                });
                const data = await res.json();
                if (data.success) {
                    CURRENT_DRIVER = data.driver;
                    // Persist password for auto-login logic if needed, or secure token
                    CURRENT_DRIVER.password = password;
                    localStorage.setItem('menuia_driver', JSON.stringify(CURRENT_DRIVER));
                    initAuth();
                    initMap();
                    showDashboard();

                    // Socket login
                    socket.emit('driver-login', { phone, password });
                } else {
                    alert(data.error);
                }
            } catch (e) { alert("Error de conexi√≥n"); }
        }

        async function handleRegister() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const password = document.getElementById('reg-pass').value;
            const vehicle = document.getElementById('reg-vehicle').value;

            try {
                const res = await fetch(`${API_URL}/api/driver/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone, password, vehicle })
                });
                const data = await res.json();
                if (data.success) {
                    alert("Registro exitoso. Por favor ingresa.");
                    switchAuth('login');
                } else {
                    alert(data.error);
                }
            } catch (e) { alert("Error al registrar"); }
        }

        function updateProfileUI() {
            document.getElementById('dash-name').innerText = CURRENT_DRIVER.name;
            // Fetch earnings if needed
        }

        // --- DASHBOARD & MAP ---
        function showDashboard() {
            document.getElementById('dashboard-screen').classList.remove('hidden');
            setTimeout(() => {
                MAP_INSTANCE.invalidateSize();
            }, 100);
        }

        function initMap() {
            if (MAP_INSTANCE) return;
            // Default: Guadalajara
            MAP_INSTANCE = L.map('map', { zoomControl: false }).setView([20.659698, -103.349609], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(MAP_INSTANCE);

            // Get Real Location
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const latlng = [lat, lng];

                    if (!DRIVER_MARKER) {
                        const icon = L.divIcon({
                            html: `<div class="w-8 h-8 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-white"><i class="fa-solid fa-location-arrow transform -rotate-45"></i></div>`,
                            className: 'bg-transparent',
                            iconSize: [32, 32]
                        });
                        DRIVER_MARKER = L.marker(latlng, { icon: icon }).addTo(MAP_INSTANCE);
                        MAP_INSTANCE.setView(latlng, 15);
                    } else {
                        DRIVER_MARKER.setLatLng(latlng);
                    }

                    // Update Server
                    if (IS_ONLINE && CURRENT_DRIVER) {
                        socket.emit('driver-location', {
                            driverId: CURRENT_DRIVER._id, lat, lng
                        });
                    }
                }, err => console.error(err), { enableHighAccuracy: true });
            }
        }

        // --- CONTROLS ---
        function toggleOnline() {
            const btn = document.getElementById('go-online-btn');
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');

            if (!IS_ONLINE) {
                // GO ONLINE
                IS_ONLINE = true;
                btn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
                btn.innerHTML = `<i class="fa-solid fa-pause"></i> DESCONECTARSE`;

                dot.classList.remove('bg-red-500');
                dot.classList.add('bg-green-500');
                txt.innerText = "En L√≠nea - Buscando pedidos...";

                socket.emit('driver-online', CURRENT_DRIVER._id);
            } else {
                // GO OFFLINE
                IS_ONLINE = false;
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                btn.innerHTML = `<i class="fa-solid fa-power-off"></i> CONECTARSE`;

                dot.classList.remove('bg-green-500');
                dot.classList.add('bg-red-500');
                txt.innerText = "Desconectado";

                socket.emit('driver-offline', CURRENT_DRIVER._id);
            }
        }

        // --- SOCKET LOGIC ---
        socket.on('new-request', (order) => {
            if (!IS_ONLINE || CURRENT_ORDER) return;

            // Check if already ignored locally
            if (localStorage.getItem(`ignored_${order._id}`)) return;

            console.log("Nueva solicitud:", order);
            PENDING_ORDER = order;
            showRequestModal(order);
        });

        socket.on('order-accepted', (order) => {
            // Confirm from server
            CURRENT_ORDER = order;
            renderActivePanel(order);
        });

        socket.on('order-taken', (data) => {
            alert(data.message);
            closeRequestModal();
        });

        socket.on('order-step-updated', ({ orderId, step }) => {
            if (CURRENT_ORDER && CURRENT_ORDER._id === orderId) {
                CURRENT_ORDER.deliveryStatus = step;
                if (step === 'delivered') {
                    finishOrder();
                } else {
                    renderActivePanel(CURRENT_ORDER);
                }
            }
        });

        // --- REQUEST UI ---
        let requestTimerInterval;

        function showRequestModal(order) {
            document.getElementById('req-store-name').innerText = order.shopSlug; // Ideally Name
            document.getElementById('req-store-address').innerText = "Ver mapa";
            document.getElementById('req-cust-address').innerText = order.address.substring(0, 30) + "...";
            document.getElementById('request-modal').classList.remove('hidden');

            // TIMER PERSISTENCE LOGIC
            let storedExpiry = localStorage.getItem(`timer_${order._id}`);

            // If no timer exists, make one (30s from now)
            if (!storedExpiry) {
                storedExpiry = Date.now() + 30000;
                localStorage.setItem(`timer_${order._id}`, storedExpiry);
            }

            // If timer expired already?
            if (Date.now() > parseInt(storedExpiry)) {
                ignoreOrder();
                return;
            }


            // Play Sound
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio play prevented:", e));
            }

            startCountdown(parseInt(storedExpiry));
        }

        function startCountdown(expiryTime) {
            clearInterval(requestTimerInterval);
            const timerEl = document.getElementById('request-timer');

            const tick = () => {
                const now = Date.now();
                const remaining = Math.ceil((expiryTime - now) / 1000);

                if (remaining <= 0) {
                    clearInterval(requestTimerInterval);
                    timerEl.innerText = "0";
                    ignoreOrder();
                } else {
                    timerEl.innerText = remaining;
                }
            };

            tick(); // run once immediately
            requestTimerInterval = setInterval(tick, 1000);
        }

        function closeRequestModal() {
            document.getElementById('request-modal').classList.add('hidden');

            // Stop Sound
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }

            clearInterval(requestTimerInterval);
            PENDING_ORDER = null;
        }

        function ignoreOrder() {
            if (PENDING_ORDER) {
                localStorage.setItem(`ignored_${PENDING_ORDER._id}`, 'true');
            }
            closeRequestModal();
        }

        function acceptOrder() {
            if (!PENDING_ORDER) return;
            socket.emit('accept-order', {
                driverId: CURRENT_DRIVER._id,
                orderId: PENDING_ORDER._id || PENDING_ORDER.id
            });
            closeRequestModal();
        }

        // --- ACTIVE ORDER UI ---
        function renderActivePanel(order) {
            const panel = document.getElementById('active-panel');
            const title = document.getElementById('active-status-title');
            const btn = document.getElementById('step-action-btn');
            const nav = document.getElementById('nav-btn');
            const list = document.getElementById('active-items-list');
            const ref = document.getElementById('active-order-ref');
            const note = document.getElementById('active-note');

            panel.classList.remove('hidden');
            document.getElementById('bottom-controls').classList.add('hidden'); // Hide online toggle

            ref.innerText = order.ref || '---';
            note.innerText = order.note || "Sin notas.";

            // Items
            list.innerHTML = order.items.map(i => `<div class="flex justify-between"><span>${i.qty}x ${i.name}</span> <span class="font-bold">$${i.price}</span></div>`).join('');

            // Steps Logic
            const status = order.deliveryStatus || 'to_store';

            if (status === 'to_store' || status === 'driver_assigned') {
                title.innerText = "Yendo al Restaurante";
                btn.innerText = "Llegu√© a Tienda";
                btn.onclick = () => updateStep('at_store');
                btn.className = "w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition";

                // Mock Store Coords (Ideally passed in order)
                nav.href = `https://www.google.com/maps/search/?api=1&query=${order.shopSlug}`;

            } else if (status === 'at_store') {
                title.innerText = "En Tienda";
                btn.innerText = "Recolectado";
                btn.onclick = () => updateStep('on_way');
                btn.className = "w-full bg-orange-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition";
                nav.classList.add('hidden');

            } else if (status === 'on_way') {
                title.innerText = "En direcci√≥n al cliente";
                btn.innerText = "Finalizar Entrega";
                btn.onclick = () => updateStep('delivered');
                btn.className = "w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition";
                nav.classList.remove('hidden');
                nav.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.address)}`;
            }
        }

        function updateStep(step) {
            socket.emit('update-order-step', {
                orderId: CURRENT_ORDER._id || CURRENT_ORDER.id,
                step: step
            });
        }

        function finishOrder() {
            alert("¬°Excelente trabajo! Entrega completada +$35.00");
            document.getElementById('active-panel').classList.add('hidden');
            document.getElementById('bottom-controls').classList.remove('hidden');
            CURRENT_ORDER = null;
            // Update earnings UI locally
            const earn = document.getElementById('dash-earnings');
            earn.innerText = (parseFloat(earn.innerText) + 35).toFixed(2);
        }

        function callContact() {
            if (CURRENT_ORDER) window.open(`tel:${CURRENT_ORDER.customerPhone}`);
        }

        function togglePanelHeight() {
            // Simple interaction for expanding panel if needed
        }

        // --- PWA INSTALLATION ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('pwa-install-btn');
            const dashBtn = document.getElementById('pwa-install-dash-btn');
            if (btn) btn.classList.remove('hidden');
            if (dashBtn) dashBtn.classList.remove('hidden');
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                // Buttons will be hidden by appinstalled event or next reload
            } else {
                alert("Para instalar: Busca la opci√≥n 'Agregar a pantalla de inicio' en tu navegador.");
            }
        }

        function checkInstalledState() {
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                const btn = document.getElementById('pwa-install-btn');
                const dashBtn = document.getElementById('pwa-install-dash-btn');
                if (btn) btn.classList.add('hidden');
                if (dashBtn) dashBtn.classList.add('hidden');
            }
        }

        window.addEventListener('load', checkInstalledState);
        window.addEventListener('appinstalled', () => {
            const btn = document.getElementById('pwa-install-btn');
            const dashBtn = document.getElementById('pwa-install-dash-btn');
            if (btn) btn.classList.add('hidden');
            if (dashBtn) dashBtn.classList.add('hidden');
            alert("¬°App instalada correctamente!");
        });



        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

    </script>
</body>

</html>