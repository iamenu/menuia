<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Repartidor | Men√∫IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest-repartidor.json">
    <meta name="theme-color" content="#ea580c">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            /* App like feel */
        }

        /* Slide to Accept Animation */
        .slide-track {
            background: linear-gradient(to right, #10b981 50%, #e5e7eb 50%);
            background-size: 200% 100%;
            background-position: 100% 0;
            transition: background-position 0.1s;
        }

        .slide-track.active {
            background-position: 0 0;
        }

        /* Map Full Height */
        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
        }

        /* Bottom Sheet Effect */
        .bottom-sheet {
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem 1.5rem 0 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 h-[100dvh] w-screen relative overflow-hidden">

    <!-- AUTH SCREEN -->
    <div id="auth-screen"
        class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 bg-cover bg-center"
        style="background-image: url('https://images.unsplash.com/photo-1617347454431-f49d7ff5c3b1?q=80&w=2000&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

        <!-- Install Button (Auth) -->
        <button id="pwa-install-btn"
            class="absolute top-6 right-6 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-full text-xs font-bold backdrop-blur-md transition flex items-center gap-2 z-20"
            onclick="installPWA()">
            <i class="fa-solid fa-download"></i> Instalar App
        </button>

        <div class="relative z-10 w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl">
            <div
                class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center text-white text-3xl mb-6 shadow-lg mx-auto">
                <i class="fa-solid fa-motorcycle"></i>
            </div>

            <h1 class="text-2xl font-bold text-center mb-2">Convi√©rtete en Repartidor</h1>
            <p class="text-gray-400 text-center text-sm mb-8">Gana dinero entregando pedidos en tu zona.</p>

            <!-- TABS -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="switchAuth('login')" id="tab-login"
                    class="flex-1 pb-3 text-sm font-bold border-b-2 border-orange-500 text-orange-600 transition">Entrar</button>
                <button onclick="switchAuth('register')" id="tab-register"
                    class="flex-1 pb-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition">Registro</button>
            </div>

            <!-- LOGIN FORM -->
            <form id="form-login" onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <input type="tel" id="login-phone" placeholder="Celular (10 d√≠gitos)"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="login-pass" placeholder="Contrase√±a"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <button type="submit"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/30 transition">Iniciar
                    Sesi√≥n</button>
            </form>

            <!-- REGISTER FORM -->
            <form id="form-register" onsubmit="event.preventDefault(); handleRegister();" class="space-y-4 hidden">
                <input type="text" id="reg-name" placeholder="Nombre Completo"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <input type="tel" id="reg-phone" placeholder="Celular"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="reg-pass" placeholder="Contrase√±a"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                <select id="reg-vehicle"
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="Moto">Motocicleta üèçÔ∏è</option>
                    <option value="Bici">Bicicleta üö≤</option>
                    <option value="Auto">Autom√≥vil üöó</option>
                </select>
                <button type="submit"
                    class="w-full bg-black hover:bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg transition">Registrarme</button>
            </form>
        </div>
    </div>

    <!-- NOTIFICATION TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-4 left-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard-screen" class="hidden absolute inset-0 flex flex-col h-full w-full bg-gray-50">
        <!-- TOP NAV - Rappi Style -->
        <div
            class="absolute top-0 left-0 right-0 z-[20] pt-4 pb-2 px-4 flex justify-between items-start pointer-events-none bg-gradient-to-b from-white via-white to-transparent h-24">

            <!-- Install Button (Dash) -->
            <button id="pwa-install-dash-btn" onclick="installPWA()"
                class="pointer-events-auto bg-orange-100 text-orange-600 rounded-full w-10 h-10 flex items-center justify-center shadow-sm animate-pulse active:scale-95 transition">
                <i class="fa-solid fa-download"></i>
            </button>

            <!-- Earnings Card (Floating Center) -->
            <div
                class="pointer-events-auto bg-white rounded-full px-5 py-2 shadow-[0_4px_15px_rgba(0,0,0,0.08)] flex items-center gap-3 border border-gray-100 transform translate-y-2">
                <div class="flex flex-col items-center">
                    <span class="text-[10px] uppercase font-bold text-gray-400 leading-none">Ganado Hoy</span>
                    <span class="text-lg font-black text-gray-800 tracking-tight">$<span
                            id="dash-earnings">0.00</span></span>
                </div>
            </div>

            <!-- Profile / Online Indicator -->
            <div class="pointer-events-auto relative" onclick="toggleProfileMenu()">
                <div
                    class="w-10 h-10 bg-gray-200 rounded-full overflow-hidden border-2 border-white shadow-md cursor-pointer">
                    <div class="w-full h-full flex items-center justify-center text-gray-400 bg-gray-100"><i
                            class="fa-solid fa-user"></i></div>
                </div>
                <div id="status-indicator-dot"
                    class="absolute bottom-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
            </div>

            <!-- MENU DROPDOWN (Hidden) -->
            <div id="profile-menu"
                class="hidden pointer-events-auto absolute top-20 right-4 bg-white rounded-xl shadow-xl p-2 w-48 z-50 animate-fade-in-up border border-gray-100">
                <button onclick="window.location.reload()"
                    class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-lg text-sm font-bold text-gray-700 flex items-center gap-2">
                    <i class="fa-solid fa-rotate-right text-blue-500"></i> Refrescar
                </button>
                <div class="h-px bg-gray-100 my-1"></div>
                <button onclick="openHistory()"
                    class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-lg text-sm font-bold text-gray-700 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left text-orange-500"></i> Historial
                </button>
                <div class="h-px bg-gray-100 my-1"></div>
                <!-- Auto Accept Toggle -->
                <div class="px-4 py-2 flex items-center justify-between">
                    <span class="text-xs font-bold text-gray-600">Auto-Aceptar</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-accept-toggle" class="sr-only peer"
                            onchange="toggleAutoAccept()">
                        <div
                            class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500">
                        </div>
                    </label>
                </div>
                <div class="h-px bg-gray-100 my-1"></div>
                <button onclick="logoutDriver()"
                    class="w-full text-left px-4 py-2 hover:bg-red-50 rounded-lg text-sm font-bold text-red-600 flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>

        <!-- MAP CONTAINER -->
        <div id="map" class="flex-1 bg-gray-200 z-0"></div>

        <!-- PERMISSION WARNING (Hidden by default) -->
        <div id="perm-warning"
            class="hidden absolute top-28 left-4 right-4 z-[19] bg-red-50 border border-red-100 p-3 rounded-xl flex items-center gap-3 shadow-lg animate-bounce-up">
            <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center shrink-0">
                <i class="fa-solid fa-bell-slash"></i>
            </div>
            <div class="flex-1">
                <h4 class="text-xs font-bold text-red-800">Permisos Necesarios</h4>
                <p class="text-[10px] text-red-600 leading-tight">Activa notificaciones y ubicaci√≥n para recibir
                    pedidos.</p>
            </div>
            <button onclick="requestPermissionsManual()"
                class="bg-red-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold">Activar</button>
        </div>

        <!-- BOTTOM CONTROLS (Floating Slide Button) -->
        <div id="bottom-controls" class="absolute bottom-8 left-6 right-6 z-[20] transition-all duration-300">

            <!-- Location Status Text -->
            <div class="text-center mb-4">
                <span id="connection-status-text"
                    class="px-4 py-1.5 bg-white/90 backdrop-blur rounded-full text-xs font-bold text-gray-500 shadow-sm border border-gray-100">
                    üî¥ Desconectado
                </span>
            </div>

            <button id="go-online-btn" onclick="toggleOnline()"
                class="group w-full bg-white hover:bg-gray-50 text-gray-800 font-bold text-lg p-2 rounded-[2rem] shadow-[0_8px_30px_rgba(0,0,0,0.12)] transition transform active:scale-[0.98] border border-gray-100 flex items-center relative overflow-hidden">

                <!-- Background Fill Animation -->
                <div id="btn-bg-fill"
                    class="absolute inset-0 bg-gradient-to-r from-orange-500 to-orange-600 opacity-0 transition-opacity duration-500">
                </div>

                <!-- Knob -->
                <div id="btn-knob"
                    class="absolute left-2 w-12 h-12 bg-gray-900 rounded-full text-white flex items-center justify-center shadow-lg transition-all duration-500 z-10 group-active:scale-90">
                    <i class="fa-solid fa-power-off"></i>
                </div>

                <!-- Text -->
                <span id="btn-text" class="flex-1 text-center pl-10 z-10 transition-colors duration-300">DESLIZA PARA
                    CONECTAR</span>
            </button>
        </div>
    </div>

    <!-- AUDIO NOTIFICATION -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop
        preload="auto"></audio>

    <!-- NEW ORDER REQUEST MODAL (Draggable style) -->
    <div id="request-modal"
        class="hidden absolute inset-0 z-[60] flex flex-col justify-end bg-black/40 backdrop-blur-[2px]">
        <div class="bg-white m-4 rounded-3xl p-5 shadow-2xl animate-bounce-up">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <div>
                    <span
                        class="bg-green-100 text-green-700 font-bold text-xs px-2 py-1 rounded inline-block mb-1">Nueva
                        Solicitud</span>
                    <h2 class="text-2xl font-extrabold" id="req-gain-total">$35.00</h2>
                    <p class="text-xs text-gray-400" id="req-gain-breakdown">Ganancia estimada (incluye propina)</p>
                </div>
                <div class="w-12 h-12 rounded-full border-4 border-orange-500 flex items-center justify-center font-bold text-orange-600"
                    id="request-timer">30</div>
            </div>

            <!-- Route Info -->
            <div class="relative pl-6 space-y-6 mb-6">
                <!-- Line -->
                <div class="absolute left-2 top-2 bottom-4 w-0.5 bg-gray-200"></div>

                <!-- Store -->
                <div class="relative">
                    <div class="absolute -left-6 w-4 h-4 rounded-full bg-black border-2 border-white"></div>
                    <h3 class="font-bold text-sm" id="req-store-name">Restaurante</h3>
                    <p class="text-xs text-gray-500 truncate" id="req-store-address">Calle 10...</p>
                    <span class="text-[10px] bg-gray-100 px-1 rounded text-gray-500" id="req-distance">2.5 km</span>
                </div>

                <!-- Customer -->
                <div class="relative">
                    <div class="absolute -left-6 w-4 h-4 rounded-full bg-orange-500 border-2 border-white"></div>
                    <h3 class="font-bold text-sm">Cliente</h3>
                    <p class="text-xs text-gray-500 truncate" id="req-cust-address">Calle 25...</p>
                </div>
            </div>

            <!-- Swipe Button (Mock) -->
            <button onclick="acceptOrder()"
                class="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                <div class="w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center"><i
                        class="fa-solid fa-check"></i></div>
                Aceptar Pedido
            </button>
            <button onclick="ignoreOrder()" class="w-full mt-3 py-2 text-xs font-bold text-gray-400">Ignorar</button>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="history-modal" class="hidden absolute inset-0 z-[70] bg-white flex flex-col animate-fade-in-up">
        <div class="bg-white px-4 py-4 border-b border-gray-100 flex justify-between items-center shadow-sm">
            <h2 class="text-lg font-bold text-gray-800">Historial de Pedidos</h2>
            <button onclick="document.getElementById('history-modal').classList.add('hidden')"
                class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="history-list">
            <!-- Dynamic Content -->
            <div class="animate-pulse flex space-x-4">
                <div class="flex-1 space-y-4 py-1">
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="space-y-2">
                        <div class="h-4 bg-gray-200 rounded"></div>
                        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ACTIVE ORDER PANEL -->
    <div id="active-panel"
        class="hidden absolute bottom-0 left-0 right-0 z-[30] bg-white rounded-t-[2rem] shadow-[0_-5px_30px_rgba(0,0,0,0.15)] flex flex-col transition-all duration-300 max-h-[85vh]">
        <!-- Drag Handle -->
        <div class="w-full flex justify-center py-3 cursor-pointer" onclick="togglePanelHeight()">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <div class="px-6 pb-6 overflow-y-auto">
            <!-- Header Status -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="font-bold text-xl text-slate-800" id="active-status-title">Yendo a Tienda</h2>
                    <p class="text-xs text-gray-500">Orden #<span id="active-order-ref">...</span></p>
                </div>
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm cursor-pointer"
                    onclick="callContact()">
                    <i class="fa-solid fa-phone"></i>
                </div>
            </div>

            <!-- Action Button Dynamic -->
            <div class="mb-6">
                <!-- Navigation -->
                <a id="nav-btn" href="#" target="_blank"
                    class="block w-full bg-blue-600 text-white text-center font-bold py-3 rounded-xl mb-3 shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-location-arrow mr-2"></i> Navegar
                </a>

                <!-- Step Action -->
                <button id="step-action-btn"
                    class="w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/30 text-lg active:scale-95 transition">
                    Llegu√© a Tienda
                </button>
            </div>

            <!-- Details List -->
            <div class="border-t border-gray-100 pt-4">
                <h3 class="font-bold text-sm mb-3">Detalles</h3>
                <div id="active-items-list" class="space-y-3 text-sm text-gray-600">
                    <!-- Items -->
                </div>

                <div class="mt-4 bg-yellow-50 p-3 rounded-lg flex gap-3 items-start">
                    <i class="fa-regular fa-note-sticky text-yellow-600 mt-1"></i>
                    <div>
                        <p class="font-bold text-xs text-yellow-800">Nota del Cliente:</p>
                        <p class="text-xs text-yellow-700 italic" id="active-note">Sin notas.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://menuia.onrender.com";
        // const API_URL = "http://localhost:3000";

        const socket = io(API_URL);
        let CURRENT_DRIVER = JSON.parse(localStorage.getItem('menuia_driver')) || null;
        let IS_ONLINE = localStorage.getItem('menuia_driver_online') === 'true';
        let AUTO_ACCEPT = localStorage.getItem('menuia_auto_accept') === 'true'; // Auto Accept State

        let CURRENT_ORDER = null;
        let MAP_INSTANCE = null;
        let DRIVER_MARKER = null;
        let PENDING_ORDER = null;

        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            if (CURRENT_DRIVER) {
                initMap();
                showDashboard();

                // RESTORE ONLINE STATE
                if (IS_ONLINE) {
                    updateOnlineUI(true);
                    socket.emit('driver-online', CURRENT_DRIVER._id);
                }
                // Restore auto-accept toggle state
                document.getElementById('auto-accept-toggle').checked = AUTO_ACCEPT;
            }
        });

        // --- AUTH ---
        function switchAuth(type) {
            document.getElementById('form-login').classList.toggle('hidden', type !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', type !== 'register');

            document.getElementById('tab-login').className = type === 'login' ? 'flex-1 pb-3 text-sm font-bold border-b-2 border-orange-500 text-orange-600 transition' : 'flex-1 pb-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition';
            document.getElementById('tab-register').className = type === 'register' ? 'flex-1 pb-3 text-sm font-bold border-b-2 border-orange-500 text-orange-600 transition' : 'flex-1 pb-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition';
        }

        function initAuth() {
            if (CURRENT_DRIVER) {
                document.getElementById('auth-screen').classList.add('hidden');
                updateProfileUI();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        // --- TOAST NOTIFICATIONS ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const styles = {
                success: 'bg-green-500 text-white shadow-green-500/30',
                error: 'bg-red-500 text-white shadow-red-500/30',
                info: 'bg-blue-600 text-white shadow-blue-500/30'
            };

            const icons = {
                success: '<i class="fa-solid fa-check-circle text-lg"></i>',
                error: '<i class="fa-solid fa-circle-exclamation text-lg"></i>',
                info: '<i class="fa-solid fa-info-circle text-lg"></i>'
            };

            toast.className = `${styles[type]} px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 transform translate-y-[-20px] opacity-0 transition-all duration-300 animate-slide-in-down pointer-events-auto min-w-[300px] mx-auto`;
            toast.innerHTML = `
                <div>${icons[type]}</div>
                <div class="font-bold text-sm bg-transparent">${message}</div>
            `;

            container.appendChild(toast);

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-[-20px]', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        // --- OLD ALERT REPLACEMENTS ---
        window.alert = function (msg) { showNotification(msg, 'info'); }

        async function handleLogin() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-pass').value;

            try {
                const res = await fetch(`${API_URL}/api/driver/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, password })
                });
                const data = await res.json();
                if (data.success) {
                    CURRENT_DRIVER = data.driver;
                    // Persist password for auto-login logic if needed, or secure token
                    CURRENT_DRIVER.password = password;
                    localStorage.setItem('menuia_driver', JSON.stringify(CURRENT_DRIVER));
                    initAuth();
                    initMap();
                    showDashboard();

                    // Socket login
                    socket.emit('driver-login', { phone, password });

                    // Restore online if was online
                    if (IS_ONLINE) {
                        socket.emit('driver-online', CURRENT_DRIVER._id);
                    }
                    showNotification("¬°Bienvenido de nuevo!", "success");

                } else {
                    showNotification(data.error, "error");
                }
            } catch (e) { showNotification("Error de conexi√≥n", "error"); }
        }

        async function handleRegister() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const password = document.getElementById('reg-pass').value;
            const vehicle = document.getElementById('reg-vehicle').value;

            try {
                const res = await fetch(`${API_URL}/api/driver/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone, password, vehicle })
                });
                const data = await res.json();
                if (data.success) {
                    showNotification("Registro exitoso. Por favor ingresa.", "success");
                    switchAuth('login');
                } else {
                    showNotification(data.error, "error");
                }
            } catch (e) { showNotification("Error al registrar", "error"); }
        }

        function updateProfileUI() {
            const nameEl = document.getElementById('dash-name');
            const earnEl = document.getElementById('dash-earnings');
            if (CURRENT_DRIVER) {
                if (nameEl) nameEl.innerText = CURRENT_DRIVER.name;
                if (earnEl) earnEl.innerText = (CURRENT_DRIVER.earnings || 0).toFixed(2);
            }
        }

        // --- DASHBOARD & MAP ---
        function showDashboard() {
            document.getElementById('dashboard-screen').classList.remove('hidden');
            setTimeout(() => {
                MAP_INSTANCE.invalidateSize();
            }, 100);
        }

        function initMap() {
            if (MAP_INSTANCE) return;
            // Default: Guadalajara
            MAP_INSTANCE = L.map('map', { zoomControl: false }).setView([20.659698, -103.349609], 13);

            // GOOGLE MAPS TILES (Streets)
            L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                attribution: '&copy; Google Maps',
                maxZoom: 20
            }).addTo(MAP_INSTANCE);

            // Get Real Location
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const latlng = [lat, lng];

                    if (!DRIVER_MARKER) {
                        const icon = L.divIcon({
                            html: `<div class="w-8 h-8 bg-blue-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-white"><i class="fa-solid fa-location-arrow transform -rotate-45"></i></div>`,
                            className: 'bg-transparent',
                            iconSize: [32, 32]
                        });
                        DRIVER_MARKER = L.marker(latlng, { icon: icon }).addTo(MAP_INSTANCE);
                        MAP_INSTANCE.setView(latlng, 15);
                    } else {
                        DRIVER_MARKER.setLatLng(latlng);
                    }

                    // Update Server
                    if (IS_ONLINE && CURRENT_DRIVER) {
                        socket.emit('driver-location', {
                            driverId: CURRENT_DRIVER._id, lat, lng
                        });
                    }
                }, err => console.error(err), { enableHighAccuracy: true });
            }
        }

        // --- CONTROLS REFACTORED (Modern UI + Permissions) ---
        let WAKE_LOCK = null;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    WAKE_LOCK = await navigator.wakeLock.request('screen');
                    console.log('üí° Screen Wake Lock active');
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }

        async function releaseWakeLock() {
            if (WAKE_LOCK) {
                await WAKE_LOCK.release();
                WAKE_LOCK = null;
                console.log('üí° Screen Wake Lock released');
            }
        }

        // --- AUDIO HELPERS ---
        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.error("Error playing sound (Autoplay blocked?):", e));
            }
        }

        function stopNotificationSound() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        function toggleOnline() {
            // UNLOCK AUDIO CONTEXT ON USER CLICK
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }).catch(() => { });
            }

            // Permission Check before Going Online
            if (!IS_ONLINE) {
                // Request Notifications
                if (Notification.permission === 'default' || Notification.permission === 'denied') {
                    Notification.requestPermission().then(p => {
                        if (p === 'granted') document.getElementById('perm-warning').classList.add('hidden');
                    });
                }
            }

            // Toggle Logic
            IS_ONLINE = !IS_ONLINE;
            localStorage.setItem('menuia_driver_online', IS_ONLINE);
            updateOnlineUI(IS_ONLINE);

            if (IS_ONLINE) {
                socket.emit('driver-online', CURRENT_DRIVER._id);
                // Keep Screen Awake
                requestWakeLock();
            } else {
                socket.emit('driver-offline', CURRENT_DRIVER._id);
                releaseWakeLock();
            }
        }

        // NEW FEATURES LOGIC
        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('hidden');
        }

        function toggleAutoAccept() {
            AUTO_ACCEPT = document.getElementById('auto-accept-toggle').checked;
            localStorage.setItem('menuia_auto_accept', AUTO_ACCEPT);
            // Optional: visual feedback toast
        }

        function logoutDriver() {
            if (confirm("¬øCerrar sesi√≥n?")) {
                localStorage.removeItem('menuia_driver');
                localStorage.removeItem('menuia_driver_online');
                window.location.reload();
            }
        }

        function requestPermissionsManual() {
            Notification.requestPermission().then(p => {
                if (p === 'granted') document.getElementById('perm-warning').classList.add('hidden');
            });
        }

        function updateOnlineUI(isOnline) {
            const btnBg = document.getElementById('btn-bg-fill');
            const btnKnob = document.getElementById('btn-knob');
            const btnText = document.getElementById('btn-text');
            const statusText = document.getElementById('connection-status-text');
            const statusDot = document.getElementById('status-indicator-dot');

            if (isOnline) {
                // Online State Styles
                btnBg.classList.remove('opacity-0');
                btnBg.classList.add('opacity-100');

                // Knob Move Right
                // Using Tailwind utility for translation via style or class if configured. simple toggle here:
                btnKnob.style.transform = "translateX(calc(100vw - 6rem))"; // Rough approx or better calc needed
                // Better: Just float right within container using flex? No, absolute.
                // Resetting transform to be computed relative to parent width
                const parentW = document.getElementById('go-online-btn').offsetWidth;
                btnKnob.style.transform = `translateX(${parentW - 56}px)`; // 56px = 12(3rem) + 4px padding
                btnKnob.innerHTML = '<i class="fa-solid fa-bolt"></i>';
                btnKnob.classList.replace('bg-gray-900', 'bg-white');
                btnKnob.classList.replace('text-white', 'text-orange-600');

                btnText.innerText = "EN L√çNEA";
                btnText.classList.replace('text-gray-800', 'text-white');

                statusText.innerHTML = 'üü¢ En L√≠nea ‚Ä¢ Alta Demanda';
                statusText.classList.replace('text-gray-500', 'text-green-600');
                statusText.classList.add('bg-green-50', 'border-green-200');

                statusDot.classList.replace('bg-red-500', 'bg-green-500');
                statusDot.classList.add('animate-pulse');

            } else {
                // Offline State Styles
                btnBg.classList.remove('opacity-100');
                btnBg.classList.add('opacity-0');

                btnKnob.style.transform = "translateX(0)";
                btnKnob.innerHTML = '<i class="fa-solid fa-power-off"></i>';
                btnKnob.classList.replace('bg-white', 'bg-gray-900');
                btnKnob.classList.replace('text-orange-600', 'text-white');

                btnText.innerText = "DESLIZA PARA CONECTAR";
                btnText.classList.replace('text-white', 'text-gray-800');

                statusText.innerHTML = 'üî¥ Desconectado';
                statusText.classList.replace('text-green-600', 'text-gray-500');
                statusText.classList.remove('bg-green-50', 'border-green-200');

                statusDot.classList.replace('bg-green-500', 'bg-red-500');
                statusDot.classList.remove('animate-pulse');
            }
        }

        // --- SOCKET LOGIC ---
        socket.on('new-request', (order) => {
            if (!IS_ONLINE || CURRENT_ORDER) return;

            // Check if already ignored locally
            if (localStorage.getItem(`ignored_${order._id}`)) return;

            // Auto-Accept Logic
            if (AUTO_ACCEPT) {
                console.log("‚ö° Auto-accepting order:", order._id);
                PENDING_ORDER = order; // Need to set this for acceptOrder to work
                acceptOrder();
                return;
            }

            console.log("Nueva solicitud:", order);
            PENDING_ORDER = order;
            playNotificationSound(); // PLAY SOUND HERE
            showNotification("¬°Nueva Solicitud de Pedido!", "success");

            // SYSTEM NOTIFICATION (Background/Lock Screen)
            if (Notification.permission === "granted") {
                try {
                    // Stop any previous
                    navigator.serviceWorker.getRegistration().then(reg => {
                        const title = "¬°NUEVO PEDIDO DISPONIBLE! üçî";
                        const options = {
                            body: `Ganancia: $${((order.costs?.shipping || 35) + (order.costs?.tip || 0)).toFixed(2)} - ${order.shopName || 'Restaurante'}`,
                            icon: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
                            vibrate: [200, 100, 200, 100, 200],
                            tag: 'new-order-request',
                            renotify: true,
                            requireInteraction: true, // Persist until clicked
                            data: { url: window.location.href }
                        };

                        // Try SW Notification first (More reliable on Android)
                        if (reg) {
                            reg.showNotification(title, options);
                        } else {
                            new Notification(title, options);
                        }
                    });
                } catch (e) { console.error("Notification Error:", e); }
            }

            showRequestModal(order);
        });

        // HANDLE SYNC: If taken by another driver
        socket.on('order-taken', (data) => {
            // If we are looking at this order in modal, close it
            if (PENDING_ORDER && (PENDING_ORDER._id === data.orderId || PENDING_ORDER.id === data.orderId)) {
                stopNotificationSound(); // Stop Sound if taken
                closeRequestModal();
                showNotification(data.message || "Pedido ya tomado.", "info");
            }
        });

        socket.on('order-accepted', (order) => {
            // Confirm from server
            CURRENT_ORDER = order;
            renderActivePanel(order);
        });

        socket.on('order-taken', (data) => {
            alert(data.message);
            closeRequestModal();
        });

        socket.on('order-step-updated', ({ orderId, step }) => {
            if (CURRENT_ORDER && CURRENT_ORDER._id === orderId) {
                CURRENT_ORDER.deliveryStatus = step;
                if (step === 'delivered') {
                    finishOrder();
                } else {
                    renderActivePanel(CURRENT_ORDER);
                }
            }
        });

        // --- REQUEST UI ---
        let requestTimerInterval;

        function showRequestModal(order) {
            document.getElementById('req-store-name').innerText = order.shopName || "Restaurante";
            document.getElementById('req-store-address').innerText = "Ver mapa";
            document.getElementById('req-cust-address').innerText = order.address.substring(0, 30) + "...";

            // CALCULATE TOTAL GAIN (Shipping + Tip)
            const shipping = order.costs?.shipping || 35;
            const tip = order.costs?.tip || 0;
            const totalGain = shipping + tip;

            document.getElementById('req-gain-total').innerText = `$${totalGain.toFixed(2)}`;
            document.getElementById('req-gain-breakdown').innerText = `Env√≠o $${shipping} + Propina $${tip}`;

            // CALCULATE DISTANCE
            let distanceStr = "-- km";
            if (order.shopCoords && CURRENT_DRIVER && CURRENT_DRIVER.currentLocation) {
                const d = calculateDistance(
                    CURRENT_DRIVER.currentLocation.lat, CURRENT_DRIVER.currentLocation.lng,
                    order.shopCoords.lat, order.shopCoords.lng
                );
                distanceStr = `${d} km`;
            }
            document.getElementById('req-distance').innerText = distanceStr;

            document.getElementById('request-modal').classList.remove('hidden');

            // ... TIMER LOGIC ...
            let storedExpiry = localStorage.getItem(`timer_${order._id}`);

            // If no timer exists, make one (30s from now)
            if (!storedExpiry) {
                storedExpiry = Date.now() + 30000;
                localStorage.setItem(`timer_${order._id}`, storedExpiry);
            }

            // If timer expired already?
            if (Date.now() > parseInt(storedExpiry)) {
                ignoreOrder();
                return;
            }


            // Play Sound
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio play prevented:", e));
            }

            startCountdown(parseInt(storedExpiry));
        }

        function startCountdown(expiryTime) {
            clearInterval(requestTimerInterval);
            const timerEl = document.getElementById('request-timer');

            const tick = () => {
                const now = Date.now();
                const remaining = Math.ceil((expiryTime - now) / 1000);

                if (remaining <= 0) {
                    clearInterval(requestTimerInterval);
                    timerEl.innerText = "0";
                    ignoreOrder();
                } else {
                    timerEl.innerText = remaining;
                }
            };

            tick(); // run once immediately
            requestTimerInterval = setInterval(tick, 1000);
        }

        function closeRequestModal() {
            document.getElementById('request-modal').classList.add('hidden');

            // Stop Sound
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }

            clearInterval(requestTimerInterval);
            PENDING_ORDER = null;
        }

        function ignoreOrder() {
            stopNotificationSound(); // Stop Sound
            if (PENDING_ORDER) {
                localStorage.setItem(`ignored_${PENDING_ORDER._id}`, 'true');
            }
            closeRequestModal();
        }

        function acceptOrder() {
            stopNotificationSound(); // Stop Sound
            if (!PENDING_ORDER) return;
            socket.emit('accept-order', {
                driverId: CURRENT_DRIVER._id,
                orderId: PENDING_ORDER._id || PENDING_ORDER.id
            });
            closeRequestModal();
        }

        // --- ACTIVE ORDER UI ---
        function renderActivePanel(order) {
            const panel = document.getElementById('active-panel');
            const title = document.getElementById('active-status-title');
            const btn = document.getElementById('step-action-btn');
            const nav = document.getElementById('nav-btn');
            const list = document.getElementById('active-items-list');
            const ref = document.getElementById('active-order-ref');
            const note = document.getElementById('active-note');

            panel.classList.remove('hidden');
            document.getElementById('bottom-controls').classList.add('hidden'); // Hide online toggle

            ref.innerText = order.ref || '---';
            note.innerText = order.note || "Sin notas.";

            // Items
            list.innerHTML = order.items.map(i => `<div class="flex justify-between"><span>${i.qty}x ${i.name}</span> <span class="font-bold">$${i.price}</span></div>`).join('');

            // Steps Logic
            const status = order.deliveryStatus || 'to_store';

            if (status === 'to_store' || status === 'driver_assigned') {
                title.innerText = "Yendo al Restaurante";
                btn.innerText = "Llegu√© a Tienda";
                btn.onclick = () => updateStep('at_store');
                btn.className = "w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition";

                // Mock Store Coords (Ideally passed in order)
                nav.href = `https://www.google.com/maps/search/?api=1&query=${order.shopSlug}`;

            } else if (status === 'at_store') {
                title.innerText = "En Tienda";
                btn.innerText = "Recolectado";
                btn.onclick = () => updateStep('on_way');
                btn.className = "w-full bg-orange-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition";
                nav.classList.add('hidden');

            } else if (status === 'on_way') {
                title.innerText = "En direcci√≥n al cliente";
                btn.innerText = "Finalizar Entrega";
                btn.onclick = () => updateStep('delivered');
                btn.className = "w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition";
                nav.classList.remove('hidden');
                nav.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.address)}`;
            }
        }

        function updateStep(step) {
            socket.emit('update-order-step', {
                orderId: CURRENT_ORDER._id || CURRENT_ORDER.id,
                step: step
            });
        }

        function finishOrder(orderArg) {
            const order = orderArg || CURRENT_ORDER;
            if (!order) return;

            const totalGain = (order.costs?.shipping || 35) + (order.costs?.tip || 0);
            showNotification(`¬°Excelente trabajo! Entrega completada +$${totalGain.toFixed(2)}`, "success");

            document.getElementById('active-panel').classList.add('hidden');
            document.getElementById('bottom-controls').classList.remove('hidden');
            CURRENT_ORDER = null;

            // Update earnings UI locally & PERSIST
            const earn = document.getElementById('dash-earnings');
            const newTotal = parseFloat(earn.innerText) + totalGain;
            earn.innerText = newTotal.toFixed(2);

            if (CURRENT_DRIVER) {
                CURRENT_DRIVER.earnings = (CURRENT_DRIVER.earnings || 0) + totalGain;
                localStorage.setItem('menuia_driver', JSON.stringify(CURRENT_DRIVER));
            }
        }

        // --- HISTORY LOGIC ---
        function openHistory() {
            toggleProfileMenu(); // Close menu
            // Show Modal or separate view
            const modal = document.getElementById('history-modal'); // We need to create this
            if (modal) modal.classList.remove('hidden');
            socket.emit('get-driver-history', CURRENT_DRIVER._id);
        }

        socket.on('driver-history-data', (orders) => {
            const list = document.getElementById('history-list');
            if (!list) return;

            if (orders.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 py-4">No hay historial reciente.</p>';
                return;
            }

            list.innerHTML = orders.map(o => {
                const date = new Date(o.createdAt).toLocaleDateString();
                const earn = (o.costs?.shipping || 35) + (o.costs?.tip || 0);
                return `
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-xs text-gray-800">${o.shopName || 'Restaurante'}</p>
                            <p class="text-[10px] text-gray-500">${date} ‚Ä¢ #${o.ref}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-green-600 text-sm">+$${earn.toFixed(2)}</p>
                            <p class="text-[10px] text-gray-400">Env√≠o + Propina</p>
                        </div>
                    </div>
                `;
            }).join('');
        });

        // --- DISTANCE HELPER ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(1);
        }

        function callContact() {
            if (CURRENT_ORDER) window.open(`tel:${CURRENT_ORDER.customerPhone}`);
        }

        function togglePanelHeight() {
            // Simple interaction for expanding panel if needed
        }

        // --- PWA INSTALLATION ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Buttons are visible by default now
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                // Buttons will be hidden by appinstalled event or next reload
            } else {
                alert("Para instalar: Busca la opci√≥n 'Agregar a pantalla de inicio' en tu navegador.");
            }
        }

        function checkInstalledState() {
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                const btn = document.getElementById('pwa-install-btn');
                const dashBtn = document.getElementById('pwa-install-dash-btn');
                if (btn) btn.classList.add('hidden');
                if (dashBtn) dashBtn.classList.add('hidden');
            }
        }

        window.addEventListener('load', checkInstalledState);
        window.addEventListener('appinstalled', () => {
            const btn = document.getElementById('pwa-install-btn');
            const dashBtn = document.getElementById('pwa-install-dash-btn');
            if (btn) btn.classList.add('hidden');
            if (dashBtn) dashBtn.classList.add('hidden');
            alert("¬°App instalada correctamente!");
        });


        // VALIDATE PWA SUPPORT BEFORE REGISTERING
        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW Registered'))
                .catch(err => console.log('SW Registration Warning (Local/Insecure):', err));
        } else {
            console.log("PWA Service Worker requires HTTPS or localhost.");
        }

    </script>
</body>

</html>
